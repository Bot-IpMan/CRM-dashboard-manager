<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Домашня CRM-панель</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-soft: rgba(99, 102, 241, 0.12);
            --accent: #22d3ee;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --bg: #f4f6fb;
            --surface: rgba(255, 255, 255, 0.95);
            --border: rgba(99, 102, 241, 0.08);
            --text: #0f172a;
            --text-muted: #64748b;
            --shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
            --glass: rgba(255, 255, 255, 0.75);
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, #f9fbff 0%, #eef2ff 100%);
            color: var(--text);
            min-height: 100vh;
        }

        h1, h2, h3, h4 {
            margin: 0;
        }

        p {
            margin: 0;
        }

        .app-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: linear-gradient(200deg, #111827 0%, #1e1b4b 100%);
            color: white;
            padding: 32px 28px 40px;
            display: flex;
            flex-direction: column;
            gap: 32px;
            position: sticky;
            top: 0;
            height: 100vh;
        }

        .sidebar::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top, rgba(99, 102, 241, 0.15), transparent 60%);
            pointer-events: none;
        }

        .sidebar-inner {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            gap: 32px;
            flex: 1;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .brand-logo {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.25) 0%, rgba(34, 211, 238, 0.25) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .brand h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .brand p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .nav-controls {
            display: grid;
            gap: 16px;
        }

        .nav-search {
            position: relative;
        }

        .nav-search input {
            width: 100%;
            padding: 12px 14px 12px 42px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            background: rgba(255, 255, 255, 0.08);
            color: white;
            font-size: 14px;
            outline: none;
            transition: border 0.2s ease, background 0.2s ease;
        }

        .nav-search input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .nav-search input:focus {
            border-color: rgba(255, 255, 255, 0.45);
            background: rgba(255, 255, 255, 0.14);
        }

        .nav-search i {
            position: absolute;
            top: 50%;
            left: 16px;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.6);
            font-size: 15px;
        }

        .nav-filter {
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.45);
            color: rgba(255, 255, 255, 0.85);
            font-size: 14px;
            outline: none;
        }

        .nav-filter:focus {
            border-color: rgba(255, 255, 255, 0.45);
        }

        .nav {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .nav-empty {
            display: none;
            padding: 14px 16px;
            border-radius: var(--radius-sm);
            border: 1px dashed rgba(255, 255, 255, 0.18);
            background: rgba(15, 23, 42, 0.45);
            color: rgba(255, 255, 255, 0.75);
            font-size: 13px;
            line-height: 1.5;
        }

        .nav-empty.is-visible {
            display: block;
        }

        .nav-group {
            display: grid;
            gap: 10px;
        }

        .nav-group + .nav-group {
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            padding-top: 14px;
        }

        .nav-group-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: rgba(255, 255, 255, 0.55);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            border-radius: var(--radius-sm);
            border: 1px solid transparent;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
            font-size: 15px;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-item.is-hidden {
            display: none;
        }

        .nav-group.is-collapsed {
            display: none;
        }

        .nav-item i {
            font-size: 18px;
        }

        .nav-item.active,
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .nav-item.active {
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(18px);
        }

        .sidebar-footer {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .sidebar-stats {
            background: rgba(15, 23, 42, 0.55);
            padding: 18px;
            border-radius: var(--radius-md);
            display: grid;
            gap: 12px;
        }

        .sidebar-stats h4 {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
        }

        .sidebar-stats strong {
            font-size: 20px;
            color: white;
        }

        .btn {
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 15px;
            font-weight: 500;
            border-radius: 12px;
            padding: 12px 18px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 18px 35px rgba(99, 102, 241, 0.35);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 20px 45px rgba(99, 102, 241, 0.45);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }

        .main-content {
            padding: 36px 48px;
            position: relative;
            overflow-x: hidden;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
            margin-bottom: 32px;
        }

        .topbar h2 {
            font-size: 26px;
            font-weight: 600;
        }

        .topbar-sub {
            color: var(--text-muted);
            margin-top: 6px;
            font-size: 15px;
        }

        .topbar-actions {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .search-wrapper {
            position: relative;
        }

        .search-wrapper input {
            background: var(--surface);
            border-radius: 14px;
            border: 1px solid var(--border);
            padding: 12px 16px 12px 42px;
            width: 320px;
            box-shadow: var(--shadow);
            outline: none;
            font-size: 15px;
        }

        .search-wrapper i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-results {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            border: 1px solid rgba(99, 102, 241, 0.12);
            box-shadow: 0 25px 45px rgba(15, 23, 42, 0.12);
            padding: 16px;
            display: none;
            z-index: 20;
        }

        .search-results.active {
            display: block;
        }

        .search-group + .search-group {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed rgba(148, 163, 184, 0.3);
        }

        .search-group-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .search-result {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .search-result:hover {
            background: rgba(99, 102, 241, 0.08);
        }

        .search-empty {
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
        }

        .section {
            display: none;
            animation: fadeIn 0.2s ease;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 24px;
            margin-bottom: 24px;
        }

        .section-header h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .section-header p {
            color: var(--text-muted);
            font-size: 15px;
        }

        .section-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 20px;
            display: flex;
            gap: 16px;
            align-items: center;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .metric-icon {
            width: 54px;
            height: 54px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--primary-dark);
            background: var(--primary-soft);
        }

        .metric-label {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
        }

        .metric-sub {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .metric-progress {
            margin-left: auto;
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: conic-gradient(var(--primary) var(--angle), rgba(148, 163, 184, 0.35) 0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .process-overview {
            display: grid;
            gap: 16px;
        }

        .process-summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 16px 18px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(99, 102, 241, 0.18);
            background: rgba(99, 102, 241, 0.08);
        }

        .process-summary-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--primary-dark);
            display: inline-flex;
            align-items: baseline;
            gap: 6px;
        }

        .process-summary-value span {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .process-summary-label {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .process-summary-target {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-dark);
            background: rgba(99, 102, 241, 0.16);
            padding: 6px 10px;
            border-radius: 999px;
        }

        .process-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
        }

        .process-item {
            border-radius: var(--radius-md);
            border: 1px solid rgba(99, 102, 241, 0.12);
            background: rgba(99, 102, 241, 0.06);
            padding: 14px 16px;
            display: grid;
            gap: 10px;
        }

        .process-item-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .process-item-label {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .process-item-value {
            font-size: 24px;
            font-weight: 600;
        }

        .process-item-note {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .process-hotlist {
            margin-top: 4px;
            padding-top: 12px;
            border-top: 1px dashed rgba(99, 102, 241, 0.2);
            display: grid;
            gap: 10px;
        }

        .process-hotlist-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .process-hotlist-item {
            border-radius: var(--radius-md);
            border: 1px solid rgba(99, 102, 241, 0.12);
            background: rgba(255, 255, 255, 0.85);
            padding: 14px 16px;
            display: grid;
            gap: 8px;
        }

        .process-hotlist-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .process-hotlist-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .process-hotlist-actions {
            margin-top: 4px;
        }

        .feature-usage {
            display: grid;
            gap: 12px;
        }

        .feature-item {
            border-radius: var(--radius-md);
            border: 1px solid rgba(99, 102, 241, 0.12);
            background: rgba(99, 102, 241, 0.06);
            padding: 14px 16px;
            display: grid;
            gap: 10px;
        }

        .feature-item-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .feature-label {
            font-size: 15px;
            font-weight: 600;
        }

        .feature-meta {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .feature-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-progress .progress-track {
            flex: 1;
            height: 8px;
        }

        .feature-progress span {
            font-size: 12px;
            color: var(--text-muted);
            min-width: 48px;
            text-align: right;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1.3fr);
            gap: 20px;
        }

        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 22px 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .card h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 14px;
        }

        .card-feature-overview p {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .feature-note {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 14px;
            border-radius: var(--radius-md);
            background: rgba(14, 165, 233, 0.12);
            color: #0c4a6e;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .feature-note i {
            font-size: 16px;
            margin-top: 2px;
        }

        .feature-groups {
            display: grid;
            gap: 12px;
        }

        .feature-group {
            background: rgba(99, 102, 241, 0.06);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            border: 1px solid rgba(99, 102, 241, 0.14);
            display: grid;
            gap: 8px;
        }

        .feature-group-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text);
        }

        .feature-list {
            margin: 0;
            padding-left: 18px;
            display: grid;
            gap: 6px;
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1.5;
        }

        .stage-distribution {
            display: grid;
            gap: 14px;
        }

        .stage-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .stage-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .stage-bar {
            width: 160px;
            height: 8px;
            border-radius: 6px;
            background: rgba(148, 163, 184, 0.25);
            overflow: hidden;
        }

        .stage-bar span {
            display: block;
            height: 100%;
            border-radius: 6px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(79, 70, 229, 0.9));
        }

        .timeline {
            display: grid;
            gap: 16px;
        }

        .timeline-item {
            display: flex;
            gap: 14px;
            padding: 12px 14px;
            background: rgba(99, 102, 241, 0.06);
            border-radius: 12px;
        }

        .timeline-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-dark);
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-time {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .upcoming-list {
            display: grid;
            gap: 12px;
        }

        .upcoming-item {
            display: flex;
            gap: 14px;
            align-items: center;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .badge {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 999px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.12);
            color: #b45309;
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.12);
            color: #b91c1c;
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.12);
            color: #15803d;
        }

        .badge-primary {
            background: rgba(99, 102, 241, 0.18);
            color: var(--primary-dark);
        }

        .badge-info {
            background: rgba(14, 165, 233, 0.18);
            color: #0369a1;
        }

        .badge-neutral {
            background: rgba(148, 163, 184, 0.2);
            color: #334155;
        }

        .pipeline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
        }

        .pipeline-metrics {
            margin-bottom: 24px;
        }

        .pipeline-insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
            margin-top: 26px;
        }

        .pipeline-activity-card {
            margin-top: 20px;
        }

        .stage-status-list,
        .priority-list,
        .owner-summary {
            display: grid;
            gap: 12px;
        }

        .stage-row {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 14px 16px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(99, 102, 241, 0.12);
            background: rgba(248, 250, 255, 0.78);
        }

        .stage-info {
            display: grid;
            gap: 6px;
            flex: 1;
        }

        .stage-name {
            font-weight: 600;
            font-size: 15px;
        }

        .stage-meta {
            font-size: 13px;
            color: var(--text-muted);
        }

        .stage-risk {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: #b45309;
            background: rgba(245, 158, 11, 0.18);
            border-radius: 999px;
            padding: 4px 10px;
            width: fit-content;
        }

        .stage-risk-danger {
            color: #b91c1c;
            background: rgba(239, 68, 68, 0.16);
        }

        .stage-progress {
            display: grid;
            gap: 6px;
            min-width: 150px;
            text-align: right;
        }

        .stage-share {
            font-weight: 600;
            font-size: 14px;
        }

        .stage-progress-track {
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.12);
            overflow: hidden;
        }

        .stage-progress-value {
            display: block;
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
        }

        .stage-progress span {
            font-size: 12px;
            color: var(--text-muted);
        }

        .priority-item {
            border-radius: var(--radius-md);
            border: 1px solid rgba(99, 102, 241, 0.14);
            background: rgba(99, 102, 241, 0.06);
            padding: 16px;
            display: grid;
            gap: 10px;
        }

        .priority-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .priority-title {
            font-weight: 600;
            font-size: 15px;
        }

        .priority-meta {
            font-size: 13px;
            color: var(--text-muted);
        }

        .priority-flags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .priority-flag {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            border-radius: 999px;
            padding: 4px 10px;
        }

        .priority-flag.danger {
            background: rgba(239, 68, 68, 0.15);
            color: #b91c1c;
        }

        .priority-flag.warning {
            background: rgba(245, 158, 11, 0.18);
            color: #92400e;
        }

        .priority-flag.info {
            background: rgba(14, 165, 233, 0.18);
            color: #0c4a6e;
        }

        .owner-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(99, 102, 241, 0.12);
            background: rgba(248, 250, 255, 0.78);
            padding: 14px 16px;
        }

        .owner-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .owner-metrics {
            display: grid;
            gap: 6px;
            min-width: 160px;
            text-align: right;
        }

        .owner-progress-track {
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.12);
            overflow: hidden;
        }

        .owner-progress-value {
            display: block;
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
        }

        .owner-metrics .metric-sub {
            margin-top: 0;
        }

        .priority-actions {
            display: flex;
            justify-content: flex-end;
        }

        .priority-actions .btn-small-primary {
            white-space: nowrap;
        }

        .pipeline-metrics .metric-card {
            background: rgba(255, 255, 255, 0.95);
        }

        .pipeline-metrics .metric-icon {
            background: rgba(99, 102, 241, 0.12);
        }

        .pipeline-column {
            background: rgba(255, 255, 255, 0.92);
            border-radius: var(--radius-md);
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            min-height: 360px;
        }

        .column-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .column-head h4 {
            font-size: 16px;
            font-weight: 600;
        }

        .column-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .column-body {
            display: grid;
            gap: 12px;
            flex: 1;
        }

        .column-body.drop-active {
            outline: 2px dashed rgba(99, 102, 241, 0.5);
            outline-offset: -10px;
            background: rgba(99, 102, 241, 0.05);
        }

        .deal-card {
            background: rgba(248, 250, 255, 0.85);
            border-radius: 18px;
            padding: 16px;
            display: grid;
            gap: 10px;
            border: 1px solid rgba(99, 102, 241, 0.14);
            cursor: grab;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .deal-card:active {
            cursor: grabbing;
        }

        .deal-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 30px rgba(99, 102, 241, 0.18);
        }

        .deal-card-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .deal-stage {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary-dark);
        }

        .deal-title {
            font-weight: 600;
            font-size: 16px;
        }

        .deal-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .deal-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: rgba(15, 23, 42, 0.08);
            color: var(--text);
        }

        .deal-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(34, 211, 238, 0.3));
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .empty-state {
            padding: 18px;
            border: 1px dashed rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
        }

        .contacts-table {
            display: grid;
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .table-head,
        .table-row {
            display: grid;
            grid-template-columns: 2.2fr 1.4fr 1.4fr 1.2fr 1fr 1fr;
            padding: 16px 22px;
            align-items: center;
            gap: 12px;
        }

        .table-head {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            background: rgba(99, 102, 241, 0.06);
            border-top-left-radius: var(--radius-lg);
            border-top-right-radius: var(--radius-lg);
        }

        .table-row {
            border-top: 1px solid rgba(148, 163, 184, 0.18);
            transition: background 0.2s ease;
        }

        .table-row:hover {
            background: rgba(99, 102, 241, 0.08);
        }

        .projects-table {
            display: grid;
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .projects-table .table-head,
        .projects-table .table-row {
            grid-template-columns: 2.4fr 1.6fr 1.1fr 1fr 1fr 1.4fr;
        }

        .project-main {
            display: grid;
            gap: 6px;
        }

        .project-main strong {
            font-size: 15px;
        }

        .project-sub {
            font-size: 13px;
            color: var(--text-muted);
        }

        .project-updated {
            font-size: 12px;
            color: var(--text-muted);
        }

        .project-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .project-tags .tag {
            background: rgba(99, 102, 241, 0.12);
            color: var(--primary-dark);
        }

        .project-team {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .project-member-chip {
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.12);
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .project-owner {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .project-owner strong {
            display: block;
        }

        .project-owner span {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
        }

        .avatar-sm {
            width: 30px;
            height: 30px;
            font-size: 14px;
        }

        .probability-pill {
            position: relative;
            border-radius: 999px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 12px;
            font-weight: 600;
            font-size: 13px;
            color: var(--primary-dark);
            background: rgba(99, 102, 241, 0.12);
            overflow: hidden;
        }

        .probability-pill::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(79, 70, 229, 0.45));
            width: var(--fill, 0%);
            border-radius: inherit;
            transform-origin: left center;
        }

        .probability-pill span {
            position: relative;
            z-index: 1;
        }

        .probability-pill.is-low {
            color: #b45309;
            background: rgba(245, 158, 11, 0.16);
        }

        .probability-pill.is-low::before {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.26), rgba(217, 119, 6, 0.45));
        }

        .probability-pill.is-high {
            color: #166534;
            background: rgba(34, 197, 94, 0.18);
        }

        .probability-pill.is-high::before {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(22, 163, 74, 0.5));
        }

        .probability-filter {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 14px;
            box-shadow: var(--shadow);
        }

        .probability-filter input[type="range"] {
            width: 120px;
            accent-color: var(--primary);
        }

        .probability-value-badge {
            font-weight: 600;
            font-size: 13px;
            color: var(--primary-dark);
        }

        .project-insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
            margin-bottom: 24px;
        }

        .project-stage-list,
        .project-risk-list,
        .project-team-load,
        .project-updates-list {
            display: grid;
            gap: 12px;
        }

        .project-stage-row,
        .project-team-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 14px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(99, 102, 241, 0.12);
            background: rgba(248, 250, 255, 0.78);
        }

        .project-stage-row {
            justify-content: space-between;
        }

        .project-stage-info,
        .project-team-info {
            display: grid;
            gap: 4px;
            flex: 1;
        }

        .project-stage-progress,
        .project-team-progress {
            display: grid;
            gap: 6px;
            min-width: 160px;
        }

        .project-stage-progress {
            grid-template-columns: 1fr auto;
            align-items: center;
        }

        .project-stage-track,
        .project-team-progress-track {
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.12);
            overflow: hidden;
        }

        .project-stage-fill,
        .project-team-progress-fill {
            display: block;
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
        }

        .project-stage-chip {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-dark);
            background: rgba(99, 102, 241, 0.18);
            padding: 6px 10px;
            border-radius: 999px;
        }

        .project-risk-item {
            border-radius: var(--radius-md);
            border: 1px solid rgba(99, 102, 241, 0.12);
            background: rgba(248, 250, 255, 0.78);
            padding: 14px 16px;
            display: grid;
            gap: 10px;
        }

        .project-risk-item.warning {
            border-color: rgba(245, 158, 11, 0.32);
            background: rgba(254, 243, 199, 0.55);
        }

        .project-risk-item.critical {
            border-color: rgba(239, 68, 68, 0.35);
            background: rgba(254, 226, 226, 0.6);
        }

        .project-risk-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .project-risk-flags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .project-risk-flag {
            font-size: 12px;
            font-weight: 600;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.12);
            color: var(--primary-dark);
        }

        .project-risk-flag.is-warning {
            background: rgba(245, 158, 11, 0.18);
            color: #92400e;
        }

        .project-risk-flag.is-critical {
            background: rgba(239, 68, 68, 0.18);
            color: #b91c1c;
        }

        .project-risk-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .project-risk-meta i {
            margin-right: 6px;
            color: rgba(239, 68, 68, 0.7);
        }

        .project-risk-score {
            font-weight: 600;
            font-size: 13px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(239, 68, 68, 0.16);
            color: #b91c1c;
        }

        .project-risk-item.warning .project-risk-score {
            background: rgba(245, 158, 11, 0.16);
            color: #b45309;
        }

        .project-team-row .metric-sub {
            margin-top: 0;
        }

        .project-updates-card {
            margin-bottom: 24px;
        }

        .project-updates-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 16px;
        }

        .project-updates-header .metric-sub {
            margin-top: 4px;
        }

        .project-updates-counter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.12);
            color: var(--primary-dark);
        }

        .project-update-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px;
            padding: 12px 14px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(99, 102, 241, 0.12);
            background: rgba(248, 250, 255, 0.9);
        }

        .project-update-bullet {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-top: 6px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
        }

        .project-update-body {
            display: grid;
            gap: 6px;
        }

        .project-update-body p {
            margin: 0;
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .project-update-footer {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .project-update-footer i {
            margin-right: 6px;
            color: var(--primary);
        }

        .input-hint {
            font-size: 12px;
            color: var(--text-muted);
        }

        .contact-main {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .contact-info {
            display: grid;
            gap: 4px;
        }

        .contact-sub {
            font-size: 13px;
            color: var(--text-muted);
        }

        .status-badge {
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.15);
            color: #15803d;
        }

        .status-potential {
            background: rgba(14, 165, 233, 0.15);
            color: #0c4a6e;
        }

        .status-partner {
            background: rgba(249, 115, 22, 0.15);
            color: #9a3412;
        }

        .status-cold {
            background: rgba(148, 163, 184, 0.22);
            color: #475569;
        }

        .task-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
        }

        .task-column {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius-md);
            padding: 18px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            display: grid;
            gap: 12px;
        }

        .task-column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .task-column-header h4 {
            font-size: 16px;
            font-weight: 600;
        }

        .task-column-header span {
            font-size: 13px;
            color: var(--text-muted);
        }

        .task-items {
            display: grid;
            gap: 12px;
        }

        .task-card {
            background: rgba(99, 102, 241, 0.06);
            border-radius: 16px;
            padding: 14px 16px;
            display: grid;
            gap: 10px;
            border: 1px solid rgba(99, 102, 241, 0.12);
        }

        .task-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .task-title {
            font-weight: 600;
            font-size: 15px;
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .task-actions {
            display: flex;
            gap: 10px;
        }

        .task-actions button {
            border: none;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .btn-small-primary {
            background: rgba(79, 70, 229, 0.16);
            color: var(--primary-dark);
        }

        .btn-small-primary:hover {
            background: rgba(79, 70, 229, 0.24);
        }

        .btn-small-muted {
            background: rgba(148, 163, 184, 0.16);
            color: #1f2937;
        }

        .btn-small-muted:hover {
            background: rgba(148, 163, 184, 0.24);
        }

        .priority {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 999px;
        }

        .priority-high {
            background: rgba(239, 68, 68, 0.18);
            color: #b91c1c;
        }

        .priority-medium {
            background: rgba(245, 158, 11, 0.18);
            color: #b45309;
        }

        .priority-low {
            background: rgba(34, 197, 94, 0.18);
            color: #15803d;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 18px;
        }

        .progress-list {
            display: grid;
            gap: 14px;
        }

        .progress-item {
            display: grid;
            gap: 6px;
        }

        .progress-track {
            width: 100%;
            height: 10px;
            border-radius: 8px;
            background: rgba(148, 163, 184, 0.2);
            overflow: hidden;
        }

        .progress-value {
            height: 100%;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.85), rgba(79, 70, 229, 0.95));
        }

        .lead-focus-list {
            display: grid;
            gap: 12px;
        }

        .lead-focus-item {
            padding: 14px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(99, 102, 241, 0.14);
            display: grid;
            gap: 6px;
        }

        .focus-meta {
            font-size: 13px;
            color: var(--text-muted);
        }

        .file-manager {
            display: grid;
            gap: 18px;
        }

        .file-sources {
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 20px;
            display: grid;
            gap: 16px;
        }

        .file-sources-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .file-sources-header h3 {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .file-sources-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
        }

        .file-source-card {
            border: 1px solid rgba(99, 102, 241, 0.12);
            border-radius: var(--radius-md);
            background: rgba(99, 102, 241, 0.04);
            padding: 16px;
            display: grid;
            gap: 12px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .file-source-card:hover {
            border-color: rgba(99, 102, 241, 0.3);
            background: rgba(99, 102, 241, 0.08);
        }

        .file-source-card.active {
            border-color: rgba(99, 102, 241, 0.45);
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.18);
            background: rgba(99, 102, 241, 0.1);
        }

        .file-source-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-source-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(79, 70, 229, 0.12);
            color: var(--primary-dark);
            font-size: 18px;
        }

        .file-source-title strong {
            display: block;
            font-size: 15px;
        }

        .file-source-status {
            margin-left: auto;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 999px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .file-source-status.status-online {
            background: rgba(34, 197, 94, 0.16);
            color: #15803d;
        }

        .file-source-status.status-offline {
            background: rgba(148, 163, 184, 0.18);
            color: #475569;
        }

        .file-source-status.status-syncing {
            background: rgba(14, 165, 233, 0.16);
            color: #0e7490;
        }

        .file-source-body {
            display: grid;
            gap: 10px;
        }

        .file-source-path {
            font-size: 13px;
            color: var(--text-muted);
        }

        .file-source-stats {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .file-source-stats strong {
            display: block;
            font-size: 16px;
            color: var(--text);
        }

        .file-source-updated {
            font-size: 12px;
            color: var(--text-muted);
        }

        .file-source-footer {
            display: flex;
            justify-content: flex-end;
        }

        .file-actions {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }

        .file-actions select {
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--surface);
            padding: 10px 14px;
            font-size: 14px;
            box-shadow: var(--shadow);
        }

        .file-actions select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .file-search {
            position: relative;
        }

        .file-search input {
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 10px 14px 10px 40px;
            font-size: 14px;
            background: var(--surface);
            box-shadow: var(--shadow);
            min-width: 240px;
        }

        .file-search i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .file-status {
            font-size: 13px;
            color: var(--text-muted);
        }

        .file-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .file-summary-card {
            background: rgba(99, 102, 241, 0.08);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            display: grid;
            gap: 6px;
            min-width: 180px;
        }

        .file-summary-card strong {
            font-size: 16px;
        }

        .file-summary-card span {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
        }

        .file-summary-card small {
            font-size: 12px;
            color: var(--text-muted);
        }

        .file-monitor-guide {
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 20px;
            display: grid;
            gap: 16px;
        }

        .file-monitor-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .file-monitor-header h3 {
            font-size: 16px;
            margin: 0 0 6px;
        }

        .file-monitor-header p {
            margin: 0;
            font-size: 14px;
            color: var(--text-muted);
        }

        .file-monitor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
        }

        .file-monitor-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: rgba(99, 102, 241, 0.08);
            border-radius: var(--radius-md);
            padding: 12px 14px;
        }

        .file-monitor-item i {
            color: var(--primary-dark);
            font-size: 18px;
            margin-top: 2px;
        }

        .file-monitor-item strong {
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .file-monitor-item p {
            margin: 0;
            font-size: 13px;
            color: var(--text-muted);
        }

        .file-monitor-guide code {
            background: rgba(99, 102, 241, 0.12);
            border-radius: 6px;
            padding: 2px 6px;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 12px;
        }

        .file-monitor-list {
            margin: 0;
            padding-left: 20px;
            display: grid;
            gap: 8px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .file-monitor-list li {
            line-height: 1.5;
        }

        .file-monitor-list strong {
            color: var(--text);
        }

        .file-monitor-note {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: rgba(34, 197, 94, 0.12);
            border-radius: var(--radius-md);
            padding: 12px 14px;
        }

        .file-monitor-note i {
            color: var(--success);
            font-size: 18px;
            margin-top: 2px;
        }

        .file-monitor-note p {
            margin: 0;
            font-size: 13px;
            color: var(--text-muted);
        }

        .file-monitor-footer {
            display: flex;
            justify-content: flex-start;
        }

        .file-monitor-footer a {
            color: var(--primary-dark);
            font-weight: 600;
            text-decoration: none;
        }

        .file-monitor-footer a:hover {
            text-decoration: underline;
        }

        .file-tree {
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .file-tree-head,
        .file-entry {
            display: grid;
            grid-template-columns: minmax(0, 2.5fr) minmax(0, 1fr) minmax(0, 1.1fr);
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
        }

        .file-tree-head div:nth-child(2),
        .file-tree-head div:nth-child(3),
        .file-entry div:nth-child(2),
        .file-entry div:nth-child(3) {
            text-align: right;
        }

        .file-tree-head {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            background: rgba(99, 102, 241, 0.06);
        }

        .file-tree-body {
            max-height: 460px;
            overflow-y: auto;
        }

        .file-entry {
            border-top: 1px solid rgba(148, 163, 184, 0.18);
            font-size: 14px;
        }

        .file-entry:hover {
            background: rgba(99, 102, 241, 0.08);
        }

        .file-name {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-left: calc(var(--level, 0) * 20px);
            word-break: break-word;
        }

        .file-name i {
            width: 20px;
            text-align: center;
            color: var(--primary-dark);
        }

        .file-name[data-type="directory"] i {
            color: #f59e0b;
        }

        .file-entry .file-meta {
            font-size: 13px;
            color: var(--text-muted);
        }

        .file-entry mark {
            background: rgba(99, 102, 241, 0.18);
            color: inherit;
            padding: 0 2px;
            border-radius: 4px;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 50;
            backdrop-filter: blur(12px);
        }

        .modal.active {
            display: flex;
        }

        .modal-dialog {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 28px;
            width: min(680px, 90vw);
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(99, 102, 241, 0.15);
            box-shadow: 0 30px 60px rgba(15, 23, 42, 0.18);
        }

        .modal-dialog.wide {
            width: min(860px, 92vw);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            border: none;
            background: rgba(15, 23, 42, 0.08);
            cursor: pointer;
            font-size: 18px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px 18px;
        }

        .form-group {
            display: grid;
            gap: 8px;
        }

        .form-group.full {
            grid-column: 1 / -1;
        }

        label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        input, select, textarea {
            width: 100%;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            padding: 12px 14px;
            font-size: 15px;
            font-family: inherit;
            background: rgba(248, 250, 255, 0.9);
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.6);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 110px;
        }

        .file-dropzone {
            border: 1px dashed rgba(99, 102, 241, 0.35);
            border-radius: 16px;
            background: rgba(99, 102, 241, 0.05);
            padding: 20px;
            display: grid;
            gap: 12px;
            justify-items: center;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .file-input-hidden {
            display: none;
        }

        .file-dropzone:hover,
        .file-dropzone.has-files {
            border-color: rgba(79, 70, 229, 0.55);
            background: rgba(99, 102, 241, 0.09);
        }

        .file-dropzone:focus-visible {
            outline: 3px solid rgba(99, 102, 241, 0.35);
            outline-offset: 3px;
        }

        .file-dropzone.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.14);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
        }

        .file-dropzone-content {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .file-dropzone-text {
            display: grid;
            gap: 6px;
            text-align: left;
        }

        .file-dropzone-actions {
            font-size: 13px;
            color: var(--text-muted);
        }

        .file-dropzone-actions .file-browse-btn {
            margin: 0 6px;
        }

        .file-dropzone i {
            font-size: 24px;
            color: var(--primary-dark);
        }

        .file-dropzone strong {
            display: block;
            font-size: 15px;
            margin-bottom: 6px;
        }

        .file-browse-btn {
            border: none;
            background: rgba(79, 70, 229, 0.16);
            color: var(--primary-dark);
            padding: 6px 14px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            display: inline-flex;
            align-items: center;
            pointer-events: auto;
        }

        .file-browse-btn:hover,
        .file-browse-btn:focus {
            background: rgba(79, 70, 229, 0.26);
            outline: none;
        }

        .upload-hint {
            font-size: 12px;
            color: var(--text-muted);
        }

        .file-list {
            display: grid;
            gap: 10px;
            margin-top: 12px;
        }

        .file-item {
            display: grid;
            grid-template-columns: minmax(0, 1fr) auto;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.12);
        }

        .file-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-dark);
            box-shadow: 0 8px 16px rgba(79, 70, 229, 0.18);
        }

        .file-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .file-progress {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-progress-track {
            flex: 1;
            height: 6px;
            border-radius: 999px;
            background: rgba(79, 70, 229, 0.16);
            overflow: hidden;
        }

        .file-progress-value {
            height: 100%;
            width: 0%;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.85), rgba(129, 140, 248, 0.95));
            transition: width 0.2s ease;
        }

        .file-progress-label {
            font-size: 12px;
            color: var(--text-muted);
            min-width: 38px;
            text-align: right;
        }

        .upload-progress {
            display: none;
            align-items: center;
            gap: 12px;
            justify-content: space-between;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(99, 102, 241, 0.16);
            background: rgba(99, 102, 241, 0.08);
            font-size: 12px;
            color: var(--text-muted);
        }

        .upload-progress.active {
            display: flex;
        }

        .upload-progress strong {
            color: var(--primary-dark);
        }

        .upload-progress-track {
            flex: 1;
            height: 6px;
            border-radius: 999px;
            background: rgba(79, 70, 229, 0.16);
            overflow: hidden;
        }

        .upload-progress-value {
            height: 100%;
            width: 0%;
            background: linear-gradient(135deg, rgba(129, 140, 248, 0.95), rgba(56, 189, 248, 0.9));
            transition: width 0.2s ease;
        }

        .file-remove {
            border: none;
            background: rgba(15, 23, 42, 0.12);
            color: var(--text);
            width: 30px;
            height: 30px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .file-remove:hover,
        .file-remove:focus {
            background: rgba(15, 23, 42, 0.18);
            outline: none;
        }

        .file-empty {
            font-size: 13px;
            color: var(--text-muted);
            padding: 8px 0;
        }

        .modal-actions {
            margin-top: 24px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .lead-details {
            display: grid;
            gap: 18px;
        }

        .lead-highlights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
        }

        .highlight-card {
            background: rgba(99, 102, 241, 0.06);
            border-radius: 16px;
            padding: 14px 16px;
            display: grid;
            gap: 6px;
            border: 1px solid rgba(99, 102, 241, 0.12);
        }

        .highlight-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
        }

        .highlight-value {
            font-size: 18px;
            font-weight: 600;
        }

        .lead-columns {
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
            gap: 18px;
        }

        .info-grid {
            display: grid;
            gap: 12px;
        }

        .info-item {
            display: grid;
            gap: 4px;
        }

        .info-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
        }

        .info-value {
            font-size: 15px;
            font-weight: 500;
        }

        .attachment-list {
            display: grid;
            gap: 10px;
            margin-top: 6px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(248, 250, 255, 0.9);
            border: 1px solid rgba(99, 102, 241, 0.14);
            text-decoration: none;
            color: inherit;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .attachment-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.18);
            background: rgba(255, 255, 255, 0.98);
        }

        .attachment-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.12);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-dark);
        }

        .attachment-details {
            display: grid;
            gap: 4px;
        }

        .attachment-details strong {
            font-size: 14px;
            font-weight: 600;
        }

        .attachment-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .attachment-item i.fa-download {
            margin-left: auto;
            color: var(--primary-dark);
        }

        .notes-list {
            display: grid;
            gap: 12px;
            margin-top: 12px;
        }

        .note-item {
            padding: 12px 14px;
            background: rgba(148, 163, 184, 0.12);
            border-radius: 12px;
            display: grid;
            gap: 6px;
        }

        .note-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .timeline-list {
            display: grid;
            gap: 10px;
        }

        .timeline-entry {
            border-left: 2px solid rgba(99, 102, 241, 0.3);
            padding-left: 12px;
            margin-left: 6px;
        }

        .timeline-entry strong {
            display: block;
            font-weight: 600;
        }

        .timeline-entry span {
            color: var(--text-muted);
            font-size: 12px;
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
        }

        .chip {
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.12);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .role-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
        }

        .role-definition-grid {
            display: grid;
            gap: 12px;
        }

        .role-card {
            border: 1px solid rgba(99, 102, 241, 0.18);
            border-radius: var(--radius-md);
            background: rgba(99, 102, 241, 0.06);
            padding: 16px 18px;
            display: grid;
            gap: 10px;
        }

        .role-card h4 {
            font-size: 15px;
            margin: 0;
        }

        .role-card p {
            margin: 0;
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .role-permissions {
            display: grid;
            gap: 6px;
            margin: 0;
            padding-left: 18px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(79, 70, 229, 0.18);
            color: var(--primary-dark);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .role-warning {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 14px;
            border-radius: var(--radius-md);
            background: rgba(239, 68, 68, 0.14);
            color: #991b1b;
            font-size: 13px;
            line-height: 1.5;
        }

        .role-table {
            display: grid;
            gap: 10px;
        }

        .role-row {
            display: grid;
            grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr) minmax(0, 1.6fr);
            gap: 12px;
            padding: 12px 14px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(148, 163, 184, 0.3);
            align-items: center;
        }

        .role-member {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .role-member-details strong {
            display: block;
        }

        .role-member-details .role-meta {
            display: block;
            margin-top: 2px;
        }

        .role-row.role-head {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.2);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
        }

        .role-row select {
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            padding: 8px 10px;
            font-size: 14px;
            background: rgba(248, 250, 255, 0.9);
        }

        .role-row select:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.6);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
        }

        .role-permission-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .role-permission-tag {
            background: rgba(15, 23, 42, 0.08);
            color: var(--text);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }

        .role-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .role-summary {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .role-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }

        .role-form .form-group {
            margin: 0;
        }

        .role-form textarea {
            min-height: 90px;
        }

        .probability-control {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }

        .probability-value {
            font-weight: 600;
            color: var(--primary-dark);
            min-width: 56px;
        }

        .probability-control input[type="range"] {
            flex: 1;
            accent-color: var(--primary);
        }

        .divider {
            height: 1px;
            background: rgba(148, 163, 184, 0.25);
            margin: 14px 0;
        }

        .table-row.row-highlight {
            animation: projectRowHighlight 1.6s ease;
        }

        @keyframes projectRowHighlight {
            0% {
                background: rgba(99, 102, 241, 0.18);
            }
            100% {
                background: transparent;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 1200px) {
            .app-layout {
                grid-template-columns: 240px 1fr;
            }

            .main-content {
                padding: 32px;
            }

            .table-head,
            .table-row {
                grid-template-columns: 2fr 1.4fr 1.4fr 1fr 1fr;
            }

            .table-row .contact-sub {
                display: none;
            }

            .file-tree-head,
            .file-entry {
                grid-template-columns: minmax(0, 2.2fr) minmax(0, 0.9fr) minmax(0, 1fr);
            }
        }

        @media (max-width: 980px) {
            .app-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: sticky;
                top: 0;
                height: auto;
                border-bottom-left-radius: var(--radius-lg);
                border-bottom-right-radius: var(--radius-lg);
            }

            .main-content {
                padding: 28px;
            }

            .topbar {
                flex-direction: column;
                align-items: flex-start;
            }

            .topbar-actions {
                width: 100%;
                flex-wrap: wrap;
            }

            .search-wrapper input {
                width: 100%;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .pipeline {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }

            .pipeline-insights-grid {
                grid-template-columns: 1fr;
            }

            .stage-row {
                flex-direction: column;
                align-items: stretch;
            }

            .stage-progress {
                text-align: left;
                min-width: 0;
            }

            .lead-columns {
                grid-template-columns: 1fr;
            }

            .table-head,
            .table-row {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 10px;
            }

            .table-head div:nth-child(n+3),
            .table-row div:nth-child(n+3) {
                display: none;
            }

            .file-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .file-search input {
                width: 100%;
                min-width: 0;
            }

            .file-sources {
                padding: 18px;
            }

            .file-sources-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 640px) {
            .main-content {
                padding: 24px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .priority-item {
                padding: 14px;
            }

            .owner-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .owner-metrics {
                text-align: left;
                width: 100%;
            }

            .task-board {
                grid-template-columns: 1fr;
            }

            .search-results {
                right: auto;
                width: calc(100vw - 64px);
            }

            .file-tree-head,
            .file-entry {
                grid-template-columns: minmax(0, 2fr) minmax(0, 0.8fr) minmax(0, 0.9fr);
            }

            .file-summary {
                flex-direction: column;
            }

            .file-sources-grid {
                grid-template-columns: 1fr;
            }

            .file-source-stats {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .process-summary {
                flex-direction: column;
                align-items: flex-start;
            }

            .process-summary-target {
                align-self: flex-start;
            }

            .feature-progress span {
                min-width: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-inner">
                <div class="brand">
                    <div class="brand-logo">
                        <i class="fa-solid fa-sparkles"></i>
                    </div>
                    <div>
                        <h1>HomeFlow CRM</h1>
                        <p>Ваш персональний центр керування</p>
                    </div>
                </div>

                <div class="nav-controls">
                    <div class="nav-search">
                        <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                        <input type="search" id="navSearch" placeholder="Шукати модуль..." aria-label="Пошук по меню">
                    </div>
                    <select id="navFilter" class="nav-filter" aria-label="Фільтр модулів">
                        <option value="all">Усі модулі</option>
                        <option value="sales">Продажі</option>
                        <option value="operations">Операційні</option>
                        <option value="analytics">Аналітика</option>
                        <option value="admin">Адміністрування</option>
                    </select>
                </div>

                <nav class="nav" id="mainNav">
                    <div class="nav-group" data-group="core">
                        <div class="nav-group-label">Головне</div>
                        <button class="nav-item active" data-section-target="dashboardSection" data-nav-category="sales analytics" data-nav-keywords="дашборд показники аналітика огляд">
                            <i class="fa-solid fa-chart-line" aria-hidden="true"></i>
                            Дашборд
                        </button>
                        <button class="nav-item" data-section-target="pipelineSection" data-nav-category="sales" data-nav-keywords="воронка продажів ліди процес">
                            <i class="fa-solid fa-diagram-project" aria-hidden="true"></i>
                            Воронка продажів
                        </button>
                        <button class="nav-item" data-section-target="projectsSection" data-nav-category="sales operations" data-nav-keywords="проекти угоди бюджет">
                            <i class="fa-solid fa-briefcase" aria-hidden="true"></i>
                            Проекти
                        </button>
                    </div>

                    <div class="nav-group" data-group="clients">
                        <div class="nav-group-label">Клієнти та робота</div>
                        <button class="nav-item" data-section-target="contactsSection" data-nav-category="sales" data-nav-keywords="контакти клієнти партнери база">
                            <i class="fa-solid fa-user-group" aria-hidden="true"></i>
                            Контакти
                        </button>
                        <button class="nav-item" data-section-target="tasksSection" data-nav-category="operations sales" data-nav-keywords="завдання планер дії">
                            <i class="fa-solid fa-square-check" aria-hidden="true"></i>
                            Завдання
                        </button>
                    </div>

                    <div class="nav-group" data-group="operations">
                        <div class="nav-group-label">Операційні</div>
                        <button class="nav-item" data-section-target="filesSection" data-nav-category="operations" data-nav-keywords="файли документи сховище drag">
                            <i class="fa-solid fa-folder-tree" aria-hidden="true"></i>
                            Файли
                        </button>
                    </div>

                    <div class="nav-group" data-group="analytics">
                        <div class="nav-group-label">Аналітика</div>
                        <button class="nav-item" data-section-target="analyticsSection" data-nav-category="analytics" data-nav-keywords="інсайти звіти конверсія">
                            <i class="fa-solid fa-magnifying-glass-chart" aria-hidden="true"></i>
                            Інсайти
                        </button>
                    </div>

                    <div class="nav-group" data-group="admin">
                        <div class="nav-group-label">Адміністрування</div>
                        <button class="nav-item" data-section-target="rolesSection" data-nav-category="admin" data-nav-keywords="ролі права доступ команда">
                            <i class="fa-solid fa-user-shield" aria-hidden="true"></i>
                            Ролі та доступи
                        </button>
                    </div>
                </nav>

                <div class="sidebar-footer">
                    <div class="sidebar-stats">
                        <div>
                            <h4>Активні угоди</h4>
                            <strong id="sidebarDeals">0</strong>
                        </div>
                        <div>
                            <h4>Воронка</h4>
                            <strong id="sidebarPipeline">0 ₴</strong>
                        </div>
                    </div>
                    <button class="btn btn-outline" id="resetDataBtn">
                        <i class="fa-solid fa-rotate"></i>
                        Скинути демо-дані
                    </button>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <div>
                    <h2>Вітаю у вашій сучасній CRM</h2>
                    <p class="topbar-sub">Контролюйте угоди, контакти й задачі з одного місця</p>
                </div>
                <div class="topbar-actions">
                    <div class="search-wrapper" id="globalSearchWrapper">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" id="globalSearch" placeholder="Пошук угод, контактів, задач...">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                    <button class="btn btn-primary" id="openLeadModalBtn">
                        <i class="fa-solid fa-plus"></i>
                        Новий лід
                    </button>
                </div>
            </header>

            <section id="dashboardSection" class="section active">
                <div class="section-header">
                    <div>
                        <h2>Огляд показників</h2>
                        <p>Ключові метрики вашої системи продажів у реальному часі</p>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-small-muted" id="refreshDashboardBtn">
                            <i class="fa-solid fa-arrows-rotate"></i>
                            Оновити
                        </button>
                    </div>
                </div>

                <div class="metrics-grid" id="metricCards"></div>

                <div class="dashboard-grid">
                    <div class="card">
                        <h3>Розподіл воронки</h3>
                        <div class="stage-distribution" id="stageDistribution"></div>
                    </div>
                    <div class="card">
                        <h3>Майбутні активності</h3>
                        <div class="upcoming-list" id="upcomingActivities"></div>
                    </div>
                    <div class="card">
                        <h3>Останні оновлення</h3>
                        <div class="timeline" id="activityTimeline"></div>
                    </div>
                    <div class="card">
                        <h3>Прогноз доходу</h3>
                        <div id="forecastCard"></div>
                    </div>
                    <div class="card">
                        <h3>Контроль процесів</h3>
                        <div class="process-overview" id="processOverview"></div>
                    </div>
                    <div class="card">
                        <h3>Залученість функціоналу</h3>
                        <div class="feature-usage" id="featureUsage"></div>
                    </div>
                    <div class="card card-feature-overview">
                        <h3>Основні блоки майбутньої CRM</h3>
                        <p>Облік контактів та лідів — серце системи. Базові модулі поєднують клієнтську базу, календар та нагадування з таск-менеджером і конструктором звітів, а також інтерактивною панеллю моніторингу.</p>
                        <div class="feature-note">
                            <i class="fa-solid fa-user-shield" aria-hidden="true"></i>
                            <span>Розподіл ролей гарантує, що кожен користувач бачить лише власні завдання та контрагентів, зберігаючи фокус команди та безпеку даних.</span>
                        </div>
                        <div class="feature-groups">
                            <div class="feature-group">
                                <div class="feature-group-title">Базова функціональність</div>
                                <ul class="feature-list">
                                    <li>Contact management — структурований каталог клієнтів, партнерів та лідів.</li>
                                    <li>Reminders — персональні нагадування для запланованих активностей.</li>
                                    <li>Calendar — синхронізований календар зустрічей та ключових подій.</li>
                                    <li>Task manager — таск-менеджер для відстеження прогресу по кожній можливості.</li>
                                    <li>Report generator — генератор звітів із потрібними аналітичними зрізами.</li>
                                    <li>Dashboard — дашборд для моментального огляду статусу продажів.</li>
                                </ul>
                            </div>
                            <div class="feature-group">
                                <div class="feature-group-title">Основна функціональність</div>
                                <ul class="feature-list">
                                    <li>Система обміну файлами для безпечної співпраці над документами.</li>
                                    <li>Відстеження процесів, що показує вузькі місця у воронці та проектних потоках.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="pipelineSection" class="section">
                <div class="section-header">
                    <div>
                        <h2>Воронка продажів</h2>
                        <p>Відстежуйте стан кожної можливості та працюйте з ними інтерактивно</p>
                    </div>
                    <div class="section-actions">
                        <select id="pipelineOwnerFilter">
                            <option value="all">Всі менеджери</option>
                        </select>
                        <button class="btn btn-primary" id="addPipelineLeadBtn">
                            <i class="fa-solid fa-plus"></i>
                            Додати угоду
                        </button>
                    </div>
                </div>
                <div class="metrics-grid pipeline-metrics" id="pipelineMetrics"></div>
                <div class="pipeline" id="pipelineBoard"></div>
                <div class="pipeline-insights-grid">
                    <div class="card">
                        <h3>Статус етапів</h3>
                        <div class="stage-status-list" id="pipelineStageStatus"></div>
                    </div>
                    <div class="card">
                        <h3>Фокус уваги</h3>
                        <div class="priority-list" id="pipelinePriorityList"></div>
                    </div>
                    <div class="card">
                        <h3>Командне навантаження</h3>
                        <div class="owner-summary" id="pipelineOwnerSummary"></div>
                    </div>
                </div>
                <div class="card pipeline-activity-card">
                    <h3>Активність по воронці</h3>
                    <div class="timeline-list" id="pipelineActivityTimeline"></div>
                </div>
            </section>

            <section id="projectsSection" class="section">
                <div class="section-header">
                    <div>
                        <h2>Портфель проектів</h2>
                        <p>Контролюйте статус угод, команду та ймовірність успіху</p>
                    </div>
                    <div class="section-actions">
                        <input type="text" id="projectSearch" placeholder="Пошук проектів...">
                        <select id="projectStageFilter">
                            <option value="all">Всі етапи</option>
                        </select>
                        <div class="probability-filter">
                            <label for="projectProbabilityRange">Ймовірність</label>
                            <input type="range" id="projectProbabilityRange" min="0" max="100" step="5" value="0">
                            <span class="probability-value-badge" id="projectProbabilityValue">0%+</span>
                        </div>
                        <button class="btn btn-primary" id="openProjectModalBtn">
                            <i class="fa-solid fa-plus"></i>
                            Новий проект
                        </button>
                    </div>
                </div>
                <div class="metrics-grid" id="projectMetrics"></div>
                <div class="project-insights-grid">
                    <div class="card">
                        <h3>Картина за етапами</h3>
                        <div class="project-stage-list" id="projectStageBreakdown"></div>
                    </div>
                    <div class="card">
                        <h3>Фокус ризиків</h3>
                        <div class="project-risk-list" id="projectRiskList"></div>
                    </div>
                    <div class="card">
                        <h3>Навантаження команди</h3>
                        <div class="project-team-load" id="projectTeamLoad"></div>
                    </div>
                </div>
                <div class="card project-updates-card">
                    <div class="project-updates-header">
                        <div>
                            <h3>Останні оновлення</h3>
                            <p class="metric-sub">Слідкуйте за нотатками та активністю, щоб не втратити контекст</p>
                        </div>
                        <span class="project-updates-counter" id="projectUpdatesCount">0 записів</span>
                    </div>
                    <div class="project-updates-list" id="projectUpdates"></div>
                </div>
                <div class="projects-table">
                    <div class="table-head">
                        <div>Проект</div>
                        <div>Команда</div>
                        <div>Бюджет</div>
                        <div>Етап</div>
                        <div>Ймовірність</div>
                        <div>Менеджер</div>
                    </div>
                    <div id="projectsTable"></div>
                </div>
            </section>

            <section id="contactsSection" class="section">
                <div class="section-header">
                    <div>
                        <h2>Контактна база</h2>
                        <p>Усі клієнти, партнери та ключові особи у вашій екосистемі</p>
                    </div>
                    <div class="section-actions">
                        <input type="text" id="contactSearch" placeholder="Швидкий пошук...">
                        <select id="contactStatusFilter">
                            <option value="all">Всі статуси</option>
                            <option value="active">Активні</option>
                            <option value="potential">Потенційні</option>
                            <option value="partner">Партнери</option>
                            <option value="cold">Холодні</option>
                        </select>
                        <button class="btn btn-primary" id="openContactModalBtn">
                            <i class="fa-solid fa-user-plus"></i>
                            Новий контакт
                        </button>
                    </div>
                </div>
                <div class="contacts-table">
                    <div class="table-head">
                        <div>Контакт</div>
                        <div>Компанія</div>
                        <div>Електронна пошта</div>
                        <div>Телефон</div>
                        <div>Статус</div>
                        <div>Відповідальний</div>
                    </div>
                    <div id="contactsTable"></div>
                </div>
            </section>

            <section id="tasksSection" class="section">
                <div class="section-header">
                    <div>
                        <h2>Планер дій</h2>
                        <p>Пріоритетні задачі команди з можливістю швидкого оновлення статусу</p>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="openTaskModalBtn">
                            <i class="fa-solid fa-circle-plus"></i>
                            Нове завдання
                        </button>
                    </div>
                </div>
                <div class="task-board" id="taskBoard"></div>
            </section>

            <section id="filesSection" class="section">
                <div class="section-header">
                    <div>
                        <h2>Файловий оглядач</h2>
                        <p>Підключайте локальні папки (наприклад D:\O), щоб швидко переглядати маркетингові матеріали.</p>
                    </div>
                    <div class="section-actions">
                        <span class="file-status" id="fileScanStatus"></span>
                    </div>
                </div>
                <div class="file-manager">
                    <div class="file-actions">
                        <button class="btn btn-primary" id="connectFolderBtn">
                            <i class="fa-solid fa-folder-open"></i>
                            Підключити папку
                        </button>
                        <input type="file" id="folderInput" class="file-input-hidden" webkitdirectory aria-label="Обрати локальну папку">
                        <select id="folderSnapshotsSelect" aria-label="Збережені папки"></select>
                        <div class="file-search">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            <input type="text" id="fileSearchInput" placeholder="Пошук у вибраній папці...">
                        </div>
                    </div>
                    <div class="file-sources">
                        <div class="file-sources-header">
                            <div>
                                <h3>Підключені джерела</h3>
                                <p class="metric-sub">Локальні папки та хмарні каталоги, доступні для швидкого огляду.</p>
                            </div>
                            <div class="file-sources-actions">
                                <button class="btn btn-small-muted" id="addCloudSourceBtn">
                                    <i class="fa-solid fa-cloud-plus"></i>
                                    Додати хмарний каталог
                                </button>
                            </div>
                        </div>
                        <div class="file-sources-grid" id="fileSourceGrid"></div>
                    </div>
                    <div class="file-summary" id="fileSummary"></div>
                    <div class="file-monitor-guide" aria-labelledby="fileMonitorTitle">
                        <div class="file-monitor-header">
                            <div>
                                <h3 id="fileMonitorTitle">Моніторинг змін у файловій системі</h3>
                                <p>Python-бібліотека <strong>watchdog</strong> фіксує створення, модифікацію, переміщення та видалення файлів у реальному часі. Рішення працює на Windows, macOS і Linux, тому команда всюди отримує однаковий контроль.</p>
                            </div>
                            <span class="badge badge-info">
                                <i class="fa-brands fa-python" aria-hidden="true"></i>
                                Watchdog
                            </span>
                        </div>
                        <div class="file-monitor-grid">
                            <div class="file-monitor-item">
                                <i class="fa-solid fa-eye" aria-hidden="true"></i>
                                <div>
                                    <strong>Observer</strong>
                                    <p>Слухає вибрані каталоги та миттєво сповіщає про створення, переміщення чи видалення файлів.</p>
                                </div>
                            </div>
                            <div class="file-monitor-item">
                                <i class="fa-solid fa-code-branch" aria-hidden="true"></i>
                                <div>
                                    <strong>FileSystemEventHandler</strong>
                                    <p>Перевизначайте методи <code>on_created</code>, <code>on_modified</code>, <code>on_deleted</code> і <code>on_moved</code>, щоб автоматично логувати активність у CRM.</p>
                                </div>
                            </div>
                        </div>
                        <ul class="file-monitor-list">
                            <li><strong>Кілька каталогів.</strong> Додавайте будь-яку кількість шляхів до одного Observer, щоб синхронно відстежувати робочі папки команди.</li>
                            <li><strong>Фільтри за розширеннями.</strong> Реагуйте лише на важливі формати (наприклад, <code>.docx</code> або <code>.pdf</code>), щоб уникати шуму.</li>
                            <li><strong>Власні сценарії.</strong> Обробники подій легко доповнити записом у базу CRM, відправкою сповіщень чи запуском інтеграцій.</li>
                        </ul>
                        <div class="file-monitor-note">
                            <i class="fa-solid fa-database" aria-hidden="true"></i>
                            <p>Зберігайте журнал подій безпосередньо у CRM, щоб менеджери миттєво бачили нові документи, оновлення договірних файлів та видалення матеріалів.</p>
                        </div>
                        <div class="file-monitor-footer">
                            <a href="https://pythonsnacks.com" target="_blank" rel="noopener">Докладніше про watchdog на pythonsnacks.com</a>
                        </div>
                    </div>
                    <div class="file-tree">
                        <div class="file-tree-head">
                            <div>Елемент</div>
                            <div>Розмір</div>
                            <div>Оновлено</div>
                        </div>
                        <div class="file-tree-body" id="fileTreeBody"></div>
                    </div>
                </div>
            </section>

            <section id="analyticsSection" class="section">
                <div class="section-header">
                    <div>
                        <h2>Глибинні інсайти</h2>
                        <p>Показники ефективності команди та здоров'я воронки</p>
                    </div>
                    <div class="section-actions">
                        <span class="badge badge-success" id="insightUpdated"></span>
                    </div>
                </div>
                <div class="analytics-grid">
                    <div class="card">
                        <h3>Конверсія по етапах</h3>
                        <div class="progress-list" id="conversionInsights"></div>
                    </div>
                    <div class="card">
                        <h3>Продуктивність менеджерів</h3>
                        <div class="progress-list" id="teamPerformance"></div>
                    </div>
                    <div class="card">
                        <h3>Угоди, що потребують уваги</h3>
                        <div class="lead-focus-list" id="leadFocus"></div>
                    </div>
                    <div class="card">
                        <h3>Темп закриття</h3>
                        <div id="velocityInsights"></div>
                    </div>
                </div>
            </section>

            <section id="rolesSection" class="section">
                <div class="section-header">
                    <div>
                        <h2>Ролі та доступи</h2>
                        <p>Розподіляйте відповідальність та обмежуйте доступ до критичних дій</p>
                    </div>
                    <div class="section-actions">
                        <span class="badge badge-info" id="currentUserBadge">
                            <i class="fa-solid fa-user" aria-hidden="true"></i>
                            <span id="currentUserName">Користувач</span>
                        </span>
                    </div>
                </div>

                <div class="role-layout">
                    <div class="card">
                        <h3>Модель доступу</h3>
                        <p class="role-summary">CRM містить набір рекомендованих ролей: Owner, Manager, Storekeeper та Support. Кожна роль має власні межі видимості даних і дозволів на зміни.</p>
                        <div class="role-definition-grid" id="roleDefinitionGrid"></div>
                        <div class="role-warning" role="alert">
                            <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i>
                            <span>Менеджери не можуть призначити собі роль Owner. Передача прав власника доступна лише чинному Owner або адміністратору.</span>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Ролі команди</h3>
                        <p class="role-summary">Призначте кожному учаснику відповідну роль та перегляньте дозволи.</p>
                        <div class="role-table" id="roleAssignmentsTable"></div>
                    </div>
                </div>

                <div class="card">
                    <h3>Створити кастомну роль</h3>
                    <p class="role-summary">Додайте власну роль для окремих відділів. Базові права можна успадкувати з існуючих ролей.</p>
                    <form id="customRoleForm" class="role-form">
                        <div class="form-group">
                            <label for="customRoleName">Назва ролі</label>
                            <input type="text" id="customRoleName" placeholder="Наприклад, Analyst" required>
                        </div>
                        <div class="form-group">
                            <label for="customRoleBase">Базувати на</label>
                            <select id="customRoleBase"></select>
                        </div>
                        <div class="form-group full">
                            <label for="customRoleNotes">Доступні дії</label>
                            <textarea id="customRoleNotes" placeholder="Опишіть, що може робити ця роль."></textarea>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-small-primary">Зберегти роль</button>
                        </div>
                    </form>
                </div>
            </section>
        </main>
    </div>
    <!-- Модальні вікна -->
    <div class="modal" id="addLeadModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>Новий лід</h3>
                <button class="modal-close" type="button" data-close>&times;</button>
            </div>
            <form id="leadForm" class="form-grid">
                <div class="form-group">
                    <label for="leadTitle">Назва можливості</label>
                    <input type="text" id="leadTitle" placeholder="Наприклад, Розробка CRM для NovaPay" required>
                </div>
                <div class="form-group">
                    <label for="leadCompany">Компанія</label>
                    <input type="text" id="leadCompany" placeholder="Компанія або бренд" required>
                </div>
                <div class="form-group">
                    <label for="leadValue">Бюджет, ₴</label>
                    <input type="number" id="leadValue" min="0" step="1000" required>
                </div>
                <div class="form-group">
                    <label for="leadStage">Етап</label>
                    <select id="leadStage" required></select>
                </div>
                <div class="form-group">
                    <label for="leadProbability">Ймовірність, %</label>
                    <input type="number" id="leadProbability" min="0" max="100" step="5" value="30">
                </div>
                <div class="form-group">
                    <label for="leadOwner">Менеджер</label>
                    <select id="leadOwner" required></select>
                </div>
                <div class="form-group">
                    <label for="leadContactName">Контактна особа</label>
                    <input type="text" id="leadContactName" placeholder="Ім'я та прізвище">
                </div>
                <div class="form-group">
                    <label for="leadContactEmail">Email</label>
                    <input type="email" id="leadContactEmail" placeholder="name@company.ua">
                </div>
                <div class="form-group">
                    <label for="leadContactPhone">Телефон</label>
                    <input type="tel" id="leadContactPhone" placeholder="+380">
                </div>
                <div class="form-group full">
                    <label for="leadTags">Мітки</label>
                    <input type="text" id="leadTags" placeholder="Введіть через кому: Терміново, VIP">
                </div>
                <div class="form-group full">
                    <label for="leadFiles">Файли та папки</label>
                    <div class="file-dropzone" id="leadFileDropzone" role="button" tabindex="0" aria-describedby="leadFileHint">
                        <input type="file" id="leadFiles" class="file-input-hidden" multiple webkitdirectory aria-label="Додати файли та папки до ліда">
                        <div class="file-dropzone-content">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            <div class="file-dropzone-text">
                                <strong>Перетягніть сюди файли</strong>
                                <div class="file-dropzone-actions">або <button type="button" class="file-browse-btn" id="leadFileBrowseBtn">оберіть</button> на пристрої</div>
                                <p class="upload-hint" id="leadFileHint">Можна завантажувати декілька файлів та цілі папки (Chrome, Edge).</p>
                            </div>
                        </div>
                    </div>
                    <div class="upload-progress" id="leadUploadProgress" role="status" aria-live="polite">
                        <strong id="leadUploadLabel">Готово</strong>
                        <div class="upload-progress-track">
                            <div class="upload-progress-value" id="leadUploadBar"></div>
                        </div>
                        <span id="leadUploadText">Очікування файлів…</span>
                    </div>
                    <div class="file-list" id="leadFileList"></div>
                </div>
                <div class="form-group full">
                    <label for="leadNotes">Примітка</label>
                    <textarea id="leadNotes" placeholder="Вкажіть додаткові деталі..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-small-muted" data-close>Скасувати</button>
                    <button type="submit" class="btn btn-primary">Зберегти</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="addProjectModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>Новий проект</h3>
                <button class="modal-close" type="button" data-close>&times;</button>
            </div>
            <form id="projectForm" class="form-grid">
                <div class="form-group">
                    <label for="projectName">Назва проекту</label>
                    <input type="text" id="projectName" placeholder="Наприклад, CRM для NovaPay" required>
                </div>
                <div class="form-group">
                    <label for="projectCompany">Компанія</label>
                    <input type="text" id="projectCompany" placeholder="Компанія або бренд" required>
                </div>
                <div class="form-group">
                    <label for="projectBudget">Бюджет, ₴</label>
                    <input type="number" id="projectBudget" min="0" step="1000" required>
                </div>
                <div class="form-group">
                    <label for="projectStage">Етап</label>
                    <select id="projectStage" required></select>
                </div>
                <div class="form-group">
                    <label for="projectProbability">Ймовірність успіху, %</label>
                    <input type="number" id="projectProbability" min="0" max="100" step="5" value="50" required>
                </div>
                <div class="form-group">
                    <label for="projectOwner">Відповідальний</label>
                    <select id="projectOwner" required></select>
                </div>
                <div class="form-group">
                    <label for="projectTeam">Команда</label>
                    <select id="projectTeam" multiple size="4"></select>
                    <span class="input-hint">Утримуйте Ctrl / Command, щоб обрати кілька учасників.</span>
                </div>
                <div class="form-group">
                    <label for="projectContact">Контактна особа</label>
                    <input type="text" id="projectContact" placeholder="Ім'я та посада">
                </div>
                <div class="form-group full">
                    <label for="projectTags">Мітки</label>
                    <input type="text" id="projectTags" placeholder="CRM, Запуск, VIP">
                </div>
                <div class="form-group full">
                    <label for="projectSummary">Короткий опис</label>
                    <textarea id="projectSummary" placeholder="Основні задачі або наступні кроки"></textarea>
                </div>
                <div class="form-group full">
                    <label for="projectFiles">Вкладення</label>
                    <div class="file-dropzone" id="projectFileDropzone" role="button" tabindex="0" aria-describedby="projectFileHint">
                        <input type="file" id="projectFiles" class="file-input-hidden" multiple aria-label="Додати файли до проекту">
                        <div class="file-dropzone-content">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            <div class="file-dropzone-text">
                                <strong>Перетягніть документи проекту</strong>
                                <div class="file-dropzone-actions">або <button type="button" class="file-browse-btn" id="projectFileBrowseBtn">оберіть</button> вручну</div>
                                <p class="upload-hint" id="projectFileHint">Підтримуються бриф, кошториси, медіаплани та інші документи.</p>
                            </div>
                        </div>
                    </div>
                    <div class="upload-progress" id="projectUploadProgress" role="status" aria-live="polite">
                        <strong id="projectUploadLabel">Готово</strong>
                        <div class="upload-progress-track">
                            <div class="upload-progress-value" id="projectUploadBar"></div>
                        </div>
                        <span id="projectUploadText">Очікування файлів…</span>
                    </div>
                    <div class="file-list" id="projectFileList"></div>
                </div>
                <div class="form-group full">
                    <label for="projectNotes">Нотатки</label>
                    <textarea id="projectNotes" placeholder="Кожну думку вводьте з нового рядка"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-small-muted" data-close>Скасувати</button>
                    <button type="submit" class="btn btn-primary">Додати проект</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="addContactModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>Новий контакт</h3>
                <button class="modal-close" type="button" data-close>&times;</button>
            </div>
            <form id="contactForm" class="form-grid">
                <div class="form-group">
                    <label for="contactName">ПІБ</label>
                    <input type="text" id="contactName" required>
                </div>
                <div class="form-group">
                    <label for="contactCompany">Компанія</label>
                    <input type="text" id="contactCompany" placeholder="Організація або бренд" required>
                </div>
                <div class="form-group">
                    <label for="contactRole">Роль</label>
                    <input type="text" id="contactRole" placeholder="Посада або роль">
                </div>
                <div class="form-group">
                    <label for="contactEmail">Email</label>
                    <input type="email" id="contactEmail">
                </div>
                <div class="form-group">
                    <label for="contactPhone">Телефон</label>
                    <input type="tel" id="contactPhone">
                </div>
                <div class="form-group">
                    <label for="contactStatus">Статус</label>
                    <select id="contactStatus">
                        <option value="active">Активний</option>
                        <option value="potential">Потенційний</option>
                        <option value="partner">Партнер</option>
                        <option value="cold">Холодний</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="contactOwner">Менеджер</label>
                    <select id="contactOwner"></select>
                </div>
                <div class="form-group full">
                    <label for="contactTags">Мітки</label>
                    <input type="text" id="contactTags" placeholder="VIP, Рекомендація">
                </div>
                <div class="form-group full">
                    <label for="contactFiles">Вкладення</label>
                    <div class="file-dropzone" id="contactFileDropzone" role="button" tabindex="0" aria-describedby="contactFileHint">
                        <input type="file" id="contactFiles" class="file-input-hidden" multiple aria-label="Додати файли до контакту">
                        <div class="file-dropzone-content">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            <div class="file-dropzone-text">
                                <strong>Прикріпіть документи клієнта</strong>
                                <div class="file-dropzone-actions">або <button type="button" class="file-browse-btn" id="contactFileBrowseBtn">оберіть</button> вручну</div>
                                <p class="upload-hint" id="contactFileHint">Завантажте договори, презентації чи листування.</p>
                            </div>
                        </div>
                    </div>
                    <div class="upload-progress" id="contactUploadProgress" role="status" aria-live="polite">
                        <strong id="contactUploadLabel">Готово</strong>
                        <div class="upload-progress-track">
                            <div class="upload-progress-value" id="contactUploadBar"></div>
                        </div>
                        <span id="contactUploadText">Очікування файлів…</span>
                    </div>
                    <div class="file-list" id="contactFileList"></div>
                </div>
                <div class="form-group full">
                    <label for="contactNotes">Нотатка</label>
                    <textarea id="contactNotes" placeholder="Основні домовленості або наступні кроки"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-small-muted" data-close>Скасувати</button>
                    <button type="submit" class="btn btn-primary">Додати контакт</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="addTaskModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>Нове завдання</h3>
                <button class="modal-close" type="button" data-close>&times;</button>
            </div>
            <form id="taskForm" class="form-grid">
                <div class="form-group">
                    <label for="taskTitle">Назва</label>
                    <input type="text" id="taskTitle" placeholder="Наприклад, Підготувати презентацію" required>
                </div>
                <div class="form-group">
                    <label for="taskOwner">Відповідальний</label>
                    <select id="taskOwner" required></select>
                </div>
                <div class="form-group">
                    <label for="taskDueDate">Термін</label>
                    <input type="date" id="taskDueDate" required>
                </div>
                <div class="form-group">
                    <label for="taskPriority">Пріоритет</label>
                    <select id="taskPriority">
                        <option value="high">Високий</option>
                        <option value="medium">Середній</option>
                        <option value="low">Низький</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskStatus">Статус</label>
                    <select id="taskStatus">
                        <option value="todo">До виконання</option>
                        <option value="inProgress">В роботі</option>
                        <option value="done">Завершено</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskLead">Пов'язаний лід</label>
                    <select id="taskLead">
                        <option value="">Без прив'язки</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskTags">Мітки</label>
                    <input type="text" id="taskTags" placeholder="Наприклад, Follow-up, Пріоритет">
                </div>
                <div class="form-group full">
                    <label for="taskDescription">Коментар</label>
                    <textarea id="taskDescription" placeholder="Опишіть наступні кроки..."></textarea>
                </div>
                <div class="form-group full">
                    <label for="taskFiles">Додати файли</label>
                    <div class="file-dropzone" id="taskFileDropzone" role="button" tabindex="0" aria-describedby="taskFileHint">
                        <input type="file" id="taskFiles" class="file-input-hidden" multiple aria-label="Додати файли до завдання">
                        <div class="file-dropzone-content">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            <div class="file-dropzone-text">
                                <strong>Перетягніть матеріали для завдання</strong>
                                <div class="file-dropzone-actions">або <button type="button" class="file-browse-btn" id="taskFileBrowseBtn">оберіть</button> вручну</div>
                                <p class="upload-hint" id="taskFileHint">Додавайте бриф, шаблони листів чи зображення.</p>
                            </div>
                        </div>
                    </div>
                    <div class="upload-progress" id="taskUploadProgress" role="status" aria-live="polite">
                        <strong id="taskUploadLabel">Готово</strong>
                        <div class="upload-progress-track">
                            <div class="upload-progress-value" id="taskUploadBar"></div>
                        </div>
                        <span id="taskUploadText">Очікування файлів…</span>
                    </div>
                    <div class="file-list" id="taskFileList"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-small-muted" data-close>Скасувати</button>
                    <button type="submit" class="btn btn-primary">Додати завдання</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="leadDetailsModal">
        <div class="modal-dialog wide">
            <div class="modal-header">
                <h3 id="leadDetailsTitle">Деталі угоди</h3>
                <button class="modal-close" type="button" data-close>&times;</button>
            </div>
            <div class="lead-details" id="leadDetailsContent"></div>
        </div>
    </div>
    <script>
        const STORAGE_KEY = 'homeCRMData_v2';
        const STAGES = ['Новий', 'Кваліфікація', 'Пропозиція', 'Переговори', 'Угода', 'Втрачено'];
        const PROJECT_STAGES = ['Ініціація', 'Discovery', 'Планування', 'Розробка', 'Тестування', 'Запуск', 'Підтримка'];
        const TASK_COLUMNS = [
            { id: 'todo', title: 'До виконання' },
            { id: 'inProgress', title: 'В роботі' },
            { id: 'done', title: 'Завершено' }
        ];
        const TEAM_MEMBERS = ['Марина', 'Олександр', 'Вікторія', 'Дмитро'];
        const CURRENT_USER = {
            name: 'Марина',
            role: 'manager'
        };
        const ROLE_DEFINITIONS = [
            {
                id: 'owner',
                name: 'Owner',
                badge: 'Owner',
                description: 'Повний контроль над CRM, може оновлювати налаштування та передавати права.',
                permissions: [
                    'Керування ролями та правами доступу',
                    'Редагування бюджетів і фінансових звітів',
                    'Перегляд усіх проектів та файлів'
                ],
                limitations: ['Тільки один користувач у компанії']
            },
            {
                id: 'manager',
                name: 'Sales Manager',
                badge: 'Manager',
                description: 'Веде комунікацію з клієнтами, контролює воронку продажів і задачі.',
                permissions: [
                    'Створення та редагування лідів і проектів',
                    'Планування та виконання задач команди',
                    'Завантаження файлів у своїх проектах'
                ],
                limitations: ['Не може змінювати роль Owner', 'Без доступу до системних налаштувань']
            },
            {
                id: 'storekeeper',
                name: 'Storekeeper',
                badge: 'Storekeeper',
                description: 'Опікується технічною документацією та ресурсами, контролює файлові бібліотеки.',
                permissions: [
                    'Доступ до файлового архіву',
                    'Оновлення статусів постачань',
                    'Коментування задач'
                ],
                limitations: ['Не бачить фінансові показники']
            },
            {
                id: 'support',
                name: 'Support',
                badge: 'Support',
                description: 'Працює зі зверненнями клієнтів і допомагає менеджерам.',
                permissions: [
                    'Перегляд контактів і нотаток',
                    'Створення задач на звернення клієнтів'
                ],
                limitations: ['Без права змінювати бюджети та етапи угод']
            }
        ];
        const STATUS_LABELS = {
            active: 'Активний',
            potential: 'Потенційний',
            partner: 'Партнер',
            cold: 'Холодний'
        };

        const MAX_ATTACHMENT_SIZE = 1.5 * 1024 * 1024; // 1.5 МБ
        const MAX_TOTAL_ATTACHMENTS_SIZE = 4 * 1024 * 1024; // 4 МБ
        const FILE_LIBRARY_LIMIT = 6;
        const attachmentAreas = {};
        const MODAL_ATTACHMENT_AREAS = {
            addLeadModal: ['lead'],
            addProjectModal: ['project'],
            addContactModal: ['contact'],
            addTaskModal: ['task']
        };
        const navigationState = { search: '', filter: 'all' };
        let applyNavigationFilters = () => {};

        let crmData = null;
        let activeLeadId = null;
        let pipelineFilterOwner = 'all';
        let contactStatusFilter = 'all';
        let projectStageFilter = 'all';
        let projectMinProbability = 0;
        let projectSearchTerm = '';
        let searchTimer = null;
        let activeFileSnapshotId = null;
        let activeFileSourceId = null;
        let pendingFileSourceId = null;
        let fileSearchTerm = '';
        let isScanningFolder = false;

        const persistentStorage = (() => {
            try {
                if (typeof window === 'undefined' || !('localStorage' in window)) {
                    return null;
                }
                const storage = window.localStorage;
                const testKey = '__homecrm_test__';
                storage.setItem(testKey, '1');
                storage.removeItem(testKey);
                return storage;
            } catch (error) {
                console.warn('Локальне сховище недоступне. Дані CRM зберігатимуться лише поточної сесії.', error);
                return null;
            }
        })();
        let canPersistData = !!persistentStorage;

        const defaultData = {
            leads: [
                {
                    id: 'lead-1',
                    name: 'Редизайн порталу NovaPay',
                    company: 'NovaPay',
                    stage: 'Кваліфікація',
                    value: 58000,
                    probability: 45,
                    owner: 'Марина',
                    status: 'active',
                    expectedClose: '2024-07-10',
                    contact: {
                        id: 'contact-1',
                        person: 'Андрій Коваленко',
                        email: 'a.kovalenko@novapay.ua',
                        phone: '+380 67 123 45 67'
                    },
                    tags: ['High value', 'Веб'],
                    createdAt: '2024-05-18T09:24:00.000Z',
                    updatedAt: '2024-06-02T12:15:00.000Z',
                    notes: [
                        {
                            id: 'note-1',
                            text: 'Очікують детальний план робіт до кінця тижня.',
                            author: 'Марина',
                            date: '2024-06-02T12:15:00.000Z'
                        }
                    ],
                    timeline: [
                        { id: 'tl-1', text: 'Лід створено Марина', date: '2024-05-18T09:24:00.000Z' },
                        { id: 'tl-2', text: 'Стадія змінена на «Кваліфікація»', date: '2024-05-20T14:00:00.000Z' }
                    ],
                    attachments: [
                        {
                            id: 'file-brief-novapay',
                            name: 'Бриф NovaPay.txt',
                            path: 'NovaPay/Бриф NovaPay.txt',
                            size: 54,
                            type: 'text/plain',
                            lastModified: 1714640400000,
                            dataUrl: 'data:text/plain;base64,0JrQvtGA0L7RgtC60LjQuSDQsdGA0LjRhCDQv9C+INCy0LjQvNC+0LPQsNC8IE5vdmFQYXku'
                        }
                    ]
                },
                {
                    id: 'lead-2',
                    name: 'Автоматизація логістики Rozetka',
                    company: 'Rozetka',
                    stage: 'Пропозиція',
                    value: 72000,
                    probability: 55,
                    owner: 'Олександр',
                    status: 'active',
                    expectedClose: '2024-07-25',
                    contact: {
                        id: 'contact-2',
                        person: 'Ірина Мельник',
                        email: 'i.melnyk@rozetka.ua',
                        phone: '+380 50 777 23 11'
                    },
                    tags: ['Автоматизація', 'Пріоритет'],
                    createdAt: '2024-05-10T08:42:00.000Z',
                    updatedAt: '2024-06-04T09:30:00.000Z',
                    notes: [
                        {
                            id: 'note-2',
                            text: 'Потрібно погодити комерційну пропозицію до 12 червня.',
                            author: 'Олександр',
                            date: '2024-06-01T11:00:00.000Z'
                        }
                    ],
                    timeline: [
                        { id: 'tl-3', text: 'Запит на автоматизацію логістики', date: '2024-05-10T08:42:00.000Z' },
                        { id: 'tl-4', text: 'Відправлено попередній кошторис', date: '2024-05-26T15:20:00.000Z' }
                    ],
                    attachments: []
                },
                {
                    id: 'lead-3',
                    name: 'CRM для GreenBank',
                    company: 'GreenBank',
                    stage: 'Переговори',
                    value: 91000,
                    probability: 70,
                    owner: 'Вікторія',
                    status: 'active',
                    expectedClose: '2024-08-05',
                    contact: {
                        id: 'contact-3',
                        person: 'Олег Данилюк',
                        email: 'o.danyliuk@greenbank.ua',
                        phone: '+380 63 555 14 78'
                    },
                    tags: ['Фінанси', 'Інтеграція'],
                    createdAt: '2024-04-28T10:00:00.000Z',
                    updatedAt: '2024-06-03T15:45:00.000Z',
                    notes: [
                        {
                            id: 'note-3',
                            text: 'Запросили інтеграцію з внутрішньою системою KYC.',
                            author: 'Вікторія',
                            date: '2024-06-03T15:45:00.000Z'
                        }
                    ],
                    timeline: [
                        { id: 'tl-5', text: 'Проведено демонстрацію продукту', date: '2024-05-14T13:30:00.000Z' },
                        { id: 'tl-6', text: 'Вікторія оновила стадію на «Переговори»', date: '2024-06-03T15:45:00.000Z' }
                    ],
                    attachments: []
                },
                {
                    id: 'lead-4',
                    name: 'Digital-маркетинг для OKKO',
                    company: 'OKKO',
                    stage: 'Новий',
                    value: 26000,
                    probability: 25,
                    owner: 'Дмитро',
                    status: 'active',
                    expectedClose: '2024-07-30',
                    contact: {
                        id: 'contact-4',
                        person: 'Світлана Романюк',
                        email: 's.romaniuk@okko.ua',
                        phone: '+380 44 123 90 12'
                    },
                    tags: ['Маркетинг'],
                    createdAt: '2024-06-05T09:15:00.000Z',
                    updatedAt: '2024-06-05T09:15:00.000Z',
                    notes: [],
                    timeline: [
                        { id: 'tl-7', text: 'Новий лід додано Дмитро', date: '2024-06-05T09:15:00.000Z' }
                    ],
                    attachments: []
                },
                {
                    id: 'lead-5',
                    name: 'Мобільний додаток для Uklon',
                    company: 'Uklon',
                    stage: 'Угода',
                    value: 45000,
                    probability: 100,
                    owner: 'Марина',
                    status: 'won',
                    expectedClose: '2024-05-30',
                    closedAt: '2024-05-30T16:10:00.000Z',
                    contact: {
                        id: 'contact-5',
                        person: 'Роман Лещенко',
                        email: 'r.leshchenko@uklon.com',
                        phone: '+380 50 120 34 56'
                    },
                    tags: ['Мобільний', 'Гаряча'],
                    createdAt: '2024-04-02T08:25:00.000Z',
                    updatedAt: '2024-05-30T16:10:00.000Z',
                    notes: [
                        {
                            id: 'note-5',
                            text: 'Угода виграна, запускаємо реалізацію у липні.',
                            author: 'Марина',
                            date: '2024-05-30T16:10:00.000Z'
                        }
                    ],
                    timeline: [
                        { id: 'tl-8', text: 'Презентація рішень проведена', date: '2024-04-20T11:40:00.000Z' },
                        { id: 'tl-9', text: 'Угода виграна!', date: '2024-05-30T16:10:00.000Z' }
                    ],
                    attachments: []
                },
                {
                    id: 'lead-6',
                    name: 'Інтеграція ERP для Intertop',
                    company: 'Intertop',
                    stage: 'Втрачено',
                    value: 38000,
                    probability: 0,
                    owner: 'Олександр',
                    status: 'lost',
                    expectedClose: '2024-05-15',
                    contact: {
                        id: 'contact-6',
                        person: 'Катерина Сніжко',
                        email: 'k.snizhko@intertop.ua',
                        phone: '+380 44 890 45 67'
                    },
                    tags: ['ERP', 'Конкурент'],
                    createdAt: '2024-03-18T09:00:00.000Z',
                    updatedAt: '2024-05-16T10:45:00.000Z',
                    notes: [
                        {
                            id: 'note-6',
                            text: 'Клієнт обрав рішення конкурента через ціну.',
                            author: 'Олександр',
                            date: '2024-05-16T10:45:00.000Z'
                        }
                    ],
                    timeline: [
                        { id: 'tl-10', text: 'Запит на інтеграцію ERP', date: '2024-03-18T09:00:00.000Z' },
                        { id: 'tl-11', text: 'Угоду втрачено', date: '2024-05-16T10:45:00.000Z' }
                    ],
                    attachments: []
                }
            ],
            projects: [
                {
                    id: 'project-1',
                    name: 'CRM NovaPay 2.0',
                    company: 'NovaPay',
                    stage: 'Розробка',
                    budget: 92000,
                    probability: 62,
                    owner: 'Марина',
                    team: ['Марина', 'Вікторія'],
                    contact: 'Андрій Коваленко',
                    tags: ['CRM', 'Фінтех'],
                    description: 'Розширення можливостей для партнерів і омніканальних продажів.',
                    notes: [
                        { id: 'pnote-1', text: 'Запуск discovery-воркшопу 10 червня.', author: 'Марина', date: '2024-06-02T10:00:00.000Z' },
                        { id: 'pnote-2', text: 'Погодити бюджет з фінансовим директором до 15 червня.', author: 'Вікторія', date: '2024-06-03T09:30:00.000Z' }
                    ],
                    attachments: [
                        {
                            id: 'pfile-brief-novapay',
                            name: 'NovaPay-roadmap.txt',
                            path: 'NovaPay/Роудмап/NovaPay-roadmap.txt',
                            size: 312,
                            type: 'text/plain',
                            lastModified: Date.parse('2024-05-20T10:00:00.000Z'),
                            dataUrl: 'data:text/plain;base64,UGxhbm5pbmcgZG9rdW1lbnQgZm9yIE5vdmFQYXk='
                        }
                    ],
                    createdAt: '2024-04-25T09:10:00.000Z',
                    updatedAt: '2024-06-04T13:20:00.000Z'
                },
                {
                    id: 'project-2',
                    name: 'Автоматизація логістики Rozetka',
                    company: 'Rozetka',
                    stage: 'Тестування',
                    budget: 78000,
                    probability: 68,
                    owner: 'Олександр',
                    team: ['Олександр', 'Дмитро'],
                    contact: 'Ірина Мельник',
                    tags: ['Supply chain', 'Інтеграція'],
                    description: 'Впровадження планувальника маршрутів та мобільного додатку кур’єра.',
                    notes: [
                        { id: 'pnote-3', text: 'Зібрати відгуки пілотної групи кур’єрів.', author: 'Олександр', date: '2024-06-01T11:40:00.000Z' }
                    ],
                    attachments: [
                        {
                            id: 'pfile-rozetka-scope',
                            name: 'Rozetka-scope.txt',
                            path: 'Rozetka/Scope/iteration-2.txt',
                            size: 198,
                            type: 'text/plain',
                            lastModified: Date.parse('2024-05-28T14:45:00.000Z'),
                            dataUrl: 'data:text/plain;base64,U2NvcGUgZm9yIExvZ2lzdGljcyBQaGFzZSAy'
                        }
                    ],
                    createdAt: '2024-04-12T08:35:00.000Z',
                    updatedAt: '2024-06-01T11:40:00.000Z'
                },
                {
                    id: 'project-3',
                    name: 'Digital-кампанія для OKKO',
                    company: 'OKKO',
                    stage: 'Discovery',
                    budget: 54000,
                    probability: 45,
                    owner: 'Дмитро',
                    team: ['Дмитро', 'Марина'],
                    contact: 'Світлана Романюк',
                    tags: ['Маркетинг', 'Discovery'],
                    description: 'Аналітика клієнтських сегментів і підготовка контент-стратегії.',
                    notes: [
                        { id: 'pnote-4', text: 'Затвердити перші три контент-спринти.', author: 'Дмитро', date: '2024-06-05T09:15:00.000Z' }
                    ],
                    attachments: [
                        {
                            id: 'pfile-okko-brief',
                            name: 'OKKO-creative-brief.txt',
                            path: 'OKKO/Briefs/creative-brief.txt',
                            size: 274,
                            type: 'text/plain',
                            lastModified: Date.parse('2024-05-31T16:05:00.000Z'),
                            dataUrl: 'data:text/plain;base64,Q3JlYXRpdmUgYnJpZWYgZm9yIE9LS08gZGlnaXRhbCBjYW1wYWlnbg=='
                        }
                    ],
                    createdAt: '2024-05-02T10:20:00.000Z',
                    updatedAt: '2024-06-05T09:15:00.000Z'
                }
            ],
            contacts: [
                {
                    id: 'contact-1',
                    name: 'Андрій Коваленко',
                    company: 'NovaPay',
                    role: 'COO',
                    email: 'a.kovalenko@novapay.ua',
                    phone: '+380 67 123 45 67',
                    status: 'active',
                    owner: 'Марина',
                    tags: ['VIP'],
                    lastActivity: '2024-06-02T12:15:00.000Z',
                    notes: [
                        { id: 'cnote-1', text: 'Очікує фінальне узгодження roadmap.', author: 'Марина', date: '2024-06-02T12:15:00.000Z' }
                    ],
                    attachments: [
                        {
                            id: 'cfile-novapay-agreement',
                            name: 'NovaPay-agreement.txt',
                            path: 'Contacts/NovaPay/agreement.txt',
                            size: 256,
                            type: 'text/plain',
                            lastModified: Date.parse('2024-05-30T07:20:00.000Z'),
                            dataUrl: 'data:text/plain;base64,Q29udHJhY3Qgc3VtbWFyeSBmb3IgTm92YVBheQ=='
                        }
                    ]
                },
                {
                    id: 'contact-2',
                    name: 'Ірина Мельник',
                    company: 'Rozetka',
                    role: 'Head of Logistics',
                    email: 'i.melnyk@rozetka.ua',
                    phone: '+380 50 777 23 11',
                    status: 'potential',
                    owner: 'Олександр',
                    tags: ['Priority'],
                    lastActivity: '2024-06-01T11:00:00.000Z',
                    notes: [
                        { id: 'cnote-2', text: 'Надіслати оновлений KPI-лист до 14 червня.', author: 'Олександр', date: '2024-06-01T11:00:00.000Z' }
                    ],
                    attachments: []
                },
                {
                    id: 'contact-3',
                    name: 'Олег Данилюк',
                    company: 'GreenBank',
                    role: 'Digital Transformation Lead',
                    email: 'o.danyliuk@greenbank.ua',
                    phone: '+380 63 555 14 78',
                    status: 'active',
                    owner: 'Вікторія',
                    tags: ['Фінанси'],
                    lastActivity: '2024-06-03T15:45:00.000Z',
                    notes: [
                        { id: 'cnote-3', text: 'Чекає демо KYC-модуля у середу.', author: 'Вікторія', date: '2024-06-03T15:45:00.000Z' }
                    ],
                    attachments: [
                        {
                            id: 'cfile-greenbank-nda',
                            name: 'GreenBank-NDA.txt',
                            path: 'Contacts/GreenBank/NDA.txt',
                            size: 188,
                            type: 'text/plain',
                            lastModified: Date.parse('2024-05-18T09:40:00.000Z'),
                            dataUrl: 'data:text/plain;base64,TkRBIGZvciBHcmVlbkJhbms=' 
                        }
                    ]
                },
                {
                    id: 'contact-4',
                    name: 'Світлана Романюк',
                    company: 'OKKO',
                    role: 'Marketing Director',
                    email: 's.romaniuk@okko.ua',
                    phone: '+380 44 123 90 12',
                    status: 'potential',
                    owner: 'Дмитро',
                    tags: ['Marketing'],
                    lastActivity: '2024-06-05T09:15:00.000Z',
                    notes: [],
                    attachments: []
                },
                {
                    id: 'contact-5',
                    name: 'Роман Лещенко',
                    company: 'Uklon',
                    role: 'Product Owner',
                    email: 'r.leshchenko@uklon.com',
                    phone: '+380 50 120 34 56',
                    status: 'partner',
                    owner: 'Марина',
                    tags: ['Strategic'],
                    lastActivity: '2024-05-30T16:10:00.000Z',
                    notes: [
                        { id: 'cnote-4', text: 'Заплановано ретроспективу запуску на 12 червня.', author: 'Марина', date: '2024-05-31T09:00:00.000Z' }
                    ],
                    attachments: [
                        {
                            id: 'cfile-uklon-summary',
                            name: 'Uklon-summary.txt',
                            path: 'Contacts/Uklon/summary.txt',
                            size: 204,
                            type: 'text/plain',
                            lastModified: Date.parse('2024-05-29T12:25:00.000Z'),
                            dataUrl: 'data:text/plain;base64,U3VtbWFyeSBmb3IgVWxrb24gc3VjY2VzcyBtb2R1bGU='
                        }
                    ]
                }
            ],
            tasks: [
                {
                    id: 'task-1',
                    title: 'Підготувати технічний аудит для NovaPay',
                    status: 'inProgress',
                    priority: 'high',
                    owner: 'Марина',
                    dueDate: '2024-06-08',
                    relatedLeadId: 'lead-1',
                    description: 'Зібрати технічні вимоги та запланувати воркшоп з командою клієнта.',
                    tags: ['Discovery', 'NovaPay'],
                    attachments: [
                        {
                            id: 'tfile-audit-checklist',
                            name: 'audit-checklist.txt',
                            path: 'Tasks/NovaPay/audit-checklist.txt',
                            size: 164,
                            type: 'text/plain',
                            lastModified: Date.parse('2024-06-01T09:00:00.000Z'),
                            dataUrl: 'data:text/plain;base64,QXVkaXQgY2hlY2tsaXN0IGZvciBOb3ZhUGF5IHRlYW0='
                        }
                    ],
                    createdAt: '2024-05-30T09:15:00.000Z'
                },
                {
                    id: 'task-2',
                    title: 'Оновити комерційну пропозицію Rozetka',
                    status: 'todo',
                    priority: 'high',
                    owner: 'Олександр',
                    dueDate: '2024-06-07',
                    relatedLeadId: 'lead-2',
                    description: 'Додати блок про інтеграцію з WMS та підрахувати ROI.',
                    tags: ['Proposal'],
                    attachments: [],
                    createdAt: '2024-05-28T08:20:00.000Z'
                },
                {
                    id: 'task-3',
                    title: 'Запланувати демонстрацію KYC-модуля',
                    status: 'todo',
                    priority: 'medium',
                    owner: 'Вікторія',
                    dueDate: '2024-06-12',
                    relatedLeadId: 'lead-3',
                    description: 'Підготувати сценарій демонстрації та приклади звітів.',
                    tags: ['Demo'],
                    attachments: [
                        {
                            id: 'tfile-kyc-script',
                            name: 'kyc-demo-script.txt',
                            path: 'Tasks/GreenBank/kyc-demo-script.txt',
                            size: 220,
                            type: 'text/plain',
                            lastModified: Date.parse('2024-06-03T15:00:00.000Z'),
                            dataUrl: 'data:text/plain;base64,S1lDIGRlbW8gc2NyaXB0IGZvciBncmVlbmJhbmsgdGVhbQ=='
                        }
                    ],
                    createdAt: '2024-05-31T10:45:00.000Z'
                },
                {
                    id: 'task-4',
                    title: 'Підбір кейсів для OKKO',
                    status: 'inProgress',
                    priority: 'medium',
                    owner: 'Дмитро',
                    dueDate: '2024-06-09',
                    relatedLeadId: 'lead-4',
                    description: 'Підібрати релевантні кейси з рітейлу та оформити презентацію.',
                    tags: ['Контент'],
                    attachments: [],
                    createdAt: '2024-05-29T12:00:00.000Z'
                },
                {
                    id: 'task-5',
                    title: 'Ретроспектива після запуску Uklon',
                    status: 'done',
                    priority: 'low',
                    owner: 'Марина',
                    dueDate: '2024-06-01',
                    relatedLeadId: 'lead-5',
                    description: 'Зафіксувати висновки та рекомендації для наступних запусків.',
                    tags: ['Retro'],
                    attachments: [],
                    completedAt: '2024-06-01',
                    createdAt: '2024-05-20T14:10:00.000Z'
                }
            ],
            activities: [
                {
                    id: 'act-3',
                    type: 'task',
                    entityId: 'task-4',
                    message: 'Створено нове завдання для OKKO.',
                    timestamp: '2024-06-05T09:15:00.000Z'
                },
                {
                    id: 'act-6',
                    type: 'role',
                    entityId: 'member-victoria',
                    message: 'Марина призначила Вікторію на роль Project Coordinator.',
                    timestamp: '2024-06-04T16:30:00.000Z'
                },
                {
                    id: 'act-1',
                    type: 'stage',
                    entityId: 'lead-3',
                    message: 'Вікторія оновила стадію GreenBank до «Переговори».',
                    timestamp: '2024-06-03T15:45:00.000Z'
                },
                {
                    id: 'act-2',
                    type: 'note',
                    entityId: 'lead-2',
                    message: 'Олександр додав нотатку до Rozetka: потребують нову комерційну пропозицію.',
                    timestamp: '2024-06-01T11:00:00.000Z'
                },
                {
                    id: 'act-4',
                    type: 'won',
                    entityId: 'lead-5',
                    message: 'Марина закрила угоду з Uklon на 45 000 ₴.',
                    timestamp: '2024-05-30T16:10:00.000Z'
                },
                {
                    id: 'act-5',
                    type: 'lost',
                    entityId: 'lead-6',
                    message: 'Intertop обрав рішення конкурента. Угоду позначено як втрачено.',
                    timestamp: '2024-05-16T10:45:00.000Z'
                }
            ],
            roles: {
                customRoles: [
                    {
                        id: 'role-project-coordinator',
                        name: 'Project Coordinator',
                        badge: 'Coordinator',
                        description: 'Відповідає за запуск проектів і синхронізацію команд.',
                        permissions: [
                            'Координація стартових зустрічей',
                            'Контроль таймлайну проектів',
                            'Перевірка завантажених матеріалів'
                        ],
                        limitations: ['Без права змінювати фінансові показники'],
                        baseRoleId: 'manager',
                        createdAt: '2024-04-22T09:00:00.000Z',
                        createdBy: 'Марина',
                        custom: true
                    },
                    {
                        id: 'role-marketing-curator',
                        name: 'Marketing Curator',
                        badge: 'Curator',
                        description: 'Опікується контентом та партнерськими активаціями.',
                        permissions: [
                            'Планування маркетингових задач',
                            'Керування контент-бібліотекою',
                            'Погодження матеріалів з клієнтами'
                        ],
                        limitations: ['Без доступу до налаштувань ролей'],
                        baseRoleId: 'support',
                        createdAt: '2024-04-28T14:30:00.000Z',
                        createdBy: 'Дмитро',
                        custom: true
                    }
                ],
                assignments: [
                    {
                        id: 'member-oleksandr',
                        name: 'Олександр',
                        email: 'oleksandr@demo-crm.ua',
                        department: 'Операційний відділ',
                        title: 'Комерційний директор',
                        phone: '+380 50 777 23 11',
                        roleId: 'owner',
                        responsibilities: [
                            'Фінансове планування',
                            'Стратегія розвитку продажів',
                            'Затвердження бюджетів'
                        ],
                        note: 'Керує ключовими угодами та правами доступу.',
                        updatedAt: '2024-06-01T08:30:00.000Z',
                        updatedBy: 'Система',
                        locked: true
                    },
                    {
                        id: 'member-marina',
                        name: 'Марина',
                        email: 'marina@demo-crm.ua',
                        department: 'Відділ продажів',
                        title: 'Керівниця продажів',
                        phone: '+380 67 123 45 67',
                        roleId: 'manager',
                        responsibilities: [
                            'Керування воронкою продажів',
                            'Контроль командних задач',
                            'Підготовка демо для клієнтів'
                        ],
                        note: 'Фокусується на стратегічних клієнтах і нових угодах.',
                        updatedAt: '2024-06-03T10:15:00.000Z',
                        updatedBy: 'Олександр',
                        locked: false
                    },
                    {
                        id: 'member-victoria',
                        name: 'Вікторія',
                        email: 'victoria@demo-crm.ua',
                        department: 'Доставка проектів',
                        title: 'Project Coordinator',
                        phone: '+380 63 555 14 78',
                        roleId: 'role-project-coordinator',
                        responsibilities: [
                            'Онбординг нових проектів',
                            'Комунікація з клієнтськими командами',
                            'Актуалізація статусів задач'
                        ],
                        note: 'Призначено на координацію фінансового сектору.',
                        updatedAt: '2024-06-04T16:30:00.000Z',
                        updatedBy: 'Марина',
                        locked: false
                    },
                    {
                        id: 'member-dmytro',
                        name: 'Дмитро',
                        email: 'dmytro@demo-crm.ua',
                        department: 'Маркетинг',
                        title: 'Marketing Curator',
                        phone: '+380 44 123 90 12',
                        roleId: 'role-marketing-curator',
                        responsibilities: [
                            'Підготовка кейсів',
                            'Узгодження креативних матеріалів',
                            'Ведення контент-календаря'
                        ],
                        note: 'Відповідає за контент для партнерських програм.',
                        updatedAt: '2024-06-05T09:15:00.000Z',
                        updatedBy: 'Вікторія',
                        locked: false
                    }
                ]
            },
            fileLibrary: [
                {
                    id: 'snapshot-marketing-folder',
                    rootName: 'D:/O',
                    scannedAt: '2024-06-05T08:45:00.000Z',
                    source: 'demo',
                    tree: {
                        type: 'directory',
                        name: 'D:/O',
                        path: 'D:/O',
                        children: [
                            {
                                type: 'directory',
                                name: 'Campaigns',
                                path: 'D:/O/Campaigns',
                                children: [
                                    {
                                        type: 'directory',
                                        name: 'Digital',
                                        path: 'D:/O/Campaigns/Digital',
                                        children: [
                                            {
                                                type: 'file',
                                                name: 'spring-launch-plan.pdf',
                                                path: 'D:/O/Campaigns/Digital/spring-launch-plan.pdf',
                                                size: 2880512,
                                                lastModified: Date.parse('2024-04-11T08:10:00.000Z'),
                                                mimeType: 'application/pdf'
                                            },
                                            {
                                                type: 'file',
                                                name: 'social-calendar.xlsx',
                                                path: 'D:/O/Campaigns/Digital/social-calendar.xlsx',
                                                size: 512000,
                                                lastModified: Date.parse('2024-04-09T14:25:00.000Z'),
                                                mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                                            }
                                        ]
                                    },
                                    {
                                        type: 'directory',
                                        name: 'Offline',
                                        path: 'D:/O/Campaigns/Offline',
                                        children: [
                                            {
                                                type: 'file',
                                                name: 'billboards.ai',
                                                path: 'D:/O/Campaigns/Offline/billboards.ai',
                                                size: 4200000,
                                                lastModified: Date.parse('2024-03-29T11:40:00.000Z'),
                                                mimeType: 'application/postscript'
                                            }
                                        ]
                                    },
                                    {
                                        type: 'file',
                                        name: 'budget.xlsx',
                                        path: 'D:/O/Campaigns/budget.xlsx',
                                        size: 768000,
                                        lastModified: Date.parse('2024-04-20T09:05:00.000Z'),
                                        mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                                    }
                                ]
                            },
                            {
                                type: 'directory',
                                name: 'Design',
                                path: 'D:/O/Design',
                                children: [
                                    {
                                        type: 'file',
                                        name: 'brandbook.pdf',
                                        path: 'D:/O/Design/brandbook.pdf',
                                        size: 5120000,
                                        lastModified: Date.parse('2024-05-18T13:32:00.000Z'),
                                        mimeType: 'application/pdf'
                                    },
                                    {
                                        type: 'file',
                                        name: 'logo-pack.zip',
                                        path: 'D:/O/Design/logo-pack.zip',
                                        size: 6553600,
                                        lastModified: Date.parse('2024-05-15T10:22:00.000Z'),
                                        mimeType: 'application/zip'
                                    }
                                ]
                            },
                            {
                                type: 'directory',
                                name: 'Case Studies',
                                path: 'D:/O/Case Studies',
                                children: [
                                    {
                                        type: 'file',
                                        name: 'fintech-demo.pptx',
                                        path: 'D:/O/Case Studies/fintech-demo.pptx',
                                        size: 4718592,
                                        lastModified: Date.parse('2024-05-05T17:05:00.000Z'),
                                        mimeType: 'application/vnd.openxmlformats-officedocument.presentationml.presentation'
                                    },
                                    {
                                        type: 'file',
                                        name: 'retail-overview.pptx',
                                        path: 'D:/O/Case Studies/retail-overview.pptx',
                                        size: 3932160,
                                        lastModified: Date.parse('2024-05-03T09:55:00.000Z'),
                                        mimeType: 'application/vnd.openxmlformats-officedocument.presentationml.presentation'
                                    }
                                ]
                            },
                            {
                                type: 'file',
                                name: 'readme.txt',
                                path: 'D:/O/readme.txt',
                                size: 2048,
                                lastModified: Date.parse('2024-02-01T08:00:00.000Z'),
                                mimeType: 'text/plain'
                            },
                            {
                                type: 'file',
                                name: 'q1-report.csv',
                                path: 'D:/O/q1-report.csv',
                                size: 128000,
                                lastModified: Date.parse('2024-04-05T07:45:00.000Z'),
                                mimeType: 'text/csv'
                            }
                        ]
                    }
                }
            ],
            fileSources: [
                {
                    id: 'source-local-marketing',
                    name: 'Маркетингові матеріали',
                    type: 'local',
                    path: 'D:\\O',
                    status: 'online',
                    connected: true,
                    autoSync: false,
                    totalFiles: 10,
                    totalFolders: 5,
                    totalSize: 28814912,
                    lastSynced: '2024-06-05T08:50:00.000Z',
                    snapshotId: 'snapshot-marketing-folder',
                    favorite: true
                },
                {
                    id: 'source-google-drive',
                    name: 'Google Drive • Brand Assets',
                    type: 'cloud',
                    provider: 'Google Drive',
                    path: 'Marketing/Brand Assets',
                    status: 'online',
                    connected: true,
                    autoSync: true,
                    totalFiles: 86,
                    totalFolders: 12,
                    totalSize: 892000000,
                    lastSynced: '2024-06-04T10:45:00.000Z',
                    snapshotId: null,
                    favorite: false
                },
                {
                    id: 'source-dropbox-sales',
                    name: 'Dropbox • Sales Kits',
                    type: 'cloud',
                    provider: 'Dropbox',
                    path: 'CRM/Sales Kits',
                    status: 'offline',
                    connected: false,
                    autoSync: true,
                    totalFiles: 0,
                    totalFolders: 0,
                    totalSize: 0,
                    lastSynced: null,
                    snapshotId: null,
                    favorite: false
                }
            ]
        };
        const deepClone = (data) => JSON.parse(JSON.stringify(data));

        function generateId(prefix = 'id') {
            return `${prefix}-${Math.random().toString(36).slice(2, 9)}`;
        }

        function normalizeAttachment(file, prefix = 'file') {
            if (!file || typeof file !== 'object') {
                return null;
            }

            const name = typeof file.name === 'string' && file.name.trim().length ? file.name.trim() : 'Файл';
            const path = typeof file.path === 'string' && file.path.trim().length ? file.path.trim() : name;
            const size = Math.max(0, Number(file.size) || 0);
            const type = typeof file.type === 'string' && file.type.trim().length ? file.type : 'application/octet-stream';
            const lastModified = Number(file.lastModified) || Date.now();
            const dataUrl = typeof file.dataUrl === 'string' ? file.dataUrl : '';

            return {
                id: typeof file.id === 'string' && file.id.trim().length ? file.id : generateId(prefix),
                name,
                path,
                size,
                type,
                lastModified,
                dataUrl
            };
        }

        function normalizeNote(note, prefix = 'note', fallbackAuthor = 'CRM') {
            if (!note) {
                return null;
            }

            if (typeof note === 'string') {
                const text = note.trim();
                if (!text.length) {
                    return null;
                }
                return {
                    id: generateId(prefix),
                    text,
                    author: fallbackAuthor,
                    date: new Date().toISOString()
                };
            }

            if (typeof note === 'object') {
                const text = typeof note.text === 'string' ? note.text.trim() : '';
                if (!text.length) {
                    return null;
                }

                return {
                    id: typeof note.id === 'string' && note.id.trim().length ? note.id : generateId(prefix),
                    text,
                    author: typeof note.author === 'string' && note.author.trim().length ? note.author.trim() : fallbackAuthor,
                    date: typeof note.date === 'string' && note.date ? note.date : new Date().toISOString()
                };
            }

            return null;
        }

        function upgradeDataStructure(data) {
            if (!data || typeof data !== 'object') {
                return deepClone(defaultData);
            }

            if (!Array.isArray(data.leads)) {
                data.leads = [];
            } else {
                data.leads = data.leads
                    .filter(lead => lead && typeof lead === 'object')
                    .map(lead => {
                        const normalizedLead = { ...lead };
                        normalizedLead.attachments = Array.isArray(lead.attachments)
                            ? lead.attachments.map(file => normalizeAttachment(file, 'file')).filter(Boolean)
                            : [];
                        normalizedLead.notes = Array.isArray(lead.notes)
                            ? lead.notes.map(note => normalizeNote(note, 'note', lead.owner || 'CRM')).filter(Boolean)
                            : typeof lead.notes === 'string'
                                ? [normalizeNote(lead.notes, 'note', lead.owner || 'CRM')].filter(Boolean)
                                : [];
                        if (!Array.isArray(normalizedLead.timeline)) {
                            normalizedLead.timeline = [];
                        }
                        return normalizedLead;
                    });
            }

            data.projects = Array.isArray(data.projects)
                ? data.projects.map(normalizeProject).filter(Boolean)
                : [];

            data.contacts = Array.isArray(data.contacts)
                ? data.contacts.map(normalizeContact).filter(Boolean)
                : [];

            data.tasks = Array.isArray(data.tasks)
                ? data.tasks.map(normalizeTask).filter(Boolean)
                : [];

            data.fileLibrary = Array.isArray(data.fileLibrary)
                ? data.fileLibrary.map(normalizeFileSnapshot).filter(Boolean)
                : [];

            data.fileSources = Array.isArray(data.fileSources)
                ? data.fileSources.map(normalizeFileSource).filter(Boolean)
                : deepClone(defaultData.fileSources);

            if (!data.roles || typeof data.roles !== 'object') {
                data.roles = deepClone(defaultData.roles);
            }

            data.roles.customRoles = Array.isArray(data.roles.customRoles)
                ? data.roles.customRoles.map(role => normalizeRoleDefinition(role, true)).filter(Boolean)
                : [];

            data.roles.assignments = Array.isArray(data.roles.assignments)
                ? data.roles.assignments.map(normalizeRoleAssignment).filter(Boolean)
                : [];

            const existingNames = new Set(data.roles.assignments.map(item => item.name));
            TEAM_MEMBERS.forEach(memberName => {
                if (!existingNames.has(memberName)) {
                    const fallbackAssignment = normalizeRoleAssignment({
                        id: generateId('member'),
                        name: memberName,
                        roleId: memberName === CURRENT_USER.name ? CURRENT_USER.role : 'manager',
                        responsibilities: ['Доступ до CRM'],
                        updatedAt: new Date().toISOString(),
                        updatedBy: 'Система'
                    });
                    data.roles.assignments.push(fallbackAssignment);
                    existingNames.add(memberName);
                }
            });

            let ownerAssignment = data.roles.assignments.find(item => item.roleId === 'owner');
            if (!ownerAssignment && data.roles.assignments.length) {
                ownerAssignment = data.roles.assignments[0];
                ownerAssignment.roleId = 'owner';
                ownerAssignment.updatedAt = new Date().toISOString();
                ownerAssignment.updatedBy = 'Система';
            }

            const currentAssignment = data.roles.assignments.find(item => item.name === CURRENT_USER.name);
            if (currentAssignment) {
                CURRENT_USER.role = currentAssignment.roleId;
            }

            return data;
        }

        function normalizeProject(project) {
            if (!project || typeof project !== 'object') {
                return null;
            }

            const team = Array.isArray(project.team)
                ? project.team.map(member => typeof member === 'string' ? member.trim() : String(member || '').trim()).filter(Boolean)
                : typeof project.team === 'string' && project.team.trim().length
                    ? project.team.split(',').map(member => member.trim()).filter(Boolean)
                    : [];

            const tags = Array.isArray(project.tags)
                ? project.tags.map(tag => typeof tag === 'string' ? tag.trim() : String(tag || '').trim()).filter(Boolean)
                : typeof project.tags === 'string' && project.tags.trim().length
                    ? project.tags.split(',').map(tag => tag.trim()).filter(Boolean)
                    : [];

            const stage = typeof project.stage === 'string' && project.stage.trim()
                ? project.stage.trim()
                : PROJECT_STAGES[0];

            const createdAt = typeof project.createdAt === 'string' && project.createdAt
                ? project.createdAt
                : new Date().toISOString();
            const updatedAt = typeof project.updatedAt === 'string' && project.updatedAt
                ? project.updatedAt
                : createdAt;
            const description = typeof project.description === 'string' && project.description.trim().length
                ? project.description.trim()
                : typeof project.summary === 'string'
                    ? project.summary.trim()
                    : '';
            const attachments = Array.isArray(project.attachments)
                ? project.attachments.map(file => normalizeAttachment(file, 'projectfile')).filter(Boolean)
                : [];
            const notes = Array.isArray(project.notes)
                ? project.notes.map(note => normalizeNote(note, 'pnote', project.owner || 'CRM')).filter(Boolean)
                : typeof project.notes === 'string'
                    ? [normalizeNote(project.notes, 'pnote', project.owner || 'CRM')].filter(Boolean)
                    : [];

            return {
                id: typeof project.id === 'string' && project.id ? project.id : generateId('project'),
                name: typeof project.name === 'string' && project.name.trim() ? project.name.trim() : 'Новий проект',
                company: typeof project.company === 'string' ? project.company.trim() : '',
                stage,
                budget: Number(project.budget) || 0,
                probability: Math.max(0, Math.min(100, Number(project.probability) || 0)),
                owner: typeof project.owner === 'string' ? project.owner.trim() : '',
                contact: typeof project.contact === 'string' ? project.contact.trim() : '',
                team,
                tags,
                description,
                notes,
                attachments,
                createdAt,
                updatedAt
            };
        }

        function normalizeContact(contact) {
            if (!contact || typeof contact !== 'object') {
                return null;
            }

            const id = typeof contact.id === 'string' && contact.id.trim().length ? contact.id.trim() : generateId('contact');
            const name = typeof contact.name === 'string' && contact.name.trim().length ? contact.name.trim() : 'Новий контакт';
            const company = typeof contact.company === 'string' ? contact.company.trim() : '';
            const role = typeof contact.role === 'string' ? contact.role.trim() : '';
            const email = typeof contact.email === 'string' ? contact.email.trim() : '';
            const phone = typeof contact.phone === 'string' ? contact.phone.trim() : '';
            const status = typeof contact.status === 'string' && STATUS_LABELS[contact.status] ? contact.status : 'potential';
            const owner = typeof contact.owner === 'string' && contact.owner.trim().length ? contact.owner.trim() : CURRENT_USER.name;
            const tags = Array.isArray(contact.tags)
                ? contact.tags.map(tag => typeof tag === 'string' ? tag.trim() : String(tag || '').trim()).filter(Boolean)
                : typeof contact.tags === 'string' && contact.tags.trim().length
                    ? contact.tags.split(',').map(tag => tag.trim()).filter(Boolean)
                    : [];
            const attachments = Array.isArray(contact.attachments)
                ? contact.attachments.map(file => normalizeAttachment(file, 'contactfile')).filter(Boolean)
                : [];
            const notes = Array.isArray(contact.notes)
                ? contact.notes.map(note => normalizeNote(note, 'cnote', owner)).filter(Boolean)
                : typeof contact.notes === 'string'
                    ? [normalizeNote(contact.notes, 'cnote', owner)].filter(Boolean)
                    : [];
            const lastActivity = typeof contact.lastActivity === 'string' && contact.lastActivity
                ? contact.lastActivity
                : new Date().toISOString();

            return {
                id,
                name,
                company,
                role,
                email,
                phone,
                status,
                owner,
                tags,
                attachments,
                notes,
                lastActivity
            };
        }

        function normalizeTask(task) {
            if (!task || typeof task !== 'object') {
                return null;
            }

            const id = typeof task.id === 'string' && task.id.trim().length ? task.id.trim() : generateId('task');
            const title = typeof task.title === 'string' && task.title.trim().length ? task.title.trim() : 'Нове завдання';
            const owner = typeof task.owner === 'string' && task.owner.trim().length ? task.owner.trim() : CURRENT_USER.name;
            const dueDate = typeof task.dueDate === 'string' ? task.dueDate : '';
            const allowedStatuses = TASK_COLUMNS.map(column => column.id);
            const status = allowedStatuses.includes(task.status) ? task.status : 'todo';
            const priority = ['high', 'medium', 'low'].includes(task.priority) ? task.priority : 'medium';
            const relatedLeadId = typeof task.relatedLeadId === 'string' ? task.relatedLeadId : '';
            const description = typeof task.description === 'string' ? task.description.trim() : '';
            const tags = Array.isArray(task.tags)
                ? task.tags.map(tag => typeof tag === 'string' ? tag.trim() : String(tag || '').trim()).filter(Boolean)
                : typeof task.tags === 'string' && task.tags.trim().length
                    ? task.tags.split(',').map(tag => tag.trim()).filter(Boolean)
                    : [];
            const attachments = Array.isArray(task.attachments)
                ? task.attachments.map(file => normalizeAttachment(file, 'taskfile')).filter(Boolean)
                : [];
            const createdAt = typeof task.createdAt === 'string' && task.createdAt ? task.createdAt : new Date().toISOString();

            const normalizedTask = {
                id,
                title,
                owner,
                dueDate,
                priority,
                status,
                relatedLeadId,
                description,
                tags,
                attachments,
                createdAt
            };

            if (task.completedAt) {
                normalizedTask.completedAt = task.completedAt;
            }

            return normalizedTask;
        }

        function normalizeRoleDefinition(role, isCustom = false) {
            if (!role || typeof role !== 'object') {
                return null;
            }

            const id = typeof role.id === 'string' && role.id.trim().length ? role.id.trim() : generateId('role');
            const name = typeof role.name === 'string' && role.name.trim().length ? role.name.trim() : 'Нова роль';
            const badge = typeof role.badge === 'string' && role.badge.trim().length ? role.badge.trim() : name;
            const description = typeof role.description === 'string' ? role.description.trim() : '';
            const permissions = Array.isArray(role.permissions)
                ? role.permissions.map(item => typeof item === 'string' ? item.trim() : String(item || '').trim()).filter(Boolean)
                : [];
            const limitations = Array.isArray(role.limitations)
                ? role.limitations.map(item => typeof item === 'string' ? item.trim() : String(item || '').trim()).filter(Boolean)
                : [];
            const baseRoleId = typeof role.baseRoleId === 'string' && role.baseRoleId.trim().length ? role.baseRoleId.trim() : null;
            const createdAt = typeof role.createdAt === 'string' && role.createdAt ? role.createdAt : new Date().toISOString();
            const createdBy = typeof role.createdBy === 'string' && role.createdBy.trim().length ? role.createdBy.trim() : 'Система';
            const custom = isCustom || Boolean(role.custom);

            return {
                id,
                name,
                badge,
                description,
                permissions,
                limitations,
                baseRoleId,
                createdAt,
                createdBy,
                custom
            };
        }

        function normalizeRoleAssignment(assignment) {
            if (!assignment || typeof assignment !== 'object') {
                return null;
            }

            const name = typeof assignment.name === 'string' && assignment.name.trim().length ? assignment.name.trim() : '';
            if (!name) {
                return null;
            }

            const id = typeof assignment.id === 'string' && assignment.id.trim().length ? assignment.id.trim() : generateId('member');
            const email = typeof assignment.email === 'string' ? assignment.email.trim() : '';
            const department = typeof assignment.department === 'string' ? assignment.department.trim() : '';
            const title = typeof assignment.title === 'string' ? assignment.title.trim() : '';
            const phone = typeof assignment.phone === 'string' ? assignment.phone.trim() : '';
            const roleId = typeof assignment.roleId === 'string' && assignment.roleId.trim().length ? assignment.roleId.trim() : 'manager';
            const responsibilities = Array.isArray(assignment.responsibilities)
                ? assignment.responsibilities.map(item => typeof item === 'string' ? item.trim() : String(item || '').trim()).filter(Boolean)
                : typeof assignment.responsibilities === 'string' && assignment.responsibilities.trim().length
                    ? assignment.responsibilities.split(',').map(item => item.trim()).filter(Boolean)
                    : [];
            const note = typeof assignment.note === 'string' ? assignment.note.trim() : '';
            const updatedAt = typeof assignment.updatedAt === 'string' && assignment.updatedAt ? assignment.updatedAt : new Date().toISOString();
            const updatedBy = typeof assignment.updatedBy === 'string' && assignment.updatedBy.trim().length ? assignment.updatedBy.trim() : 'Система';
            const locked = Boolean(assignment.locked);

            return {
                id,
                name,
                email,
                department,
                title,
                phone,
                roleId,
                responsibilities,
                note,
                updatedAt,
                updatedBy,
                locked
            };
        }

        function getRoleDefinition(roleId) {
            if (!roleId) {
                return null;
            }

            const baseRole = ROLE_DEFINITIONS.find(role => role.id === roleId);
            if (baseRole) {
                return {
                    id: baseRole.id,
                    name: baseRole.name,
                    badge: baseRole.badge,
                    description: baseRole.description,
                    permissions: Array.isArray(baseRole.permissions) ? [...baseRole.permissions] : [],
                    limitations: Array.isArray(baseRole.limitations) ? [...baseRole.limitations] : [],
                    baseRoleId: baseRole.baseRoleId || null,
                    createdAt: baseRole.createdAt || '',
                    createdBy: 'Система',
                    custom: false
                };
            }

            if (crmData && crmData.roles && Array.isArray(crmData.roles.customRoles)) {
                const customRole = crmData.roles.customRoles.find(role => role.id === roleId);
                if (customRole) {
                    return normalizeRoleDefinition(customRole, true);
                }
            }

            return null;
        }

        function getAllRoleDefinitions() {
            const baseRoles = ROLE_DEFINITIONS.map(role => ({
                id: role.id,
                name: role.name,
                badge: role.badge,
                description: role.description,
                permissions: Array.isArray(role.permissions) ? [...role.permissions] : [],
                limitations: Array.isArray(role.limitations) ? [...role.limitations] : [],
                baseRoleId: role.baseRoleId || null,
                createdAt: role.createdAt || '',
                createdBy: 'Система',
                custom: false
            }));

            const customRoles = crmData && crmData.roles && Array.isArray(crmData.roles.customRoles)
                ? crmData.roles.customRoles.map(role => normalizeRoleDefinition(role, true)).filter(Boolean)
                : [];

            return [...baseRoles, ...customRoles];
        }

        function getRoleLabel(roleId) {
            const definition = getRoleDefinition(roleId);
            return definition ? definition.name : roleId;
        }

        function getInitials(value) {
            if (!value || typeof value !== 'string') {
                return '—';
            }

            const parts = value.split(/\s+/).filter(Boolean);
            if (!parts.length) {
                return value.charAt(0).toUpperCase();
            }

            return parts
                .slice(0, 2)
                .map(part => part.charAt(0).toUpperCase())
                .join('');
        }

        function updateCustomRoleBaseOptions() {
            const select = document.getElementById('customRoleBase');
            if (!select) {
                return;
            }

            const roles = getAllRoleDefinitions();
            const previousValue = select.value;
            select.innerHTML = roles.map(role => `<option value="${role.id}">${escapeHtml(role.name)}</option>`).join('');

            if (roles.some(role => role.id === previousValue)) {
                select.value = previousValue;
            } else if (roles.some(role => role.id === 'manager')) {
                select.value = 'manager';
            } else if (roles.length) {
                select.value = roles[0].id;
            }
        }

        function updateCurrentUserBadge() {
            const badge = document.getElementById('currentUserBadge');
            const nameElement = document.getElementById('currentUserName');
            if (!badge || !nameElement) {
                return;
            }

            const assignment = crmData && crmData.roles && Array.isArray(crmData.roles.assignments)
                ? crmData.roles.assignments.find(item => item.name === CURRENT_USER.name)
                : null;
            const roleId = assignment ? assignment.roleId : CURRENT_USER.role;
            const roleLabel = getRoleLabel(roleId);

            nameElement.textContent = assignment
                ? `${assignment.name} • ${roleLabel}`
                : `${CURRENT_USER.name} • ${roleLabel}`;
            badge.dataset.role = roleId;
            badge.title = `Поточна роль: ${roleLabel}`;
        }

        function normalizeFileSource(source) {
            if (!source || typeof source !== 'object') {
                return null;
            }

            const id = typeof source.id === 'string' && source.id.trim().length
                ? source.id.trim()
                : generateId('source');
            const typeValue = typeof source.type === 'string' ? source.type.toLowerCase() : '';
            const type = typeValue === 'cloud' ? 'cloud' : 'local';

            let status = typeof source.status === 'string' ? source.status.toLowerCase() : '';
            let connected = typeof source.connected === 'boolean' ? source.connected : status === 'online';

            if (status === 'syncing') {
                connected = true;
            }

            if (!['online', 'offline', 'syncing'].includes(status)) {
                status = connected ? 'online' : 'offline';
            }

            if (!connected && status === 'online') {
                connected = true;
            }

            return {
                id,
                name: typeof source.name === 'string' && source.name.trim().length ? source.name.trim() : 'Джерело файлів',
                type,
                path: typeof source.path === 'string' ? source.path : '',
                provider: typeof source.provider === 'string' ? source.provider : '',
                status,
                connected,
                autoSync: 'autoSync' in source ? Boolean(source.autoSync) : type === 'cloud',
                totalFiles: Math.max(0, Number(source.totalFiles) || 0),
                totalFolders: Math.max(0, Number(source.totalFolders) || 0),
                totalSize: Math.max(0, Number(source.totalSize) || 0),
                lastSynced: typeof source.lastSynced === 'string' && source.lastSynced ? source.lastSynced : null,
                snapshotId: typeof source.snapshotId === 'string' && source.snapshotId ? source.snapshotId : null,
                favorite: Boolean(source.favorite)
            };
        }

        function loadData() {
            let saved = null;

            if (persistentStorage && canPersistData) {
                try {
                    saved = persistentStorage.getItem(STORAGE_KEY);
                } catch (error) {
                    canPersistData = false;
                    console.warn('Локальне сховище недоступне. Дані CRM будуть збережені лише в межах поточної сесії.', error);
                }
            }

            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed && typeof parsed === 'object') {
                        return upgradeDataStructure(parsed);
                    }
                } catch (error) {
                    console.warn('Не вдалося прочитати збережені дані CRM, використовую демо-набір.', error);
                }
            }
            return upgradeDataStructure(deepClone(defaultData));
        }

        function saveData() {
            if (!persistentStorage || !canPersistData) {
                return;
            }

            try {
                persistentStorage.setItem(STORAGE_KEY, JSON.stringify(crmData));
            } catch (error) {
                canPersistData = false;
                console.warn('Не вдалося зберегти дані CRM. Інформація буде доступна лише до перезавантаження сторінки.', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            crmData = loadData();
            const snapshots = Array.isArray(crmData.fileLibrary) ? crmData.fileLibrary : [];
            const linkedSnapshot = Array.isArray(crmData.fileSources)
                ? snapshots.find(snapshot => crmData.fileSources.some(source => source.snapshotId === snapshot.id))
                : null;
            const fallbackSnapshot = snapshots.length ? snapshots[0] : null;
            const initialSnapshot = linkedSnapshot || fallbackSnapshot;
            activeFileSnapshotId = initialSnapshot ? initialSnapshot.id : null;
            const initialSource = Array.isArray(crmData.fileSources)
                ? crmData.fileSources.find(source => source.snapshotId === activeFileSnapshotId) || null
                : null;
            activeFileSourceId = initialSource ? initialSource.id : null;
            pendingFileSourceId = null;
            setupUI();
            renderAll();
        });

        function setupUI() {
            populateDropdowns();
            setupNavigation();
            setupModals();
            setupForms();
            initializeAttachmentAreas();
            setupSearch();
            setupFilters();
            setupFileLibrary();
            setupRoleManagement();
            document.getElementById('resetDataBtn').addEventListener('click', resetDemoData);
            document.getElementById('refreshDashboardBtn').addEventListener('click', () => {
                renderDashboard();
                renderAnalytics();
            });
            document.getElementById('openLeadModalBtn').addEventListener('click', () => openModal('addLeadModal'));
            document.getElementById('addPipelineLeadBtn').addEventListener('click', () => openModal('addLeadModal'));
            document.getElementById('openContactModalBtn').addEventListener('click', () => openModal('addContactModal'));
            document.getElementById('openTaskModalBtn').addEventListener('click', () => openTaskModal());
            const projectModalBtn = document.getElementById('openProjectModalBtn');
            if (projectModalBtn) {
                projectModalBtn.addEventListener('click', () => openModal('addProjectModal'));
            }
        }

        function populateDropdowns() {
            const stageSelect = document.getElementById('leadStage');
            stageSelect.innerHTML = STAGES.filter(stage => stage !== 'Втрачено').map(stage => `<option value="${stage}">${stage}</option>`).join('');

            const ownerSelects = [
                document.getElementById('leadOwner'),
                document.getElementById('contactOwner'),
                document.getElementById('taskOwner'),
                document.getElementById('projectOwner')
            ].filter(Boolean);

            ownerSelects.forEach(select => {
                select.innerHTML = TEAM_MEMBERS.map(member => `<option value="${member}">${member}</option>`).join('');
            });

            const projectStageSelect = document.getElementById('projectStage');
            if (projectStageSelect) {
                projectStageSelect.innerHTML = PROJECT_STAGES.map(stage => `<option value="${stage}">${stage}</option>`).join('');
            }

            const projectTeamSelect = document.getElementById('projectTeam');
            if (projectTeamSelect) {
                projectTeamSelect.innerHTML = TEAM_MEMBERS.map(member => `<option value="${member}">${member}</option>`).join('');
            }

            const projectStageFilterSelect = document.getElementById('projectStageFilter');
            if (projectStageFilterSelect) {
                const options = ['<option value="all">Всі етапи</option>', ...PROJECT_STAGES.map(stage => `<option value="${stage}">${stage}</option>`)];
                projectStageFilterSelect.innerHTML = options.join('');
                projectStageFilterSelect.value = PROJECT_STAGES.includes(projectStageFilter) ? projectStageFilter : 'all';
            }

            const pipelineFilter = document.getElementById('pipelineOwnerFilter');
            if (pipelineFilter) {
                pipelineFilter.innerHTML = '<option value="all">Всі менеджери</option>';
                TEAM_MEMBERS.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    pipelineFilter.appendChild(option);
                });
                pipelineFilter.value = pipelineFilterOwner;
            }

            updateTaskLeadOptions();
        }

        function updateTaskLeadOptions() {
            const taskLeadSelect = document.getElementById('taskLead');
            const options = [`<option value="">Без прив'язки</option>`];
            crmData.leads.forEach(lead => {
                options.push(`<option value="${lead.id}">${lead.name} (${lead.company})</option>`);
            });
            taskLeadSelect.innerHTML = options.join('');
        }

        function setupNavigation() {
            const nav = document.getElementById('mainNav');
            if (!nav) {
                return;
            }

            const navItems = Array.from(nav.querySelectorAll('.nav-item'));
            const navGroups = Array.from(nav.querySelectorAll('.nav-group'));
            const searchInput = document.getElementById('navSearch');
            const filterSelect = document.getElementById('navFilter');

            navigationState.search = searchInput ? searchInput.value || '' : '';
            navigationState.filter = filterSelect ? filterSelect.value || 'all' : 'all';

            const emptyState = document.createElement('div');
            emptyState.className = 'nav-empty';
            emptyState.setAttribute('role', 'status');
            emptyState.setAttribute('aria-live', 'polite');
            emptyState.setAttribute('aria-hidden', 'true');
            emptyState.textContent = 'Немає модулів за вашим запитом.';
            nav.appendChild(emptyState);

            const activateItem = item => {
                const target = item.dataset.sectionTarget;
                if (!target) {
                    return;
                }

                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                const section = document.getElementById(target);
                if (section) {
                    section.classList.add('active');
                }

                navItems.forEach(btn => btn.classList.remove('active'));
                item.classList.add('active');
            };

            navItems.forEach(item => {
                item.addEventListener('click', () => activateItem(item));
            });

            applyNavigationFilters = () => {
                const searchTerm = navigationState.search.trim().toLowerCase();
                const filterValue = navigationState.filter;
                let visibleCount = 0;

                navItems.forEach(item => {
                    const text = (item.textContent || '').toLowerCase();
                    const keywords = (item.dataset.navKeywords || '').toLowerCase();
                    const categories = (item.dataset.navCategory || '').split(/\s+/).filter(Boolean);
                    const matchesSearch = !searchTerm || text.includes(searchTerm) || keywords.includes(searchTerm);
                    const matchesFilter = filterValue === 'all' || categories.includes(filterValue);
                    const isVisible = matchesSearch && matchesFilter;

                    item.classList.toggle('is-hidden', !isVisible);
                    item.setAttribute('aria-hidden', isVisible ? 'false' : 'true');
                    if (isVisible) {
                        item.removeAttribute('tabindex');
                        visibleCount += 1;
                    } else {
                        item.setAttribute('tabindex', '-1');
                    }
                });

                navGroups.forEach(group => {
                    const hasVisible = Array.from(group.querySelectorAll('.nav-item')).some(item => !item.classList.contains('is-hidden'));
                    group.classList.toggle('is-collapsed', !hasVisible);
                });

                if (visibleCount === 0) {
                    emptyState.classList.add('is-visible');
                    emptyState.setAttribute('aria-hidden', 'false');
                } else {
                    emptyState.classList.remove('is-visible');
                    emptyState.setAttribute('aria-hidden', 'true');
                }
            };

            if (searchInput) {
                searchInput.addEventListener('input', event => {
                    navigationState.search = event.target.value;
                    applyNavigationFilters();
                });
            }

            if (filterSelect) {
                filterSelect.addEventListener('change', event => {
                    navigationState.filter = event.target.value;
                    applyNavigationFilters();
                });
            }

            applyNavigationFilters();
        }

        function setupModals() {
            document.querySelectorAll('[data-close]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.closest('.modal');
                    if (modal) closeModal(modal.id);
                });
            });

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', event => {
                    if (event.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
        }

        function setupForms() {
            document.getElementById('leadForm').addEventListener('submit', handleLeadSubmit);
            document.getElementById('contactForm').addEventListener('submit', handleContactSubmit);
            document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);
            const projectForm = document.getElementById('projectForm');
            if (projectForm) {
                projectForm.addEventListener('submit', handleProjectSubmit);
            }
        }

        function initializeAttachmentAreas() {
            const areas = [
                {
                    key: 'lead',
                    dropzoneId: 'leadFileDropzone',
                    inputId: 'leadFiles',
                    browseButtonId: 'leadFileBrowseBtn',
                    listId: 'leadFileList',
                    progressId: 'leadUploadProgress',
                    progressBarId: 'leadUploadBar',
                    progressLabelId: 'leadUploadLabel',
                    progressTextId: 'leadUploadText',
                    allowDirectories: true,
                    emptyText: 'Файли ще не обрано.'
                },
                {
                    key: 'project',
                    dropzoneId: 'projectFileDropzone',
                    inputId: 'projectFiles',
                    browseButtonId: 'projectFileBrowseBtn',
                    listId: 'projectFileList',
                    progressId: 'projectUploadProgress',
                    progressBarId: 'projectUploadBar',
                    progressLabelId: 'projectUploadLabel',
                    progressTextId: 'projectUploadText',
                    allowDirectories: false,
                    emptyText: 'Документи проекту ще не додано.'
                },
                {
                    key: 'contact',
                    dropzoneId: 'contactFileDropzone',
                    inputId: 'contactFiles',
                    browseButtonId: 'contactFileBrowseBtn',
                    listId: 'contactFileList',
                    progressId: 'contactUploadProgress',
                    progressBarId: 'contactUploadBar',
                    progressLabelId: 'contactUploadLabel',
                    progressTextId: 'contactUploadText',
                    allowDirectories: false,
                    emptyText: 'Прикріпіть договори чи листування.'
                },
                {
                    key: 'task',
                    dropzoneId: 'taskFileDropzone',
                    inputId: 'taskFiles',
                    browseButtonId: 'taskFileBrowseBtn',
                    listId: 'taskFileList',
                    progressId: 'taskUploadProgress',
                    progressBarId: 'taskUploadBar',
                    progressLabelId: 'taskUploadLabel',
                    progressTextId: 'taskUploadText',
                    allowDirectories: false,
                    emptyText: 'Матеріали для завдання ще не додані.'
                }
            ];

            areas.forEach(area => registerAttachmentArea(area.key, area));
        }

        function getAttachmentState(areaKey) {
            return attachmentAreas[areaKey] || null;
        }

        function registerAttachmentArea(areaKey, config) {
            const dropzone = document.getElementById(config.dropzoneId);
            const input = document.getElementById(config.inputId);
            const list = document.getElementById(config.listId);

            if (!dropzone || !input || !list) {
                return;
            }

            const area = {
                key: areaKey,
                dropzone,
                input,
                list,
                files: [],
                progress: new Map(),
                uploading: false,
                options: {
                    allowDirectories: config.allowDirectories !== false,
                    maxItemSize: config.maxItemSize || MAX_ATTACHMENT_SIZE,
                    maxTotalSize: config.maxTotalSize || MAX_TOTAL_ATTACHMENTS_SIZE,
                    emptyText: config.emptyText || 'Файли ще не обрано.'
                },
                browseButton: config.browseButtonId ? document.getElementById(config.browseButtonId) : null,
                progressContainer: config.progressId ? document.getElementById(config.progressId) : null,
                progressBar: config.progressBarId ? document.getElementById(config.progressBarId) : null,
                progressLabel: config.progressLabelId ? document.getElementById(config.progressLabelId) : null,
                progressText: config.progressTextId ? document.getElementById(config.progressTextId) : null
            };

            attachmentAreas[areaKey] = area;

            const openPicker = () => input.click();

            if (area.browseButton) {
                area.browseButton.addEventListener('click', event => {
                    event.stopPropagation();
                    openPicker();
                });
            }

            dropzone.addEventListener('click', event => {
                if (!event.target.closest('.file-browse-btn')) {
                    openPicker();
                }
            });

            dropzone.addEventListener('keydown', event => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openPicker();
                }
            });

            input.addEventListener('change', event => {
                const files = event.target.files;
                if (files && files.length) {
                    const normalized = Array.from(files).map(file =>
                        setFileRelativePath(file, file.webkitRelativePath || file.name)
                    );
                    addFilesToAttachmentArea(areaKey, normalized);
                    event.target.value = '';
                }
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, event => {
                    event.preventDefault();
                    event.stopPropagation();
                    dropzone.classList.add('dragover');
                });
            });

            ['dragleave', 'dragend'].forEach(eventName => {
                dropzone.addEventListener(eventName, event => {
                    if (eventName === 'dragleave' && event.relatedTarget && dropzone.contains(event.relatedTarget)) {
                        return;
                    }
                    dropzone.classList.remove('dragover');
                });
            });

            dropzone.addEventListener('drop', async event => {
                event.preventDefault();
                dropzone.classList.remove('dragover');

                const dataTransfer = event.dataTransfer;
                if (!dataTransfer) {
                    return;
                }

                try {
                    let files = [];
                    if (area.options.allowDirectories && dataTransfer.items && dataTransfer.items.length) {
                        files = await extractFilesFromDataTransferItems(dataTransfer.items);
                    }

                    if ((!files || !files.length) && dataTransfer.files?.length) {
                        files = Array.from(dataTransfer.files).map(file =>
                            setFileRelativePath(file, file.webkitRelativePath || file.name)
                        );
                    }

                    if (files.length) {
                        addFilesToAttachmentArea(areaKey, files);
                    }
                } catch (error) {
                    console.warn('Не вдалося обробити файли з папки', error);
                }
            });

            renderAttachmentArea(areaKey);
        }

        function addFilesToAttachmentArea(areaKey, files) {
            const area = getAttachmentState(areaKey);
            if (!area || !Array.isArray(files) || !files.length) {
                return;
            }

            const existing = new Set(area.files.map(getFileKey));
            files.forEach(file => {
                const key = getFileKey(file);
                if (!existing.has(key)) {
                    area.files.push(file);
                    existing.add(key);
                }
            });

            renderAttachmentArea(areaKey);
        }

        function renderAttachmentArea(areaKey) {
            const area = getAttachmentState(areaKey);
            if (!area) {
                return;
            }

            const { list, dropzone, files, options } = area;
            if (!list) {
                return;
            }

            if (files.length === 0) {
                list.innerHTML = `<div class="file-empty">${options.emptyText}</div>`;
            } else {
                list.innerHTML = files.map((file, index) => {
                    const displayName = typeof file?.name === 'string' && file.name.length ? file.name : 'Файл';
                    const relativePathRaw = getFileRelativePath(file);
                    const safeName = escapeHtml(displayName);
                    const safePath = relativePathRaw && relativePathRaw !== displayName ? escapeHtml(relativePathRaw) : '';
                    const sizeLabel = formatBytes(Number(file.size) || 0);
                    const metaText = safePath ? `${safePath} • ${sizeLabel}` : sizeLabel;
                    const icon = getAttachmentIcon(file.type);
                    const key = getFileKey(file);
                    return `
                        <div class="file-item">
                            <div class="file-item-info">
                                <div class="file-icon"><i class="fa-solid ${icon}"></i></div>
                                <div>
                                    <strong>${safeName}</strong>
                                    <div class="file-meta">${metaText}</div>
                                </div>
                            </div>
                            <button type="button" class="file-remove" data-remove="${index}" aria-label="Видалити файл ${safeName}">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                            <div class="file-progress" data-progress-key="${key}">
                                <div class="file-progress-track"><div class="file-progress-value"></div></div>
                                <span class="file-progress-label">0%</span>
                            </div>
                        </div>
                    `;
                }).join('');

                list.querySelectorAll('[data-remove]').forEach(btn => {
                    btn.addEventListener('click', event => {
                        event.stopPropagation();
                        const index = Number(btn.dataset.remove);
                        removeAttachmentFromArea(areaKey, index);
                    });
                });
            }

            if (dropzone) {
                dropzone.classList.toggle('has-files', files.length > 0);
            }

            updateAttachmentProgressSummary(areaKey);
        }

        function removeAttachmentFromArea(areaKey, index) {
            const area = getAttachmentState(areaKey);
            if (!area || !Number.isInteger(index) || index < 0 || index >= area.files.length) {
                return;
            }

            const [removed] = area.files.splice(index, 1);
            if (removed) {
                area.progress.delete(getFileKey(removed));
            }

            renderAttachmentArea(areaKey);
        }

        function resetAttachmentArea(areaKey) {
            const area = getAttachmentState(areaKey);
            if (!area) {
                return;
            }

            area.files = [];
            area.progress.clear();
            area.uploading = false;
            if (area.input) {
                area.input.value = '';
            }
            renderAttachmentArea(areaKey);
        }

        function updateAttachmentProgressUI(areaKey, fileKey) {
            const area = getAttachmentState(areaKey);
            if (!area) {
                return;
            }

            const entry = area.progress.get(fileKey);
            const progressElement = area.list ? area.list.querySelector(`.file-progress[data-progress-key="${fileKey}"]`) : null;
            if (progressElement && entry) {
                const valueEl = progressElement.querySelector('.file-progress-value');
                const labelEl = progressElement.querySelector('.file-progress-label');
                const percent = entry.total ? Math.min(100, Math.round((entry.loaded / entry.total) * 100)) : 0;
                if (valueEl) {
                    valueEl.style.width = `${percent}%`;
                }
                if (labelEl) {
                    labelEl.textContent = `${percent}%`;
                }
            }

            updateAttachmentProgressSummary(areaKey);
        }

        function updateAttachmentProgressSummary(areaKey) {
            const area = getAttachmentState(areaKey);
            if (!area || !area.progressContainer) {
                return;
            }

            const { progressContainer, progressBar, progressLabel, progressText, files, progress, uploading } = area;

            if (!files.length) {
                progressContainer.classList.remove('active');
                if (progressBar) {
                    progressBar.style.width = '0%';
                }
                if (progressLabel) {
                    progressLabel.textContent = 'Готово';
                }
                if (progressText) {
                    progressText.textContent = 'Очікування файлів…';
                }
                return;
            }

            const totalBytes = files.reduce((sum, file) => sum + (Number(file.size) || 0), 0);
            const loadedBytes = Array.from(progress.values()).reduce((sum, entry) => sum + Math.min(entry.loaded, entry.total || 0), 0);
            const percent = totalBytes > 0 ? Math.min(100, Math.round((loadedBytes / totalBytes) * 100)) : (uploading ? 0 : 100);
            const finished = Array.from(progress.values()).filter(entry => entry.total && entry.loaded >= entry.total).length;

            if (progressBar) {
                progressBar.style.width = `${percent}%`;
            }
            if (progressLabel) {
                progressLabel.textContent = `${percent}%`;
            }
            if (progressText) {
                if (uploading) {
                    progressText.textContent = `Опрацьовано ${finished}/${files.length} файлів`;
                } else if (finished === files.length) {
                    progressText.textContent = `Додано ${files.length} файл(и)`;
                } else {
                    progressText.textContent = `Готово до завантаження: ${files.length} файл(и)`;
                }
            }

            progressContainer.classList.add('active');
        }

        async function prepareAttachmentsForArea(areaKey) {
            const area = getAttachmentState(areaKey);
            if (!area || area.files.length === 0) {
                return [];
            }

            const attachments = [];
            const skipped = [];
            let totalSize = 0;

            area.progress.clear();
            area.uploading = true;
            updateAttachmentProgressSummary(areaKey);

            for (const file of area.files) {
                const fileSize = Number(file.size) || 0;
                const displayName = typeof file?.name === 'string' && file.name.length ? file.name : 'Файл';
                const relativePath = getFileRelativePath(file);

                if (fileSize > area.options.maxItemSize) {
                    skipped.push(`«${displayName}» перевищує обмеження ${formatBytes(area.options.maxItemSize)}.`);
                    continue;
                }

                if (totalSize + fileSize > area.options.maxTotalSize) {
                    skipped.push(`«${displayName}» не додано: перевищено загальний ліміт ${formatBytes(area.options.maxTotalSize)}.`);
                    continue;
                }

                const fileKey = getFileKey(file);
                area.progress.set(fileKey, { loaded: 0, total: fileSize });
                updateAttachmentProgressUI(areaKey, fileKey);

                try {
                    const dataUrl = await readFileAsDataURL(file, (loaded, total) => {
                        area.progress.set(fileKey, { loaded, total: total || fileSize });
                        updateAttachmentProgressUI(areaKey, fileKey);
                    });

                    attachments.push({
                        id: generateId('file'),
                        name: displayName,
                        path: relativePath || displayName,
                        size: fileSize,
                        type: file.type || 'application/octet-stream',
                        lastModified: Number(file.lastModified) || Date.now(),
                        dataUrl
                    });
                    totalSize += fileSize;
                    area.progress.set(fileKey, { loaded: fileSize, total: fileSize });
                    updateAttachmentProgressUI(areaKey, fileKey);
                } catch (error) {
                    console.error('Не вдалося прочитати файл', error);
                    skipped.push(`Сталася помилка під час читання «${displayName}».`);
                }
            }

            area.uploading = false;
            updateAttachmentProgressSummary(areaKey);

            if (skipped.length) {
                alert(`Деякі файли не були додані:\n${skipped.join('\n')}`);
            }

            return attachments;
        }

        function setFileRelativePath(file, path) {
            if (!file || typeof path !== 'string') {
                return file;
            }

            const trimmed = path.replace(/^[\\/]+/, '');
            const sanitized = trimmed.replace(/\\/g, '/');

            if (!sanitized) {
                return file;
            }

            try {
                file._relativePath = sanitized;
            } catch (error) {
                // ignore inability to attach metadata to the File object
            }

            if (!file.webkitRelativePath) {
                try {
                    Object.defineProperty(file, 'webkitRelativePath', {
                        configurable: true,
                        enumerable: false,
                        value: sanitized
                    });
                } catch (error) {
                    // Some environments expose a read-only property; ignore failures
                }
            }

            return file;
        }

        function getFileRelativePath(file) {
            if (!file || typeof file !== 'object') {
                return '';
            }

            const candidate = typeof file._relativePath === 'string' && file._relativePath.length
                ? file._relativePath
                : typeof file.webkitRelativePath === 'string' && file.webkitRelativePath.length
                    ? file.webkitRelativePath
                    : '';

            if (candidate) {
                return candidate.replace(/\\/g, '/');
            }

            return typeof file.name === 'string' ? file.name : '';
        }

        async function extractFilesFromDataTransferItems(items) {
            if (!items || typeof items.length !== 'number' || items.length === 0) {
                return [];
            }

            const collected = [];

            const processEntry = async entry => {
                if (!entry) {
                    return;
                }

                if (entry.isFile) {
                    try {
                        const file = await new Promise((resolve, reject) => entry.file(resolve, reject));
                        const relativePath = typeof entry.fullPath === 'string' && entry.fullPath.length
                            ? entry.fullPath
                            : file.webkitRelativePath || file.name;
                        collected.push(setFileRelativePath(file, relativePath));
                    } catch (error) {
                        console.warn('Не вдалося прочитати файл з папки', error);
                    }
                    return;
                }

                if (entry.isDirectory) {
                    const reader = entry.createReader();
                    while (true) {
                        const batch = await new Promise((resolve, reject) => reader.readEntries(resolve, reject));
                        if (!batch.length) {
                            break;
                        }
                        for (const subEntry of batch) {
                            await processEntry(subEntry);
                        }
                    }
                }
            };

            for (const item of Array.from(items)) {
                if (!item || item.kind !== 'file') {
                    continue;
                }

                try {
                    const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
                    if (entry) {
                        await processEntry(entry);
                    } else {
                        const file = item.getAsFile();
                        if (file) {
                            collected.push(setFileRelativePath(file, file.webkitRelativePath || file.name));
                        }
                    }
                } catch (error) {
                    console.warn('Не вдалося обробити елемент передачі файлів', error);
                }
            }

            return collected;
        }

        function getFileKey(file) {
            if (!file) {
                return '';
            }

            const relativePath = getFileRelativePath(file) || file.name || '';
            const lastModified = typeof file.lastModified === 'number' ? file.lastModified : 0;
            const size = typeof file.size === 'number' ? file.size : 0;
            return `${relativePath}__${lastModified}__${size}`;
        }

        function readFileAsDataURL(file, onProgress) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    if (typeof onProgress === 'function') {
                        try {
                            const size = Number(file?.size) || 0;
                            onProgress(size, size);
                        } catch (error) {
                            console.warn('Помилка обробки прогресу файлу', error);
                        }
                    }
                    resolve(reader.result);
                };
                reader.onerror = () => reject(reader.error || new Error('Не вдалося прочитати файл.'));
                if (typeof onProgress === 'function') {
                    reader.onprogress = event => {
                        if (event.lengthComputable) {
                            try {
                                onProgress(event.loaded, event.total || Number(file?.size) || 0);
                            } catch (error) {
                                console.warn('Помилка обробки прогресу файлу', error);
                            }
                        }
                    };
                }
                reader.readAsDataURL(file);
            });
        }

        function setupSearch() {
            const wrapper = document.getElementById('globalSearchWrapper');
            const input = document.getElementById('globalSearch');
            const results = document.getElementById('searchResults');

            input.addEventListener('input', event => {
                const value = event.target.value;
                clearTimeout(searchTimer);
                searchTimer = setTimeout(() => handleGlobalSearch(value), 180);
            });

            document.addEventListener('click', event => {
                if (!wrapper.contains(event.target)) {
                    hideSearchResults();
                }
            });
        }

        function setupFilters() {
            document.getElementById('pipelineOwnerFilter').addEventListener('change', event => {
                pipelineFilterOwner = event.target.value;
                renderPipeline();
            });

            document.getElementById('contactSearch').addEventListener('input', event => {
                renderContacts(event.target.value);
            });

            document.getElementById('contactStatusFilter').addEventListener('change', event => {
                contactStatusFilter = event.target.value;
                renderContacts(document.getElementById('contactSearch').value);
            });

            const projectStageSelect = document.getElementById('projectStageFilter');
            if (projectStageSelect) {
                projectStageSelect.addEventListener('change', event => {
                    projectStageFilter = event.target.value;
                    renderProjects(projectSearchTerm);
                });
            }

            const projectSearchInput = document.getElementById('projectSearch');
            if (projectSearchInput) {
                projectSearchInput.addEventListener('input', event => {
                    renderProjects(event.target.value);
                });
            }

            const projectProbabilityRange = document.getElementById('projectProbabilityRange');
            const probabilityLabel = document.getElementById('projectProbabilityValue');
            if (projectProbabilityRange) {
                projectProbabilityRange.addEventListener('input', event => {
                    projectMinProbability = Number(event.target.value) || 0;
                    if (probabilityLabel) {
                        probabilityLabel.textContent = `${projectMinProbability}%+`;
                    }
                    renderProjects(projectSearchTerm);
                });
            }

            if (probabilityLabel) {
                probabilityLabel.textContent = `${projectMinProbability}%+`;
            }
        }
        function setupFileLibrary() {
            const connectBtn = document.getElementById('connectFolderBtn');
            const fallbackInput = document.getElementById('folderInput');
            const searchInput = document.getElementById('fileSearchInput');
            const select = document.getElementById('folderSnapshotsSelect');

            if (connectBtn) {
                connectBtn.addEventListener('click', () => handleFolderConnect());
            }

            if (fallbackInput) {
                fallbackInput.addEventListener('change', handleFolderInputChange);
            }

            if (searchInput) {
                searchInput.value = fileSearchTerm;
                searchInput.addEventListener('input', event => {
                    fileSearchTerm = event.target.value;
                    renderFileExplorer(fileSearchTerm);
                });
            }

            if (select) {
                select.addEventListener('change', event => {
                    activeFileSnapshotId = event.target.value || null;
                    renderFileExplorer(fileSearchTerm);
                });
            }

            updateFileSnapshotsSelect();
            renderFileExplorer(fileSearchTerm);
            setupFileSources();
        }

        function setupFileSources() {
            const addCloudBtn = document.getElementById('addCloudSourceBtn');

            if (addCloudBtn && !addCloudBtn.dataset.bound) {
                addCloudBtn.addEventListener('click', () => {
                    const name = prompt('Назва каталогу (наприклад, Google Drive / Команда маркетингу)');
                    if (!name || !name.trim()) {
                        return;
                    }

                    const path = prompt('Вкажіть шлях або посилання на каталог (необов\'язково)') || '';
                    const provider = name.includes('/') ? name.split('/')[0].trim() : '';
                    const newSource = normalizeFileSource({
                        id: generateId('source'),
                        name: name.trim(),
                        type: 'cloud',
                        provider,
                        path: path.trim(),
                        status: 'offline',
                        connected: false,
                        autoSync: true,
                        totalFiles: 0,
                        totalFolders: 0,
                        totalSize: 0,
                        lastSynced: null,
                        snapshotId: null
                    });

                    if (!Array.isArray(crmData.fileSources)) {
                        crmData.fileSources = [];
                    }

                    crmData.fileSources = [newSource, ...crmData.fileSources];
                    saveData();
                    renderFileSources();
                });
                addCloudBtn.dataset.bound = 'true';
            }

            renderFileSources();
        }

        function setupRoleManagement() {
            const form = document.getElementById('customRoleForm');
            if (form && !form.dataset.bound) {
                form.addEventListener('submit', handleCustomRoleSubmit);
                form.dataset.bound = 'true';
            }

            updateCustomRoleBaseOptions();
            updateCurrentUserBadge();
        }

        function updateFileScanStatus(message) {
            const status = document.getElementById('fileScanStatus');
            if (status) {
                status.textContent = message || '';
            }
        }

        function triggerFolderFallback(sourceId = null) {
            pendingFileSourceId = sourceId;
            const fallbackInput = document.getElementById('folderInput');
            if (fallbackInput) {
                fallbackInput.click();
            }
        }

        async function handleFolderConnect(sourceId = null) {
            if (isScanningFolder) {
                return;
            }

            const source = sourceId ? getFileSourceById(sourceId) : null;
            const previousStatus = source ? source.status : null;
            const previousConnection = source ? source.connected : null;
            const previousActiveSource = activeFileSourceId;
            let snapshotStored = false;

            if (typeof window.showDirectoryPicker !== 'function') {
                triggerFolderFallback(sourceId);
                return;
            }

            const connectBtn = document.getElementById('connectFolderBtn');

            try {
                isScanningFolder = true;
                pendingFileSourceId = sourceId;
                if (source) {
                    source.status = 'syncing';
                    source.connected = true;
                    activeFileSourceId = source.id;
                    renderFileSources();
                }
                if (connectBtn) {
                    connectBtn.disabled = true;
                }
                updateFileScanStatus('Скануємо папку...');
                const snapshot = await scanDirectoryWithPicker();
                if (snapshot) {
                    snapshotStored = true;
                    storeFolderSnapshot(snapshot, sourceId);
                }
            } catch (error) {
                if (error?.name !== 'AbortError') {
                    console.error('Не вдалося прочитати вміст папки', error);
                    alert('Не вдалося прочитати вміст папки. Переконайтесь, що надали доступ, або спробуйте інший спосіб.');
                }
            } finally {
                isScanningFolder = false;
                pendingFileSourceId = null;
                if (connectBtn) {
                    connectBtn.disabled = false;
                }
                updateFileScanStatus('');
                renderFileExplorer(fileSearchTerm);
                if (source && !snapshotStored) {
                    source.status = previousStatus || (previousConnection ? 'online' : 'offline');
                    source.connected = Boolean(previousConnection);
                    activeFileSourceId = previousActiveSource;
                    renderFileSources();
                    saveData();
                }
            }
        }

        function handleFolderInputChange(event) {
            const { files } = event.target;
            if (!files || !files.length) {
                return;
            }

            const sourceId = pendingFileSourceId;
            const source = sourceId ? getFileSourceById(sourceId) : null;
            const previousStatus = source ? source.status : null;
            const previousConnection = source ? source.connected : null;
            const previousActiveSource = activeFileSourceId;
            let snapshotStored = false;
            try {
                isScanningFolder = true;
                updateFileScanStatus('Опрацьовуємо вибрані файли...');
                if (source) {
                    source.status = 'syncing';
                    source.connected = true;
                    activeFileSourceId = source.id;
                    renderFileSources();
                }
                const snapshot = buildSnapshotFromFileList(files);
                if (snapshot) {
                    snapshotStored = true;
                    storeFolderSnapshot(snapshot, sourceId);
                } else {
                    alert('Не вдалося побудувати структуру цієї папки. Спробуйте інший каталог.');
                }
            } catch (error) {
                console.error('Не вдалося обробити файли папки', error);
                alert('Не вдалося обробити вибрані файли. Будь ласка, спробуйте ще раз.');
            } finally {
                isScanningFolder = false;
                pendingFileSourceId = null;
                updateFileScanStatus('');
                event.target.value = '';
                renderFileExplorer(fileSearchTerm);
                if (source && !snapshotStored) {
                    source.status = previousStatus || (previousConnection ? 'online' : 'offline');
                    source.connected = Boolean(previousConnection);
                    activeFileSourceId = previousActiveSource;
                    renderFileSources();
                    saveData();
                }
            }
        }

        async function scanDirectoryWithPicker() {
            if (typeof window.showDirectoryPicker !== 'function') {
                return null;
            }

            const directoryHandle = await window.showDirectoryPicker();
            if (!directoryHandle) {
                return null;
            }

            const tree = await buildTreeFromDirectoryHandle(directoryHandle);
            if (!tree) {
                return null;
            }

            const snapshot = finalizeSnapshot(tree, 'picker', {
                id: generateId('folder'),
                rootName: directoryHandle.name || tree.name || 'Папка',
                scannedAt: new Date().toISOString(),
                source: 'picker'
            });

            snapshot.rootName = directoryHandle.name || snapshot.rootName;
            return snapshot;
        }

        async function buildTreeFromDirectoryHandle(directoryHandle, parentPath = '') {
            if (!directoryHandle) {
                return null;
            }

            const rootName = directoryHandle.name || 'Папка';
            const nodePath = joinPath(parentPath, rootName);
            const node = createDirectoryNode(rootName, nodePath);

            for await (const entry of directoryHandle.values()) {
                if (!entry) {
                    continue;
                }

                if (entry.kind === 'directory') {
                    const childNode = await buildTreeFromDirectoryHandle(entry, node.path);
                    if (childNode) {
                        node.children.push(childNode);
                    }
                    continue;
                }

                if (entry.kind === 'file') {
                    try {
                        const file = await entry.getFile();
                        node.children.push(createFileNode(entry.name, joinPath(node.path, entry.name), file.size, file.type, file.lastModified));
                    } catch (error) {
                        console.warn('Не вдалося прочитати файл з папки', error);
                    }
                }
            }

            sortDirectoryChildren(node);
            return node;
        }

        function buildSnapshotFromFileList(fileList) {
            const tree = buildTreeFromFileHandles(fileList);
            if (!tree) {
                return null;
            }
            return finalizeSnapshot(tree, 'upload');
        }

        function buildTreeFromFileHandles(fileList) {
            const files = Array.from(fileList || []);
            if (!files.length) {
                return null;
            }

            const normalized = files
                .map(file => {
                    const relativePath = (file.webkitRelativePath || file._relativePath || file.name || '')
                        .replace(/^[\/]+/, '')
                        .replace(/\\/g, '/');
                    return { file, relativePath };
                })
                .filter(item => item.relativePath);

            if (!normalized.length) {
                return null;
            }

            const rootName = normalized[0].relativePath.split('/')[0] || 'Папка';
            const root = createDirectoryNode(rootName, rootName);

            normalized.forEach(({ file, relativePath }) => {
                const segments = relativePath.split('/').filter(Boolean);
                if (!segments.length) {
                    return;
                }

                if (segments[0] === root.name) {
                    segments.shift();
                }

                const fileName = segments.pop() || relativePath;
                let current = root;
                segments.forEach(segment => {
                    current = ensureDirectoryChild(current, segment);
                });

                const filePath = joinPath(current.path, fileName);
                current.children.push(createFileNode(fileName, filePath, file.size, file.type, file.lastModified));
            });

            sortDirectoryChildren(root);
            return root;
        }

        function joinPath(parentPath, segment) {
            const base = (parentPath || '').replace(/\\/g, '/');
            const addition = (segment || '').replace(/\\/g, '/');
            const cleanBase = base.replace(/\/+$/, '');
            const cleanAddition = addition.replace(/^\/+/, '');
            if (!cleanBase) {
                return cleanAddition;
            }
            if (!cleanAddition) {
                return cleanBase;
            }
            return `${cleanBase}/${cleanAddition}`;
        }

        function createDirectoryNode(name, path) {
            const safeName = name || 'Папка';
            const safePath = (path || safeName).toString().replace(/\\/g, '/');
            return {
                type: 'directory',
                name: safeName,
                path: safePath,
                children: []
            };
        }

        function createFileNode(name, path, size = 0, mimeType = '', lastModified = 0) {
            return {
                type: 'file',
                name: name || 'Файл',
                path: (path || '').toString().replace(/\\/g, '/'),
                size: Number(size) || 0,
                mimeType: mimeType || '',
                lastModified: Number(lastModified) || 0
            };
        }

        function ensureDirectoryChild(parent, name) {
            const safeName = name || 'Папка';
            if (!parent || parent.type !== 'directory') {
                return createDirectoryNode(safeName, safeName);
            }

            if (!Array.isArray(parent.children)) {
                parent.children = [];
            }

            let child = parent.children.find(item => item.type === 'directory' && item.name === safeName);
            if (!child) {
                child = createDirectoryNode(safeName, joinPath(parent.path, safeName));
                parent.children.push(child);
            }

            return child;
        }

        function sortDirectoryChildren(node) {
            if (!node || node.type !== 'directory' || !Array.isArray(node.children)) {
                return;
            }

            node.children.sort((a, b) => {
                if (a.type === b.type) {
                    return a.name.localeCompare(b.name, 'uk', { sensitivity: 'base' });
                }
                return a.type === 'directory' ? -1 : 1;
            });

            node.children.forEach(child => {
                if (child.type === 'directory') {
                    sortDirectoryChildren(child);
                }
            });
        }
        function computeNodeStats(node) {
            if (!node) {
                return { files: 0, folders: 0, size: 0, lastModified: 0 };
            }

            if (node.type === 'file') {
                const size = Number(node.size) || 0;
                const lastModified = Number(node.lastModified) || 0;
                const stats = { files: 1, folders: 0, size, lastModified };
                node.stats = stats;
                return stats;
            }

            let files = 0;
            let folders = 1;
            let size = 0;
            let lastModified = 0;

            if (Array.isArray(node.children)) {
                node.children.forEach(child => {
                    const childStats = computeNodeStats(child);
                    files += childStats.files;
                    folders += childStats.folders;
                    size += childStats.size;
                    if (childStats.lastModified && childStats.lastModified > lastModified) {
                        lastModified = childStats.lastModified;
                    }
                });
            }

            const stats = { files, folders, size, lastModified };
            node.stats = stats;
            return stats;
        }

        function finalizeSnapshot(rootNode, source = 'picker', base = null) {
            if (!rootNode) {
                return null;
            }

            sortDirectoryChildren(rootNode);
            const stats = computeNodeStats(rootNode);

            return {
                id: base?.id || generateId('folder'),
                rootName: (base?.rootName || rootNode.name || 'Папка').toString(),
                scannedAt: base?.scannedAt || new Date().toISOString(),
                source: base?.source || source,
                tree: rootNode,
                totals: {
                    files: stats.files,
                    folders: Math.max(stats.folders - 1, 0),
                    size: stats.size
                }
            };
        }

        function storeFolderSnapshot(snapshot, sourceId = null) {
            if (!snapshot) {
                return;
            }

            if (!Array.isArray(crmData.fileLibrary)) {
                crmData.fileLibrary = [];
            }

            const filtered = crmData.fileLibrary.filter(item => item.id !== snapshot.id && item.rootName !== snapshot.rootName);
            crmData.fileLibrary = [snapshot, ...filtered].slice(0, FILE_LIBRARY_LIMIT);
            activeFileSnapshotId = snapshot.id;

            const targetSourceId = sourceId
                || (Array.isArray(crmData.fileSources)
                    ? (crmData.fileSources.find(item => item.snapshotId === snapshot.id)?.id || null)
                    : null);

            if (targetSourceId) {
                attachSnapshotToSource(snapshot, targetSourceId);
            } else if (Array.isArray(crmData.fileSources)) {
                const matchedSource = crmData.fileSources.find(item => {
                    if (item.snapshotId) {
                        return false;
                    }
                    if (item.type !== 'local') {
                        return false;
                    }
                    if (!item.path || !snapshot.rootName) {
                        return false;
                    }
                    return item.path.replace(/\\/g, '/').toLowerCase() === snapshot.rootName.replace(/\\/g, '/').toLowerCase();
                });
                if (matchedSource) {
                    attachSnapshotToSource(snapshot, matchedSource.id);
                }
            }

            pendingFileSourceId = null;
            saveData();
            updateFileSnapshotsSelect();
            renderFileExplorer(fileSearchTerm);
            renderFileSources();
        }

        function updateFileSnapshotsSelect() {
            const select = document.getElementById('folderSnapshotsSelect');
            if (!select) {
                return;
            }

            const snapshots = Array.isArray(crmData.fileLibrary) ? crmData.fileLibrary : [];
            if (!snapshots.length) {
                select.innerHTML = '<option value="">Папки ще не підключені</option>';
                select.value = '';
                select.disabled = true;
                return;
            }

            select.disabled = false;
            if (!activeFileSnapshotId) {
                activeFileSnapshotId = snapshots[0].id;
            }

            const options = snapshots.map(snapshot => {
                const dateLabel = snapshot.scannedAt
                    ? `${formatDate(snapshot.scannedAt, { day: '2-digit', month: 'short', year: 'numeric' })} ${formatTime(snapshot.scannedAt)}`
                    : '';
                const label = `${snapshot.rootName}${dateLabel ? ` • ${dateLabel}` : ''}`;
                const selected = snapshot.id === activeFileSnapshotId ? ' selected' : '';
                return `<option value="${snapshot.id}"${selected}>${escapeHtml(label)}</option>`;
            });

            select.innerHTML = options.join('');
            select.value = activeFileSnapshotId || '';
        }

        function renderFileExplorer(searchTerm = '') {
            const treeBody = document.getElementById('fileTreeBody');
            const summary = document.getElementById('fileSummary');
            const searchInput = document.getElementById('fileSearchInput');

            if (!treeBody || !summary) {
                return;
            }

            fileSearchTerm = searchTerm || '';
            if (searchInput && searchInput.value !== fileSearchTerm) {
                searchInput.value = fileSearchTerm;
            }

            updateFileScanStatus(isScanningFolder ? 'Скануємо папку...' : '');

            const snapshots = Array.isArray(crmData.fileLibrary) ? crmData.fileLibrary : [];
            if (!snapshots.length) {
                summary.innerHTML = '<div class="empty-state" style="padding: 24px;">Підключіть папку, щоб побачити її структуру. Дані зберігаються лише локально.</div>';
                treeBody.innerHTML = '<div class="empty-state" style="padding: 32px;">Жодної папки ще не підключено.</div>';
                const select = document.getElementById('folderSnapshotsSelect');
                if (select) {
                    select.innerHTML = '<option value="">Папки ще не підключені</option>';
                    select.disabled = true;
                }
                return;
            }

            const select = document.getElementById('folderSnapshotsSelect');
            if (select) {
                select.disabled = false;
                if (!activeFileSnapshotId) {
                    activeFileSnapshotId = snapshots[0].id;
                }
                if (select.value !== activeFileSnapshotId) {
                    select.value = activeFileSnapshotId;
                }
            }

            const snapshot = snapshots.find(item => item.id === activeFileSnapshotId) || snapshots[0];
            activeFileSnapshotId = snapshot?.id || null;
            const previousSourceId = activeFileSourceId;
            const linkedSource = getFileSourceBySnapshotId(snapshot?.id);
            activeFileSourceId = linkedSource ? linkedSource.id : null;
            updateFileSummary(snapshot);

            if (!snapshot) {
                treeBody.innerHTML = '<div class="empty-state" style="padding: 32px;">Не вдалося завантажити вибране сканування.</div>';
                return;
            }

            const entries = flattenFileTree(snapshot.tree);
            const visibleEntries = getVisibleFileEntries(entries, fileSearchTerm);

            if (!visibleEntries.length) {
                treeBody.innerHTML = '<div class="empty-state" style="padding: 32px;">За вашим запитом нічого не знайдено.</div>';
                return;
            }

            const rootPrefix = snapshot.rootName ? `${snapshot.rootName}/` : '';
            treeBody.innerHTML = visibleEntries.map(entry => {
                const icon = entry.type === 'directory'
                    ? 'fa-solid fa-folder'
                    : `fa-solid ${getAttachmentIcon(entry.mimeType || '')}`;
                const nameHtml = highlightMatch(entry.name, fileSearchTerm);
                const relativePath = entry.path.startsWith(rootPrefix)
                    ? entry.path.slice(rootPrefix.length)
                    : (entry.path === snapshot.rootName ? '' : entry.path);
                const directoryMeta = entry.type === 'directory'
                    ? `${entry.stats.files} файлів • ${Math.max(entry.stats.folders - 1, 0)} папок`
                    : '';
                const fileMeta = entry.type === 'file' && relativePath ? relativePath : '';
                const metaText = directoryMeta || fileMeta;
                const metaHtml = metaText ? `<div class="file-meta">${escapeHtml(metaText)}</div>` : '';
                const sizeLabel = formatBytes(entry.size);
                const modifiedLabel = entry.lastModified
                    ? `${formatDate(entry.lastModified, { day: '2-digit', month: 'short', year: 'numeric' })} ${formatTime(entry.lastModified)}`
                    : '—';
                return `
                    <div class="file-entry">
                        <div class="file-name" data-type="${entry.type}" style="--level: ${entry.level}">
                            <i class="${icon}"></i>
                            <div>
                                <div>${nameHtml}</div>
                                ${metaHtml}
                            </div>
                        </div>
                        <div>${sizeLabel}</div>
                        <div>${modifiedLabel}</div>
                    </div>
                `;
            }).join('');

            if (previousSourceId !== activeFileSourceId) {
                renderFileSources();
            }
        }

        function renderFileSources() {
            const grid = document.getElementById('fileSourceGrid');
            if (!grid) {
                return;
            }

            const sources = Array.isArray(crmData.fileSources) ? crmData.fileSources.filter(Boolean) : [];
            if (!sources.length) {
                grid.innerHTML = '<div class="empty-state" style="padding: 20px;">Додайте локальну папку або підключіть хмарний каталог, щоб швидко отримати доступ до матеріалів.</div>';
                return;
            }

            grid.innerHTML = sources.map(createFileSourceCard).join('');

            grid.querySelectorAll('[data-source-connect]').forEach(button => {
                button.addEventListener('click', () => handleFileSourceConnect(button.dataset.sourceConnect));
            });

            grid.querySelectorAll('[data-source-open]').forEach(button => {
                button.addEventListener('click', () => handleFileSourceOpen(button.dataset.sourceOpen));
            });

            grid.querySelectorAll('[data-source-sync]').forEach(button => {
                button.addEventListener('click', () => handleFileSourceSync(button.dataset.sourceSync));
            });
        }

        function createFileSourceCard(source) {
            const status = getFileSourceStatus(source);
            const statusLabel = getFileSourceStatusLabel(status);
            const icon = source?.type === 'cloud' ? 'fa-cloud' : 'fa-folder-tree';
            const provider = source?.type === 'cloud'
                ? (source?.provider && source.provider.trim().length ? source.provider : 'Хмарне сховище')
                : 'Локальна папка';
            const pathLabel = source?.path && source.path.trim().length
                ? escapeHtml(source.path)
                : escapeHtml(source?.type === 'cloud' ? 'Хмарний каталог' : 'Локальна папка');
            const filesValue = formatIntegerDisplay(source?.totalFiles);
            const foldersValue = formatIntegerDisplay(source?.totalFolders);
            const sizeValue = Number(source?.totalSize) > 0 ? formatBytes(source.totalSize) : '—';
            const updatedText = source?.lastSynced
                ? `Оновлено ${formatDate(source.lastSynced, { day: '2-digit', month: 'short', year: 'numeric' })} ${formatTime(source.lastSynced)}`
                : (source?.connected ? 'Очікує синхронізацію' : 'Ще не підключено');
            const autoSyncText = source?.autoSync ? 'Автосинхронізація увімкнена' : 'Ручне оновлення';
            const hasSnapshot = Boolean(source?.snapshotId)
                && Array.isArray(crmData.fileLibrary)
                && crmData.fileLibrary.some(snapshot => snapshot.id === source.snapshotId);
            const isActive = Boolean(activeFileSourceId) && source?.id === activeFileSourceId;

            let actionHtml = '';
            if (!source?.connected || (source?.type === 'local' && !hasSnapshot)) {
                actionHtml = `<button type="button" class="btn btn-small-muted" data-source-connect="${source.id}">Підключити</button>`;
            } else if (hasSnapshot) {
                actionHtml = `<button type="button" class="btn btn-small-muted" data-source-open="${source.id}">Відкрити</button>`;
            } else if (source?.type === 'cloud') {
                actionHtml = `<button type="button" class="btn btn-small-muted" data-source-sync="${source.id}">Синхронізувати</button>`;
            }

            return `
                <article class="file-source-card${isActive ? ' active' : ''}" data-source-id="${source.id}">
                    <header class="file-source-header">
                        <div class="file-source-icon">
                            <i class="fa-solid ${icon}"></i>
                        </div>
                        <div class="file-source-title">
                            <strong>${escapeHtml(source?.name || 'Джерело файлів')}</strong>
                            <span class="metric-sub">${escapeHtml(provider)}</span>
                        </div>
                        <span class="file-source-status status-${status}">${statusLabel}</span>
                    </header>
                    <div class="file-source-body">
                        <div class="file-source-path"><i class="fa-solid fa-location-dot"></i> ${pathLabel}</div>
                        <div class="file-source-stats">
                            <div><strong>${filesValue}</strong><span>файлів</span></div>
                            <div><strong>${foldersValue}</strong><span>папок</span></div>
                            <div><strong>${sizeValue}</strong><span>обсяг</span></div>
                        </div>
                        <div class="file-source-updated">${escapeHtml(updatedText)}</div>
                        <div class="metric-sub">${autoSyncText}${source?.favorite ? ' • В обраних' : ''}</div>
                    </div>
                    ${actionHtml ? `<footer class="file-source-footer">${actionHtml}</footer>` : ''}
                </article>
            `;
        }

        function handleFileSourceConnect(sourceId) {
            if (!sourceId) {
                return;
            }

            const source = getFileSourceById(sourceId);
            if (!source) {
                return;
            }

            if (source.type === 'cloud') {
                source.connected = true;
                source.status = 'online';
                source.lastSynced = new Date().toISOString();
                activeFileSourceId = source.id;
                saveData();
                renderFileSources();
                return;
            }

            handleFolderConnect(sourceId);
        }

        function handleFileSourceOpen(sourceId) {
            if (!sourceId) {
                return;
            }

            const source = getFileSourceById(sourceId);
            if (!source || !source.snapshotId) {
                return;
            }

            const snapshotExists = Array.isArray(crmData.fileLibrary)
                && crmData.fileLibrary.some(snapshot => snapshot.id === source.snapshotId);

            if (!snapshotExists) {
                alert('Збережений знімок каталогу недоступний. Підключіть джерело повторно.');
                source.status = 'offline';
                source.connected = false;
                source.snapshotId = null;
                saveData();
                renderFileSources();
                return;
            }

            activeFileSourceId = source.id;
            activeFileSnapshotId = source.snapshotId;
            renderFileExplorer(fileSearchTerm);
            updateFileSnapshotsSelect();
        }

        function handleFileSourceSync(sourceId) {
            if (!sourceId) {
                return;
            }

            const source = getFileSourceById(sourceId);
            if (!source) {
                return;
            }

            source.status = 'syncing';
            renderFileSources();

            setTimeout(() => {
                source.status = 'online';
                source.connected = true;
                source.lastSynced = new Date().toISOString();
                saveData();
                renderFileSources();
            }, 700);
        }

        function attachSnapshotToSource(snapshot, sourceId) {
            if (!snapshot || !sourceId) {
                return;
            }

            const source = getFileSourceById(sourceId);
            if (!source) {
                return;
            }

            source.snapshotId = snapshot.id;
            source.connected = true;
            source.status = 'online';
            source.totalFiles = snapshot.totals?.files ?? 0;
            source.totalFolders = snapshot.totals?.folders ?? 0;
            source.totalSize = snapshot.totals?.size ?? 0;
            source.lastSynced = snapshot.scannedAt || new Date().toISOString();
            if (!source.path) {
                source.path = snapshot.rootName;
            }
            activeFileSourceId = source.id;
        }

        function getFileSourceById(sourceId) {
            if (!sourceId || !Array.isArray(crmData.fileSources)) {
                return null;
            }
            return crmData.fileSources.find(source => source.id === sourceId) || null;
        }

        function getFileSourceBySnapshotId(snapshotId) {
            if (!snapshotId || !Array.isArray(crmData.fileSources)) {
                return null;
            }
            return crmData.fileSources.find(source => source.snapshotId === snapshotId) || null;
        }

        function getFileSourceStatus(source) {
            if (!source || typeof source !== 'object') {
                return 'offline';
            }

            const status = typeof source.status === 'string' ? source.status.toLowerCase() : '';
            if (status === 'online' || status === 'offline' || status === 'syncing') {
                return status;
            }

            return source.connected ? 'online' : 'offline';
        }

        function getFileSourceStatusLabel(status) {
            switch (status) {
                case 'online':
                    return 'Онлайн';
                case 'syncing':
                    return 'Синхронізація';
                case 'offline':
                default:
                    return 'Не підключено';
            }
        }

        function flattenFileTree(node, level = 0, acc = []) {
            if (!node) {
                return acc;
            }

            acc.push({
                type: node.type,
                name: node.name,
                path: node.path,
                level,
                size: node.type === 'file' ? Number(node.size) || 0 : Number(node.stats?.size) || 0,
                lastModified: node.type === 'file'
                    ? Number(node.lastModified) || 0
                    : Number(node.stats?.lastModified) || 0,
                mimeType: node.mimeType || '',
                stats: node.stats || { files: 0, folders: 0, size: 0, lastModified: 0 }
            });

            if (node.type === 'directory' && Array.isArray(node.children)) {
                node.children.forEach(child => flattenFileTree(child, level + 1, acc));
            }

            return acc;
        }

        function getVisibleFileEntries(entries, query) {
            if (!Array.isArray(entries) || !entries.length) {
                return [];
            }

            const trimmed = (query || '').trim().toLowerCase();
            if (!trimmed) {
                return entries;
            }

            const matched = entries.filter(entry => entry.path.toLowerCase().includes(trimmed) || entry.name.toLowerCase().includes(trimmed));
            if (!matched.length) {
                return [];
            }

            const visiblePaths = new Set();
            matched.forEach(item => {
                const segments = item.path.split('/');
                let current = '';
                segments.forEach((segment, index) => {
                    if (!segment) {
                        return;
                    }
                    current = index === 0 ? segment : `${current}/${segment}`;
                    visiblePaths.add(current);
                });
            });

            return entries.filter(entry => visiblePaths.has(entry.path));
        }

        function highlightMatch(text, query) {
            const safe = escapeHtml(text || '');
            if (!query) {
                return safe;
            }

            try {
                const regex = new RegExp(escapeRegExp(query), 'ig');
                return safe.replace(regex, match => `<mark>${match}</mark>`);
            } catch (error) {
                return safe;
            }
        }

        function escapeRegExp(value) {
            return value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function updateFileSummary(snapshot) {
            const container = document.getElementById('fileSummary');
            if (!container) {
                return;
            }

            if (!snapshot) {
                container.innerHTML = '';
                return;
            }

            const updatedLabel = snapshot.scannedAt
                ? `${formatDate(snapshot.scannedAt, { day: '2-digit', month: 'short', year: 'numeric' })} ${formatTime(snapshot.scannedAt)}`
                : '—';
            const foldersTotal = snapshot.totals?.folders ?? 0;
            const filesTotal = snapshot.totals?.files ?? 0;

            container.innerHTML = `
                <div class="file-summary-card">
                    <span>Папка</span>
                    <strong>${escapeHtml(snapshot.rootName)}</strong>
                    <small>Оновлено ${escapeHtml(updatedLabel)}</small>
                </div>
                <div class="file-summary-card">
                    <span>Файли</span>
                    <strong>${filesTotal}</strong>
                    <small>${foldersTotal} папок усередині</small>
                </div>
                <div class="file-summary-card">
                    <span>Загальний розмір</span>
                    <strong>${formatBytes(snapshot.totals?.size || 0)}</strong>
                    <small>Дані зберігаються локально</small>
                </div>
            `;
        }

        function sanitizeFileNode(node, parentPath = '') {
            if (!node || typeof node !== 'object') {
                return null;
            }

            const nodeType = node.type === 'file' || node.type === 'directory'
                ? node.type
                : Array.isArray(node.children) ? 'directory' : 'file';

            const rawName = typeof node.name === 'string' && node.name.trim()
                ? node.name.trim()
                : (typeof node.path === 'string' && node.path.trim()
                    ? node.path.trim().split(/[\/]/).filter(Boolean).pop()
                    : nodeType === 'file' ? 'Файл' : 'Папка');

            const path = typeof node.path === 'string' && node.path.trim()
                ? node.path.trim().replace(/\\/g, '/')
                : joinPath(parentPath, rawName);

            if (nodeType === 'file') {
                return {
                    type: 'file',
                    name: rawName,
                    path,
                    size: Number(node.size) || 0,
                    lastModified: Number(node.lastModified) || 0,
                    mimeType: typeof node.mimeType === 'string'
                        ? node.mimeType
                        : typeof node.fileType === 'string'
                            ? node.fileType
                            : ''
                };
            }

            const children = Array.isArray(node.children)
                ? node.children.map(child => sanitizeFileNode(child, path)).filter(Boolean)
                : [];

            return {
                type: 'directory',
                name: rawName,
                path,
                children
            };
        }

        function normalizeFileSnapshot(snapshot) {
            if (!snapshot || typeof snapshot !== 'object') {
                return null;
            }

            const sanitizedTree = sanitizeFileNode(snapshot.tree);
            if (!sanitizedTree) {
                return null;
            }

            return finalizeSnapshot(sanitizedTree, snapshot.source || 'picker', {
                id: typeof snapshot.id === 'string' ? snapshot.id : generateId('folder'),
                rootName: typeof snapshot.rootName === 'string' ? snapshot.rootName : sanitizedTree.name,
                scannedAt: snapshot.scannedAt,
                source: snapshot.source || 'picker'
            });
        }

        function renderAll() {
            renderDashboard();
            renderPipeline();
            renderProjects(projectSearchTerm);
            renderContacts(document.getElementById('contactSearch').value || '');
            renderTasks();
            renderRoles();
            renderFileExplorer(fileSearchTerm);
            renderAnalytics();
        }

        function updateSidebar() {
            const activeLeads = crmData.leads.filter(lead => lead.stage !== 'Втрачено');
            const pipelineValue = activeLeads.reduce((sum, lead) => sum + lead.value, 0);
            document.getElementById('sidebarDeals').textContent = activeLeads.length;
            document.getElementById('sidebarPipeline').textContent = formatCurrency(pipelineValue, true);
        }

        function renderDashboard() {
            updateSidebar();
            const metricCards = document.getElementById('metricCards');
            const activeLeads = crmData.leads.filter(lead => lead.stage !== 'Втрачено');
            const wonDeals = crmData.leads.filter(lead => lead.stage === 'Угода');
            const lostDeals = crmData.leads.filter(lead => lead.stage === 'Втрачено');
            const pipelineValue = activeLeads.reduce((sum, lead) => sum + lead.value, 0);
            const expectedRevenue = activeLeads.reduce((sum, lead) => sum + lead.value * (lead.probability / 100), 0);
            const winRate = wonDeals.length + lostDeals.length === 0 ? 0 : Math.round((wonDeals.length / (wonDeals.length + lostDeals.length)) * 100);
            const tasksDueToday = crmData.tasks.filter(task => task.status !== 'done' && isDueToday(task.dueDate)).length;
            const hotDeals = activeLeads.filter(lead => lead.probability >= 60).length;

            metricCards.innerHTML = `
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fa-solid fa-fire"></i>
                    </div>
                    <div>
                        <div class="metric-label">Активні угоди</div>
                        <div class="metric-value">${activeLeads.length}</div>
                        <div class="metric-sub">${hotDeals} гарячих можливостей</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fa-solid fa-coins"></i>
                    </div>
                    <div>
                        <div class="metric-label">Вартість воронки</div>
                        <div class="metric-value">${formatCurrency(pipelineValue)}</div>
                        <div class="metric-sub">${formatCurrency(expectedRevenue)} прогнозовано</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div>
                        <div class="metric-label">Win rate</div>
                        <div class="metric-value">${winRate}%</div>
                        <div class="metric-sub">${wonDeals.length} виграно / ${lostDeals.length} втрачено</div>
                    </div>
                    <div class="metric-progress" style="--angle: ${winRate * 3.6}deg">${winRate}%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fa-solid fa-calendar-day"></i>
                    </div>
                    <div>
                        <div class="metric-label">Завдання на сьогодні</div>
                        <div class="metric-value">${tasksDueToday}</div>
                        <div class="metric-sub">${crmData.tasks.filter(t => t.status !== 'done').length} активних задач</div>
                    </div>
                </div>
            `;

            renderStageDistribution();
            renderUpcomingActivities();
            renderActivityTimeline();
            renderProcessOverview();
            renderFeatureUsage();
            renderForecastCard(pipelineValue, expectedRevenue);
        }

        function renderStageDistribution() {
            const container = document.getElementById('stageDistribution');
            const totalValue = crmData.leads.filter(lead => lead.stage !== 'Втрачено').reduce((sum, lead) => sum + lead.value, 0);
            container.innerHTML = STAGES.map(stage => {
                const stageLeads = crmData.leads.filter(lead => lead.stage === stage);
                const stageValue = stageLeads.reduce((sum, lead) => sum + lead.value, 0);
                const percent = totalValue ? Math.round((stageValue / totalValue) * 100) : 0;
                const badgeClass = stage === 'Угода' ? 'badge-success' : stage === 'Втрачено' ? 'badge-danger' : '';
                return `
                    <div class="stage-item">
                        <div class="stage-info">
                            <strong>${stage}</strong>
                            <div class="stage-bar"><span style="width: ${percent || stageLeads.length ? Math.max(percent, 6) : 4}%"></span></div>
                        </div>
                        <div style="text-align: right;">
                            <div>${formatCurrency(stageValue)}</div>
                            <div class="metric-sub">${stageLeads.length} угод${stage === 'Угода' ? `<span class="badge ${badgeClass}" style="margin-left:8px;">успіх</span>` : stage === 'Втрачено' ? `<span class="badge ${badgeClass}" style="margin-left:8px;">потрібна увага</span>` : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderUpcomingActivities() {
            const container = document.getElementById('upcomingActivities');
            const upcoming = [];
            const today = new Date();

            crmData.tasks.filter(task => task.status !== 'done' && task.dueDate).forEach(task => {
                upcoming.push({
                    type: 'task',
                    title: task.title,
                    owner: task.owner,
                    dueDate: task.dueDate,
                    relatedLeadId: task.relatedLeadId,
                    priority: task.priority
                });
            });

            crmData.leads.filter(lead => !['Угода', 'Втрачено'].includes(lead.stage) && lead.expectedClose).forEach(lead => {
                upcoming.push({
                    type: 'lead',
                    title: `Очікуване закриття: ${lead.name}`,
                    owner: lead.owner,
                    dueDate: lead.expectedClose,
                    relatedLeadId: lead.id,
                    priority: lead.probability >= 60 ? 'high' : 'medium'
                });
            });

            const soon = upcoming
                .filter(item => item.dueDate)
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
                .slice(0, 5);

            if (soon.length === 0) {
                container.innerHTML = '<div class="empty-state">Найближчі активності відсутні — додайте нові завдання.</div>';
                return;
            }

            container.innerHTML = soon.map(item => {
                const due = formatDate(item.dueDate);
                const overdue = new Date(item.dueDate) < today && !isSameDay(new Date(item.dueDate), today);
                const badge = item.type === 'task' ? (item.priority === 'high' ? 'badge-danger' : item.priority === 'medium' ? 'badge-warning' : 'badge-success') : 'badge-warning';
                return `
                    <div class="upcoming-item">
                        <div class="badge ${badge}">${item.type === 'task' ? 'Завдання' : 'Угода'}</div>
                        <div>
                            <strong>${item.title}</strong>
                            <div class="metric-sub">${due}${overdue ? ' • прострочено' : ''}${item.owner ? ` • ${item.owner}` : ''}</div>
                        </div>
                        ${item.relatedLeadId ? `<button class="btn btn-small-muted" data-open-lead="${item.relatedLeadId}">Деталі</button>` : ''}
                    </div>
                `;
            }).join('');

            container.querySelectorAll('[data-open-lead]').forEach(btn => {
                btn.addEventListener('click', () => openLeadDetails(btn.dataset.openLead));
            });
        }

        function renderActivityTimeline() {
            const container = document.getElementById('activityTimeline');
            const latest = crmData.activities.slice(0, 6);
            if (latest.length === 0) {
                container.innerHTML = '<div class="empty-state">Ще не було активностей. Додайте перші угоди!</div>';
                return;
            }

            container.innerHTML = latest.map(activity => {
                const icon = getActivityIcon(activity.type);
                return `
                    <div class="timeline-item">
                        <div class="timeline-icon"><i class="${icon}"></i></div>
                        <div class="timeline-content">
                            <div>${activity.message}</div>
                            <div class="timeline-time">${formatRelativeTime(activity.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderProcessOverview() {
            const container = document.getElementById('processOverview');
            if (!container) {
                return;
            }

            const now = new Date();
            const staleThreshold = 7;
            const openLeads = crmData.leads.filter(lead => !['Угода', 'Втрачено'].includes(lead.stage));
            const openTasks = crmData.tasks.filter(task => task.status !== 'done');
            const tasksByLead = openTasks.reduce((map, task) => {
                if (!task.relatedLeadId) {
                    return map;
                }
                if (!map.has(task.relatedLeadId)) {
                    map.set(task.relatedLeadId, []);
                }
                map.get(task.relatedLeadId).push(task);
                return map;
            }, new Map());

            const leadsWithoutTasks = openLeads.filter(lead => !(tasksByLead.get(lead.id)?.length));
            const staleLeads = openLeads.filter(lead => {
                const referenceDate = lead.updatedAt || lead.createdAt;
                if (!referenceDate) {
                    return false;
                }
                return daysBetween(referenceDate, now) >= staleThreshold;
            });
            const overdueTasks = openTasks.filter(task => {
                if (!task.dueDate) {
                    return false;
                }
                const due = new Date(task.dueDate);
                if (Number.isNaN(due.getTime())) {
                    return false;
                }
                return due < now && !isSameDay(due, now);
            });
            const closingSoonLeads = openLeads.filter(lead => {
                if (!lead.expectedClose) {
                    return false;
                }
                const due = new Date(lead.expectedClose);
                if (Number.isNaN(due.getTime())) {
                    return false;
                }
                const diffDays = Math.round((due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
                return diffDays <= 14;
            });

            const avgStageAge = openLeads.length
                ? Math.round(openLeads.reduce((sum, lead) => {
                    const referenceDate = lead.updatedAt || lead.createdAt;
                    return sum + daysBetween(referenceDate, now);
                }, 0) / openLeads.length)
                : null;
            const summaryValue = avgStageAge !== null
                ? `${avgStageAge}<span>дн.</span>`
                : '&mdash;';

            const formatList = (items, getLabel) => {
                if (!items.length) {
                    return '';
                }
                const labels = items.slice(0, 2).map(getLabel);
                if (items.length > 2) {
                    labels.push(`+${items.length - 2}`);
                }
                return labels.join(', ');
            };

            const processStats = [
                {
                    label: 'Без активних задач',
                    value: leadsWithoutTasks.length,
                    note: leadsWithoutTasks.length
                        ? `Потрібно призначити: ${formatList(leadsWithoutTasks, lead => lead.name)}`
                        : 'Кожна угода має наступний крок.',
                    badge: leadsWithoutTasks.length ? 'badge-warning' : 'badge-success',
                    badgeLabel: leadsWithoutTasks.length ? 'потрібна дія' : 'готово'
                },
                {
                    label: 'Без руху 7+ днів',
                    value: staleLeads.length,
                    note: staleLeads.length
                        ? `Оновіть статус: ${formatList(staleLeads, lead => lead.name)}`
                        : 'Стадії оновлюються регулярно.',
                    badge: staleLeads.length ? 'badge-danger' : 'badge-success',
                    badgeLabel: staleLeads.length ? 'ризик' : 'стабільно'
                },
                {
                    label: 'Прострочені задачі',
                    value: overdueTasks.length,
                    note: overdueTasks.length
                        ? `Закрийте: ${formatList(overdueTasks, task => task.title)}`
                        : 'Немає прострочених активностей.',
                    badge: overdueTasks.length ? 'badge-danger' : 'badge-success',
                    badgeLabel: overdueTasks.length ? 'терміново' : 'в нормі'
                },
                {
                    label: 'Закриття ≤ 14 днів',
                    value: closingSoonLeads.length,
                    note: closingSoonLeads.length
                        ? `Готуйте фіналізацію: ${formatList(closingSoonLeads, lead => lead.name)}`
                        : 'Плануйте нові презентації.',
                    badge: closingSoonLeads.length ? 'badge-primary' : 'badge-neutral',
                    badgeLabel: closingSoonLeads.length ? 'фокус' : 'план'
                }
            ];

            const statsMarkup = processStats.map(stat => `
                <div class="process-item">
                    <div class="process-item-top">
                        <div>
                            <div class="process-item-label">${stat.label}</div>
                            <div class="process-item-value">${stat.value}</div>
                        </div>
                        <span class="badge ${stat.badge}">${stat.badgeLabel}</span>
                    </div>
                    <div class="process-item-note">${stat.note}</div>
                </div>
            `).join('');

            const attentionLeads = openLeads
                .map(lead => {
                    const tasks = tasksByLead.get(lead.id) || [];
                    const daysIdle = daysBetween(lead.updatedAt || lead.createdAt, now);
                    const overdueTaskCount = tasks.filter(task => {
                        if (!task.dueDate) {
                            return false;
                        }
                        const due = new Date(task.dueDate);
                        if (Number.isNaN(due.getTime())) {
                            return false;
                        }
                        return due < now && !isSameDay(due, now);
                    }).length;
                    const expectedClose = lead.expectedClose ? new Date(lead.expectedClose) : null;
                    const diffDays = expectedClose && !Number.isNaN(expectedClose.getTime())
                        ? Math.round((expectedClose.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))
                        : null;
                    const closingSoon = diffDays !== null && diffDays <= 14;
                    const closingOverdue = diffDays !== null && diffDays < 0;
                    const needsAttention = tasks.length === 0 || daysIdle >= staleThreshold || overdueTaskCount > 0 || closingOverdue;
                    const score = (closingOverdue ? 3 : 0)
                        + (overdueTaskCount ? 2 : 0)
                        + (tasks.length === 0 ? 2 : 0)
                        + (daysIdle >= staleThreshold ? 1 : 0)
                        + (closingSoon ? 1 : 0);
                    return { lead, tasks, daysIdle, overdueTaskCount, closingSoon, closingOverdue, diffDays, needsAttention, score };
                })
                .filter(item => item.needsAttention)
                .sort((a, b) => b.score - a.score || b.daysIdle - a.daysIdle)
                .slice(0, 3);

            const hotlistMarkup = attentionLeads.length
                ? attentionLeads.map(item => `
                    <div class="process-hotlist-item">
                        <div class="process-hotlist-head">
                            <strong>${item.lead.name}</strong>
                            <span class="badge ${item.overdueTaskCount || item.closingOverdue ? 'badge-danger' : item.closingSoon ? 'badge-warning' : 'badge-primary'}">${item.lead.stage}</span>
                        </div>
                        <div class="process-hotlist-meta">
                            <span>Без оновлень: ${item.daysIdle} дн.</span>
                            <span>Активних задач: ${item.tasks.length}</span>
                            ${item.diffDays !== null ? `<span>${item.diffDays < 0 ? 'Дедлайн минув' : 'Закриття через ' + item.diffDays + ' дн.'}</span>` : ''}
                            <span>Менеджер: ${item.lead.owner}</span>
                        </div>
                        <div class="process-hotlist-actions">
                            <button class="btn btn-small-muted" data-open-lead="${item.lead.id}">Деталі</button>
                        </div>
                    </div>
                `).join('')
                : '<div class="empty-state">Усі процеси у графіку — команда працює стабільно.</div>';

            container.innerHTML = `
                <div class="process-summary">
                    <div>
                        <div class="process-summary-value">${summaryValue}</div>
                        <div class="process-summary-label">Середній час у поточній стадії</div>
                    </div>
                    <span class="process-summary-target">Ціль ≤ 10 дн.</span>
                </div>
                <div class="process-grid">
                    ${statsMarkup}
                </div>
                <div class="process-hotlist">
                    <div class="process-hotlist-title">Угоди, що потребують уваги</div>
                    ${hotlistMarkup}
                </div>
            `;

            container.querySelectorAll('[data-open-lead]').forEach(btn => {
                btn.addEventListener('click', () => openLeadDetails(btn.dataset.openLead));
            });
        }

        function renderFeatureUsage() {
            const container = document.getElementById('featureUsage');
            if (!container) {
                return;
            }

            const totalLeads = crmData.leads.length;
            const leadsWithNotes = crmData.leads.filter(lead => Array.isArray(lead.notes) && lead.notes.length > 0).length;
            const leadsWithAttachments = crmData.leads.filter(lead => Array.isArray(lead.attachments) && lead.attachments.length > 0).length;
            const totalTasks = crmData.tasks.length;
            const tasksWithAttachments = crmData.tasks.filter(task => Array.isArray(task.attachments) && task.attachments.length > 0).length;
            const completedTasks = crmData.tasks.filter(task => task.status === 'done').length;
            const totalContacts = crmData.contacts.length;
            const contactsWithNotes = crmData.contacts.filter(contact => Array.isArray(contact.notes) && contact.notes.length > 0).length;

            const featureMetrics = [
                {
                    label: 'Нотатки по лідах',
                    value: leadsWithNotes,
                    total: totalLeads,
                    description: 'Зберігайте ключові домовленості по кожній можливості.',
                    target: '80%'
                },
                {
                    label: 'Документи в угодах',
                    value: leadsWithAttachments,
                    total: totalLeads,
                    description: 'Прикріплюйте брифи, договори та презентації до лідів.',
                    target: '60%'
                },
                {
                    label: 'Виконані задачі',
                    value: completedTasks,
                    total: totalTasks,
                    description: 'Контролюйте доведення задач до кінця.',
                    target: '70%'
                },
                {
                    label: 'Контакти з нотатками',
                    value: contactsWithNotes,
                    total: totalContacts,
                    description: 'Контекст по зустрічах та домовленостях завжди під рукою.',
                    target: '70%'
                },
                {
                    label: 'Файли в задачах',
                    value: tasksWithAttachments,
                    total: totalTasks,
                    description: 'Додавайте матеріали до задач для швидкого старту роботи.',
                    target: '50%'
                }
            ];

            const metricsMarkup = featureMetrics.map(metric => {
                const hasTotal = metric.total && metric.total > 0;
                const percent = hasTotal ? Math.round((metric.value / metric.total) * 100) : 0;
                const badgeClass = hasTotal
                    ? (percent >= 75 ? 'badge-success' : percent >= 45 ? 'badge-warning' : 'badge-danger')
                    : 'badge-neutral';
                const badgeLabel = hasTotal ? `${percent}%` : '—';
                const progressWidth = hasTotal
                    ? (metric.value === 0 ? 0 : Math.min(100, Math.max(percent, 6)))
                    : 0;
                const countLabel = hasTotal ? `${metric.value}/${metric.total}` : `${metric.value}`;
                const description = `${hasTotal ? `${metric.value} з ${metric.total} • ` : ''}${metric.description}${metric.target ? ` Ціль: ${metric.target}.` : ''}`;

                return `
                    <div class="feature-item">
                        <div class="feature-item-header">
                            <div>
                                <div class="feature-label">${metric.label}</div>
                                <div class="feature-meta">${description}</div>
                            </div>
                            <span class="badge ${badgeClass}">${badgeLabel}</span>
                        </div>
                        <div class="feature-progress">
                            <div class="progress-track"><div class="progress-value" style="width:${progressWidth}%"></div></div>
                            <span>${countLabel}</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = metricsMarkup;
        }

        function renderRoles() {
            renderRoleDefinitions();
            renderRoleAssignments();
            updateCustomRoleBaseOptions();
            updateCurrentUserBadge();
        }

        function renderRoleDefinitions() {
            const container = document.getElementById('roleDefinitionGrid');
            if (!container) {
                return;
            }

            const definitions = getAllRoleDefinitions();
            if (!definitions.length) {
                container.innerHTML = '<div class="empty-state">Немає визначених ролей. Додайте першу роль, щоб налаштувати доступ.</div>';
                return;
            }

            container.innerHTML = definitions.map(role => {
                const permissionsMarkup = role.permissions && role.permissions.length
                    ? `<ul class="role-permissions">${role.permissions.map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ul>`
                    : '';
                const limitationsMarkup = role.limitations && role.limitations.length
                    ? `<div class="metric-sub">Обмеження: ${escapeHtml(role.limitations.join(', '))}</div>`
                    : '';
                const meta = role.custom
                    ? `<div class="metric-sub">Створено ${escapeHtml(role.createdBy)} • ${formatDate(role.createdAt)}</div>`
                    : '';
                return `
                    <div class="role-card">
                        <span class="role-badge"><i class="fa-solid fa-user-shield" aria-hidden="true"></i> ${escapeHtml(role.badge)}</span>
                        <h4>${escapeHtml(role.name)}</h4>
                        ${role.description ? `<p>${escapeHtml(role.description)}</p>` : ''}
                        ${permissionsMarkup}
                        ${limitationsMarkup}
                        ${meta}
                    </div>
                `;
            }).join('');
        }

        function renderRoleAssignments() {
            const container = document.getElementById('roleAssignmentsTable');
            if (!container) {
                return;
            }

            const assignments = crmData && crmData.roles && Array.isArray(crmData.roles.assignments)
                ? [...crmData.roles.assignments]
                : [];

            if (!assignments.length) {
                container.innerHTML = '<div class="empty-state">Додайте учасників команди для керування доступом.</div>';
                return;
            }

            assignments.sort((a, b) => a.name.localeCompare(b.name, 'uk'));

            const roles = getAllRoleDefinitions();
            const head = `
                <div class="role-row role-head">
                    <div>Учасник</div>
                    <div>Роль</div>
                    <div>Права доступу</div>
                </div>
            `;

            const rows = assignments.map(assignment => {
                const roleDefinition = getRoleDefinition(assignment.roleId);
                const combinedScopes = new Set();
                if (roleDefinition?.permissions?.length) {
                    roleDefinition.permissions.forEach(scope => combinedScopes.add(scope));
                }
                if (assignment.responsibilities?.length) {
                    assignment.responsibilities.forEach(scope => combinedScopes.add(scope));
                }
                const scopeMarkup = combinedScopes.size
                    ? `<div class="role-permission-tags">${Array.from(combinedScopes).slice(0, 6).map(scope => `<span class="role-permission-tag">${escapeHtml(scope)}</span>`).join('')}</div>`
                    : '<span class="metric-sub">Додайте сфери відповідальності</span>';

                const limitationMarkup = roleDefinition?.limitations?.length
                    ? `<div class="metric-sub">Обмеження: ${escapeHtml(roleDefinition.limitations[0])}${roleDefinition.limitations.length > 1 ? '…' : ''}</div>`
                    : '';

                const metaParts = [];
                if (assignment.updatedAt) {
                    metaParts.push(`Оновлено ${escapeHtml(formatRelativeTime(assignment.updatedAt))}`);
                }
                if (assignment.updatedBy) {
                    metaParts.push(escapeHtml(assignment.updatedBy));
                }
                const meta = metaParts.length ? `<div class="metric-sub">${metaParts.join(' • ')}</div>` : '';
                const note = assignment.note ? `<div class="metric-sub">${escapeHtml(assignment.note)}</div>` : '';

                const memberMetaParts = [];
                if (assignment.title) memberMetaParts.push(assignment.title);
                if (assignment.department) memberMetaParts.push(assignment.department);
                if (assignment.email) memberMetaParts.push(assignment.email);
                const memberMeta = memberMetaParts.length ? `<span class="role-meta">${escapeHtml(memberMetaParts.join(' • '))}</span>` : '';

                const options = roles.map(role => {
                    const disabled = role.id === 'owner' && assignment.name === CURRENT_USER.name && CURRENT_USER.role !== 'owner';
                    const selected = role.id === assignment.roleId ? 'selected' : '';
                    return `<option value="${role.id}" ${selected} ${disabled ? 'disabled' : ''}>${escapeHtml(role.name)}</option>`;
                }).join('');
                const hasCurrentRole = roles.some(role => role.id === assignment.roleId);
                const fallbackOption = hasCurrentRole
                    ? ''
                    : `<option value="${escapeHtml(assignment.roleId)}" selected>${escapeHtml(getRoleLabel(assignment.roleId))}</option>`;

                const initials = getInitials(assignment.name);
                const disabledAttr = assignment.locked ? 'disabled' : '';
                const selectLabel = `aria-label="Змінити роль для ${escapeHtml(assignment.name)}"`;

                return `
                    <div class="role-row">
                        <div class="role-member">
                            <div class="avatar avatar-sm">${escapeHtml(initials)}</div>
                            <div class="role-member-details">
                                <strong>${escapeHtml(assignment.name)}</strong>
                                ${memberMeta}
                            </div>
                        </div>
                        <div>
                            <select data-role-assignment="${assignment.id}" ${selectLabel} ${disabledAttr}>
                                ${fallbackOption}${options}
                            </select>
                            ${assignment.roleId === 'owner' ? '<div class="metric-sub">Єдиний власник акаунту</div>' : ''}
                        </div>
                        <div>
                            ${scopeMarkup}
                            ${limitationMarkup}
                            ${meta}
                            ${note}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = head + rows;

            container.querySelectorAll('select[data-role-assignment]').forEach(select => {
                const assignmentId = select.dataset.roleAssignment;
                const assignment = crmData.roles.assignments.find(item => item.id === assignmentId);
                if (assignment) {
                    select.dataset.currentRole = assignment.roleId;
                }
                select.addEventListener('change', event => {
                    handleRoleAssignmentChange(assignmentId, event.target.value, event.target);
                });
            });
        }

        function handleRoleAssignmentChange(assignmentId, newRoleId, selectElement) {
            const assignments = crmData && crmData.roles && Array.isArray(crmData.roles.assignments)
                ? crmData.roles.assignments
                : [];
            const assignment = assignments.find(item => item.id === assignmentId);

            if (!assignment || !newRoleId || assignment.roleId === newRoleId) {
                if (selectElement && assignment) {
                    selectElement.value = assignment.roleId;
                }
                return;
            }

            if (newRoleId === 'owner' && assignment.name === CURRENT_USER.name && CURRENT_USER.role !== 'owner') {
                alert('Менеджери не можуть самостійно призначити собі роль Owner. Зверніться до поточного власника.');
                if (selectElement) {
                    selectElement.value = assignment.roleId;
                }
                return;
            }

            if (assignment.roleId === 'owner' && newRoleId !== 'owner') {
                const otherOwnerExists = assignments.some(item => item.roleId === 'owner' && item.id !== assignment.id);
                if (!otherOwnerExists) {
                    alert('У системі має залишатися хоча б один власник. Спочатку передайте роль іншому користувачу.');
                    if (selectElement) {
                        selectElement.value = assignment.roleId;
                    }
                    return;
                }
            }

            if (newRoleId === 'owner') {
                const currentOwner = assignments.find(item => item.roleId === 'owner');
                if (currentOwner && currentOwner.id !== assignment.id) {
                    const confirmTransfer = confirm(`Передати роль Owner від ${currentOwner.name} до ${assignment.name}?`);
                    if (!confirmTransfer) {
                        if (selectElement) {
                            selectElement.value = assignment.roleId;
                        }
                        return;
                    }
                    currentOwner.roleId = 'manager';
                    currentOwner.updatedAt = new Date().toISOString();
                    currentOwner.updatedBy = CURRENT_USER.name;
                    logActivity(`Роль ${currentOwner.name} змінена на ${getRoleLabel('manager')} після передачі Owner.`, 'role', currentOwner.id);
                }
            }

            assignment.roleId = newRoleId;
            assignment.updatedAt = new Date().toISOString();
            assignment.updatedBy = CURRENT_USER.name;

            if (assignment.name === CURRENT_USER.name) {
                CURRENT_USER.role = newRoleId;
            }

            logActivity(`Роль ${assignment.name} змінена на ${getRoleLabel(newRoleId)}.`, 'role', assignment.id);
            saveData();
            renderRoles();
            renderActivityTimeline();
        }

        function handleCustomRoleSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const nameInput = document.getElementById('customRoleName');
            const baseSelect = document.getElementById('customRoleBase');
            const notesInput = document.getElementById('customRoleNotes');

            const name = nameInput ? nameInput.value.trim() : '';
            if (!name) {
                return;
            }

            const baseRoleId = baseSelect ? baseSelect.value : 'manager';
            const additionalNotes = notesInput
                ? notesInput.value.split('\n').map(note => note.trim()).filter(Boolean)
                : [];

            const allRoles = getAllRoleDefinitions();
            if (allRoles.some(role => role.name.toLowerCase() === name.toLowerCase())) {
                alert('Роль з такою назвою вже існує. Оберіть іншу назву.');
                return;
            }

            const baseRole = getRoleDefinition(baseRoleId);
            const permissions = baseRole && Array.isArray(baseRole.permissions)
                ? [...baseRole.permissions]
                : [];
            additionalNotes.forEach(note => {
                if (!permissions.includes(note)) {
                    permissions.push(note);
                }
            });

            const limitations = baseRole && Array.isArray(baseRole.limitations)
                ? [...baseRole.limitations]
                : [];

            const normalizedRole = normalizeRoleDefinition({
                id: generateId('role'),
                name,
                badge: name,
                description: baseRole ? `На основі ${baseRole.name}.` : 'Індивідуальна роль для вашої команди.',
                permissions,
                limitations,
                baseRoleId,
                createdAt: new Date().toISOString(),
                createdBy: CURRENT_USER.name,
                custom: true
            }, true);

            crmData.roles.customRoles.push(normalizedRole);
            logActivity(`Створено нову роль ${name}.`, 'role', normalizedRole.id);
            saveData();
            renderRoles();
            renderActivityTimeline();
            form.reset();
            updateCustomRoleBaseOptions();
            if (nameInput) {
                nameInput.focus();
            }
        }

        function renderForecastCard(pipelineValue, expectedRevenue) {
            const container = document.getElementById('forecastCard');
            const target = 200000;
            const coverage = Math.min(100, Math.round((pipelineValue / target) * 100));
            const weighted = Math.round(expectedRevenue);
            const topDeals = crmData.leads
                .filter(lead => lead.stage !== 'Втрачено')
                .sort((a, b) => b.value - a.value)
                .slice(0, 3);

            container.innerHTML = `
                <div class="highlight-card">
                    <div class="highlight-label">Покриття цілі</div>
                    <div class="highlight-value">${coverage}%</div>
                    <div class="metric-sub">Поточна мета: ${formatCurrency(target)}</div>
                </div>
                <div class="divider"></div>
                <div class="metric-sub">Очікуваний дохід за ймовірностями</div>
                <h2 style="margin: 6px 0 14px;">${formatCurrency(weighted)}</h2>
                <div class="metric-sub">ТОП-угоди</div>
                <div class="timeline-list">
                    ${topDeals.map(lead => `
                        <div class="timeline-entry">
                            <strong>${lead.name}</strong>
                            <span>${lead.company} • ${formatCurrency(lead.value)} • ${lead.probability}%</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        function renderPipeline() {
            const board = document.getElementById('pipelineBoard');
            const leads = pipelineFilterOwner === 'all' ? crmData.leads : crmData.leads.filter(lead => lead.owner === pipelineFilterOwner);
            if (!board) {
                return;
            }

            board.innerHTML = STAGES.map(stage => {
                const stageLeads = leads.filter(lead => lead.stage === stage);
                const stageValue = stageLeads.reduce((sum, lead) => sum + lead.value, 0);
                return `
                    <div class="pipeline-column" data-stage="${stage}">
                        <div class="column-head">
                            <h4>${stage}</h4>
                            <div class="column-meta">
                                <span>${stageLeads.length} угод</span>
                                <span>${formatCurrency(stageValue)}</span>
                            </div>
                        </div>
                        <div class="column-body" data-drop-zone>
                            ${stageLeads.length ? stageLeads.map(createDealCard).join('') : `<div class="empty-state">Немає угод</div>`}
                        </div>
                    </div>
                `;
            }).join('');

            renderPipelineMetrics(leads);
            renderPipelineStageStatus(leads);
            renderPipelinePriority(leads);
            renderPipelineOwnerSummary(leads);
            renderPipelineActivity(leads);
            setupPipelineInteractions();
        }

        function renderPipelineMetrics(leads) {
            const container = document.getElementById('pipelineMetrics');
            if (!container) {
                return;
            }

            const now = new Date();
            const activeLeads = leads.filter(lead => lead.stage !== 'Втрачено');
            const totalValue = activeLeads.reduce((sum, lead) => sum + (Number(lead.value) || 0), 0);
            const expectedRevenue = activeLeads.reduce((sum, lead) => sum + (Number(lead.value) || 0) * ((Number(lead.probability) || 0) / 100), 0);
            const averageProbability = activeLeads.length
                ? Math.round(activeLeads.reduce((sum, lead) => sum + (Number(lead.probability) || 0), 0) / activeLeads.length)
                : 0;
            const averageAge = activeLeads.length
                ? Math.round(activeLeads.reduce((sum, lead) => {
                    const baseDate = lead.createdAt || lead.updatedAt || now;
                    return sum + daysBetween(baseDate, now);
                }, 0) / activeLeads.length)
                : 0;
            const dueSoon = activeLeads.filter(lead => {
                if (!lead.expectedClose) {
                    return false;
                }
                const dueDate = new Date(lead.expectedClose);
                if (Number.isNaN(dueDate.getTime())) {
                    return false;
                }
                const diff = Math.ceil((dueDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
                return diff >= 0 && diff <= 7;
            }).length;
            const won = leads.filter(lead => lead.stage === 'Угода').length;
            const lost = leads.filter(lead => lead.stage === 'Втрачено').length;
            const winRate = won + lost ? Math.round((won / (won + lost)) * 100) : (averageProbability || 0);
            const averageAgeLabel = activeLeads.length ? `~${averageAge} дн.` : '—';
            const dueSoonLabel = dueSoon ? `${dueSoon} закриттів протягом 7 днів` : 'Немає закриттів за 7 днів';

            container.innerHTML = `
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fa-solid fa-briefcase"></i>
                    </div>
                    <div>
                        <div class="metric-label">Активні угоди</div>
                        <div class="metric-value">${activeLeads.length}</div>
                        <div class="metric-sub">${leads.length} угод у вибірці</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fa-solid fa-sack-dollar"></i>
                    </div>
                    <div>
                        <div class="metric-label">Вартість воронки</div>
                        <div class="metric-value">${formatCurrency(totalValue)}</div>
                        <div class="metric-sub">${formatCurrency(expectedRevenue)} прогнозовано</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fa-solid fa-gauge-high"></i>
                    </div>
                    <div>
                        <div class="metric-label">Середня ймовірність</div>
                        <div class="metric-value">${averageProbability}%</div>
                        <div class="metric-sub">Win-rate ${winRate}%</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fa-solid fa-calendar-check"></i>
                    </div>
                    <div>
                        <div class="metric-label">Середній вік угоди</div>
                        <div class="metric-value">${averageAgeLabel}</div>
                        <div class="metric-sub">${dueSoonLabel}</div>
                    </div>
                </div>
            `;
        }

        function renderPipelineStageStatus(leads) {
            const container = document.getElementById('pipelineStageStatus');
            if (!container) {
                return;
            }

            const now = new Date();
            const activeLeads = leads.filter(lead => lead.stage !== 'Втрачено');
            const totalValue = activeLeads.reduce((sum, lead) => sum + (Number(lead.value) || 0), 0);

            const rows = STAGES.filter(stage => stage !== 'Втрачено').map(stage => {
                const stageLeads = leads.filter(lead => lead.stage === stage);
                const stageValue = stageLeads.reduce((sum, lead) => sum + (Number(lead.value) || 0), 0);
                const valueShare = totalValue
                    ? Math.round((stageValue / totalValue) * 100)
                    : (activeLeads.length ? Math.round((stageLeads.length / activeLeads.length) * 100) : 0);
                const averageIdle = stageLeads.length
                    ? Math.round(stageLeads.reduce((sum, lead) => sum + daysBetween(lead.updatedAt || lead.createdAt || now, now), 0) / stageLeads.length)
                    : 0;
                const stuck = stageLeads.filter(lead => daysBetween(lead.updatedAt || lead.createdAt || now, now) > 10).length;
                const width = stageLeads.length ? Math.max(valueShare, 6) : 2;
                const shareLabel = totalValue ? `${valueShare}% вартості` : `${stageLeads.length} угод`;
                const averageIdleLabel = stageLeads.length ? `${averageIdle} дн.` : '—';
                const riskBadge = stuck
                    ? `<span class="stage-risk"><i class="fa-solid fa-triangle-exclamation"></i> Застигло ${stuck}</span>`
                    : '';

                return `
                    <div class="stage-row">
                        <div class="stage-info">
                            <div class="stage-name">${stage}</div>
                            <div class="stage-meta">${stageLeads.length} угод • ${formatCurrency(stageValue)}</div>
                            ${riskBadge}
                        </div>
                        <div class="stage-progress">
                            <div class="stage-share">${shareLabel}</div>
                            <div class="stage-progress-track"><span class="stage-progress-value" style="width:${Math.min(100, width)}%"></span></div>
                            <span>Середнє очікування: ${averageIdleLabel}</span>
                        </div>
                    </div>
                `;
            });

            const lostLeads = leads.filter(lead => lead.stage === 'Втрачено');
            if (lostLeads.length) {
                const lostValue = lostLeads.reduce((sum, lead) => sum + (Number(lead.value) || 0), 0);
                const lostShare = leads.length ? Math.round((lostLeads.length / leads.length) * 100) : 0;
                const lostWidth = lostLeads.length ? Math.max(lostShare, 6) : 0;
                rows.push(`
                    <div class="stage-row">
                        <div class="stage-info">
                            <div class="stage-name">Втрачено</div>
                            <div class="stage-meta">${lostLeads.length} угод • ${formatCurrency(lostValue)}</div>
                            <span class="stage-risk stage-risk-danger"><i class="fa-solid fa-circle-xmark"></i> Потрібен аналіз</span>
                        </div>
                        <div class="stage-progress">
                            <div class="stage-share">${lostShare}% угод</div>
                            <div class="stage-progress-track"><span class="stage-progress-value" style="width:${Math.min(100, lostWidth)}%"></span></div>
                            <span>Втрачено: ${formatCurrency(lostValue)}</span>
                        </div>
                    </div>
                `);
            }

            container.innerHTML = rows.join('');
        }

        function renderPipelinePriority(leads) {
            const container = document.getElementById('pipelinePriorityList');
            if (!container) {
                return;
            }

            const now = new Date();
            const items = leads
                .filter(lead => !['Втрачено', 'Угода'].includes(lead.stage))
                .map(lead => {
                    const idleDays = daysBetween(lead.updatedAt || lead.createdAt || now, now);
                    const dueDate = lead.expectedClose ? new Date(lead.expectedClose) : null;
                    let dueDiff = null;
                    if (dueDate && !Number.isNaN(dueDate.getTime())) {
                        dueDiff = Math.ceil((dueDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
                    }
                    const openTasks = crmData.tasks.filter(task => task.relatedLeadId === lead.id && task.status !== 'done');
                    const flags = [];
                    let score = 0;

                    if (typeof dueDiff === 'number') {
                        if (dueDiff < 0) {
                            score += 3;
                            flags.push({ type: 'danger', text: `Прострочено на ${Math.abs(dueDiff)} дн.` });
                        } else if (dueDiff <= 7) {
                            score += 2;
                            const dueText = dueDiff === 0 ? 'Закриття сьогодні' : `Закриття за ${dueDiff} дн.`;
                            flags.push({ type: 'warning', text: dueText });
                        }
                    }

                    if (idleDays > 10) {
                        score += 2;
                        flags.push({ type: 'warning', text: `Без оновлень ${idleDays} дн.` });
                    }

                    if ((Number(lead.probability) || 0) < 30) {
                        score += 1;
                        flags.push({ type: 'info', text: `Ймовірність ${lead.probability}%` });
                    }

                    if ((Number(lead.value) || 0) >= 80000) {
                        score += 1;
                        flags.push({ type: 'info', text: 'Висока вартість' });
                    }

                    if (openTasks.length) {
                        flags.push({ type: 'info', text: `Задач: ${openTasks.length}` });
                    }

                    return { lead, score, flags, idleDays };
                })
                .filter(item => item.score > 0 || item.flags.length > 0)
                .sort((a, b) => b.score - a.score || (Number(b.lead.value) || 0) - (Number(a.lead.value) || 0))
                .slice(0, 4);

            if (!items.length) {
                container.innerHTML = '<div class="empty-state">Усі угоди в комфортній зоні. Слідкуйте за новими змінами.</div>';
                return;
            }

            container.innerHTML = items.map(item => {
                const flagsMarkup = item.flags.map(flag => `<span class="priority-flag ${flag.type}">${flag.text}</span>`).join('');
                const manager = item.lead.owner ? `Менеджер: ${item.lead.owner}` : 'Менеджер не призначений';
                const idleText = item.idleDays > 0 ? ` • без оновлень ${item.idleDays} дн.` : '';
                return `
                    <div class="priority-item">
                        <div class="priority-header">
                            <div>
                                <div class="priority-title">${item.lead.name}</div>
                                <div class="priority-meta">${item.lead.company || 'Без компанії'} • ${item.lead.stage}</div>
                            </div>
                            <span class="badge badge-primary">${formatCurrency(Number(item.lead.value) || 0)}</span>
                        </div>
                        ${flagsMarkup ? `<div class="priority-flags">${flagsMarkup}</div>` : ''}
                        <div class="priority-meta">${manager}${idleText}</div>
                        <div class="priority-actions">
                            <button class="btn btn-small-primary" data-open-lead="${item.lead.id}">Перейти</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.querySelectorAll('[data-open-lead]').forEach(btn => {
                btn.addEventListener('click', () => openLeadDetails(btn.dataset.openLead));
            });
        }

        function renderPipelineOwnerSummary(leads) {
            const container = document.getElementById('pipelineOwnerSummary');
            if (!container) {
                return;
            }

            const ownerMap = new Map();
            leads.forEach(lead => {
                const ownerName = lead.owner || 'Без менеджера';
                if (!ownerMap.has(ownerName)) {
                    ownerMap.set(ownerName, {
                        owner: ownerName,
                        leads: 0,
                        value: 0,
                        probabilitySum: 0,
                        won: 0,
                        lost: 0
                    });
                }

                const entry = ownerMap.get(ownerName);
                entry.leads += 1;
                entry.value += Number(lead.value) || 0;
                entry.probabilitySum += Number(lead.probability) || 0;
                if (lead.stage === 'Угода') {
                    entry.won += 1;
                }
                if (lead.stage === 'Втрачено') {
                    entry.lost += 1;
                }
            });

            const stats = Array.from(ownerMap.values()).map(entry => {
                const openTasks = crmData.tasks.filter(task => task.owner === entry.owner && task.status !== 'done').length;
                const avgProbability = entry.leads ? Math.round(entry.probabilitySum / entry.leads) : 0;
                const winRate = entry.won + entry.lost ? Math.round((entry.won / (entry.won + entry.lost)) * 100) : avgProbability;
                return {
                    ...entry,
                    avgProbability,
                    winRate,
                    openTasks
                };
            }).sort((a, b) => b.value - a.value);

            if (!stats.length) {
                container.innerHTML = '<div class="empty-state">Немає даних для відображення.</div>';
                return;
            }

            container.innerHTML = stats.map(entry => {
                const avatarLetter = entry.owner ? entry.owner.charAt(0).toUpperCase() : '?';
                const progressWidth = entry.avgProbability > 0 ? Math.max(entry.avgProbability, 6) : 0;
                return `
                    <div class="owner-row">
                        <div class="owner-info">
                            <div class="avatar">${avatarLetter}</div>
                            <div>
                                <strong>${entry.owner}</strong>
                                <div class="metric-sub">${entry.leads} угод • ${formatCurrency(entry.value)}</div>
                            </div>
                        </div>
                        <div class="owner-metrics">
                            <div class="owner-progress-track"><span class="owner-progress-value" style="width:${Math.min(100, progressWidth)}%"></span></div>
                            <div class="metric-sub">Середня ймовірність ${entry.avgProbability}%</div>
                            <div class="metric-sub">Win-rate ${entry.winRate}%</div>
                            <div class="metric-sub">Активних задач: ${entry.openTasks}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPipelineActivity(leads) {
            const container = document.getElementById('pipelineActivityTimeline');
            if (!container) {
                return;
            }

            const leadIds = new Set(leads.map(lead => lead.id));
            const relevantActivities = crmData.activities
                .filter(activity => ['stage', 'note', 'won', 'lost'].includes(activity.type))
                .filter(activity => leadIds.has(activity.entityId))
                .slice(0, 8);

            if (!relevantActivities.length) {
                container.innerHTML = '<div class="empty-state">Поки немає нових подій по воронці.</div>';
                return;
            }

            container.innerHTML = relevantActivities.map(activity => `
                <div class="timeline-entry">
                    <strong>${escapeHtml(activity.message)}</strong>
                    <span>${formatRelativeTime(activity.timestamp)}</span>
                </div>
            `).join('');
        }

        function renderProjects(searchTerm = '') {
            const container = document.getElementById('projectsTable');
            if (!container) {
                return;
            }

            projectSearchTerm = typeof searchTerm === 'string' ? searchTerm : '';
            const normalizedSearch = projectSearchTerm.trim().toLowerCase();

            const searchInput = document.getElementById('projectSearch');
            if (searchInput && searchInput.value !== projectSearchTerm) {
                searchInput.value = projectSearchTerm;
            }

            const stageSelect = document.getElementById('projectStageFilter');
            if (stageSelect && stageSelect.value !== projectStageFilter) {
                stageSelect.value = projectStageFilter;
            }

            const probabilityRange = document.getElementById('projectProbabilityRange');
            if (probabilityRange && Number(probabilityRange.value) !== projectMinProbability) {
                probabilityRange.value = projectMinProbability;
            }

            const probabilityLabel = document.getElementById('projectProbabilityValue');
            if (probabilityLabel) {
                probabilityLabel.textContent = `${projectMinProbability}%+`;
            }

            let projects = Array.isArray(crmData.projects) ? [...crmData.projects] : [];

            if (projectStageFilter !== 'all') {
                projects = projects.filter(project => project.stage === projectStageFilter);
            }

            projects = projects.filter(project => {
                const probability = Math.max(0, Math.min(100, Number(project.probability) || 0));
                return probability >= projectMinProbability;
            });

            if (normalizedSearch) {
                projects = projects.filter(project => {
                    const haystack = [
                        project.name,
                        project.company,
                        project.owner,
                        project.contact,
                        project.stage,
                        Array.isArray(project.tags) ? project.tags.join(' ') : '',
                        Array.isArray(project.team) ? project.team.join(' ') : '',
                        project.description
                    ];
                    return haystack
                        .filter(Boolean)
                        .some(value => value.toLowerCase().includes(normalizedSearch));
                });
            }

            projects.sort((a, b) => {
                const dateA = new Date(a.updatedAt || a.createdAt || 0).getTime();
                const dateB = new Date(b.updatedAt || b.createdAt || 0).getTime();
                return dateB - dateA;
            });

            renderProjectMetrics(projects);
            renderProjectStageBreakdown(projects);
            renderProjectRiskList(projects);
            renderProjectTeamLoad(projects);
            renderProjectUpdates(projects);

            if (!projects.length) {
                container.innerHTML = '<div class="empty-state" style="padding: 32px;">Проекти за вказаними фільтрами не знайдені.</div>';
                return;
            }

            container.innerHTML = projects.map(project => {
                const probability = Math.max(0, Math.min(100, Math.round(Number(project.probability) || 0)));
                const probabilityClass = getProbabilityClass(probability);
                const stageBadgeClass = getProjectStageBadgeClass(project.stage);
                const updatedLabel = project.updatedAt
                    ? `Оновлено ${formatRelativeTime(project.updatedAt)}`
                    : 'Оновлено щойно';
                const tags = project.tags && project.tags.length
                    ? `<div class="project-tags">${project.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}</div>`
                    : '';
                const description = project.description
                    ? `<div class="metric-sub">${escapeHtml(project.description)}</div>`
                    : '';
                const attachmentsCount = Array.isArray(project.attachments) ? project.attachments.length : 0;
                const notesCount = Array.isArray(project.notes) ? project.notes.length : 0;
                const indicatorParts = [];
                if (attachmentsCount) {
                    indicatorParts.push(`<span class="chip"><i class="fa-solid fa-paperclip"></i> ${attachmentsCount}</span>`);
                }
                if (notesCount) {
                    indicatorParts.push(`<span class="chip"><i class="fa-solid fa-note-sticky"></i> ${notesCount}</span>`);
                }
                const indicatorMarkup = indicatorParts.length ? `<div class="chips">${indicatorParts.join('')}</div>` : '';
                const teamContent = project.team && project.team.length
                    ? `<div class="project-team">${project.team.map(member => `<span class="project-member-chip">${escapeHtml(member)}</span>`).join('')}</div>`
                    : '<span class="metric-sub">Не призначено</span>';
                const ownerName = project.owner && project.owner.trim().length ? project.owner.trim() : 'Не призначено';
                const ownerInitial = ownerName === 'Не призначено' ? '—' : ownerName.charAt(0);
                const contactName = project.contact && project.contact.trim().length ? project.contact.trim() : 'Без контакту';

                return `
                    <div class="table-row" data-project-id="${project.id}">
                        <div class="project-main">
                            <strong>${escapeHtml(project.name)}</strong>
                            ${project.company ? `<div class="project-sub">${escapeHtml(project.company)}</div>` : ''}
                            ${description}
                            <div class="project-updated">${escapeHtml(updatedLabel)}</div>
                            ${tags}
                            ${indicatorMarkup}
                        </div>
                        <div>${teamContent}</div>
                        <div><strong>${formatCurrency(project.budget)}</strong></div>
                        <div><span class="badge ${stageBadgeClass}">${escapeHtml(project.stage)}</span></div>
                        <div>
                            <div class="probability-pill ${probabilityClass}" style="--fill:${probability}%" data-value="${probability}">
                                <span>${probability}%</span>
                            </div>
                        </div>
                        <div>
                            <div class="project-owner">
                                <div class="avatar avatar-sm">${escapeHtml(ownerInitial)}</div>
                                <div>
                                    <strong>${escapeHtml(ownerName)}</strong>
                                    <span>${escapeHtml(contactName)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderProjectMetrics(projects) {
            const container = document.getElementById('projectMetrics');
            if (!container) {
                return;
            }

            if (!projects.length) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">Немає проектів для аналітики.</div>';
                return;
            }

            let totalBudget = 0;
            let probabilitySum = 0;
            let activeProjects = 0;
            let recentUpdates = 0;
            let highProbability = 0;
            let totalTeamMembers = 0;
            const uniqueContributors = new Set();
            const now = new Date();

            projects.forEach(project => {
                const budget = Number(project.budget) || 0;
                const probability = Math.max(0, Math.min(100, Number(project.probability) || 0));
                totalBudget += budget;
                probabilitySum += probability;

                if (probability >= 70) {
                    highProbability += 1;
                }

                const stageNormalized = (project.stage || '').toLowerCase();
                if (!stageNormalized.includes('архів') && !stageNormalized.includes('заверш') && !stageNormalized.includes('підтрим')) {
                    activeProjects += 1;
                }

                const updatedAt = project.updatedAt ? new Date(project.updatedAt) : null;
                if (updatedAt && !Number.isNaN(updatedAt.getTime())) {
                    const diffDays = Math.round((now.getTime() - updatedAt.getTime()) / (1000 * 60 * 60 * 24));
                    if (diffDays <= 7) {
                        recentUpdates += 1;
                    }
                }

                const memberSet = new Set();
                const owner = typeof project.owner === 'string' ? project.owner.trim() : '';
                if (owner) {
                    memberSet.add(owner);
                    uniqueContributors.add(owner);
                }
                if (Array.isArray(project.team)) {
                    project.team.forEach(member => {
                        const normalized = typeof member === 'string' ? member.trim() : String(member || '').trim();
                        if (normalized) {
                            memberSet.add(normalized);
                            uniqueContributors.add(normalized);
                        }
                    });
                }
                totalTeamMembers += memberSet.size;
            });

            const averageProbability = projects.length ? Math.round(probabilitySum / projects.length) : 0;
            const averageBudget = projects.length ? totalBudget / projects.length : 0;
            const avgTeamSize = projects.length ? totalTeamMembers / projects.length : 0;
            const avgTeamFormatted = avgTeamSize
                ? new Intl.NumberFormat('uk-UA', { maximumFractionDigits: 1, minimumFractionDigits: 1 }).format(avgTeamSize)
                : '0,0';

            container.innerHTML = `
                <div class="metric-card">
                    <div class="metric-icon"><i class="fa-solid fa-briefcase"></i></div>
                    <div>
                        <div class="metric-label">Проекти в роботі</div>
                        <div class="metric-value">${formatIntegerDisplay(activeProjects)}</div>
                        <div class="metric-sub">Оновлено за 7 днів: ${formatIntegerDisplay(recentUpdates)}</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon"><i class="fa-solid fa-sack-dollar"></i></div>
                    <div>
                        <div class="metric-label">Портфель, ₴</div>
                        <div class="metric-value">${formatCurrency(totalBudget)}</div>
                        <div class="metric-sub">Середній бюджет: ${formatCurrency(averageBudget)}</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon"><i class="fa-solid fa-bullseye"></i></div>
                    <div>
                        <div class="metric-label">Середня ймовірність</div>
                        <div class="metric-value">${averageProbability}%</div>
                        <div class="metric-sub">≥70% шансів: ${formatIntegerDisplay(highProbability)}</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon"><i class="fa-solid fa-users"></i></div>
                    <div>
                        <div class="metric-label">Учасники команд</div>
                        <div class="metric-value">${formatIntegerDisplay(uniqueContributors.size)}</div>
                        <div class="metric-sub">Середній склад: ${avgTeamFormatted} ос.</div>
                    </div>
                </div>
            `;
        }

        function renderProjectStageBreakdown(projects) {
            const container = document.getElementById('projectStageBreakdown');
            if (!container) {
                return;
            }

            if (!projects.length) {
                container.innerHTML = '<div class="empty-state">Немає проектів для відображення.</div>';
                return;
            }

            const stageMap = new Map();
            projects.forEach(project => {
                const stageLabel = project.stage && project.stage.trim().length ? project.stage.trim() : 'Без етапу';
                if (!stageMap.has(stageLabel)) {
                    stageMap.set(stageLabel, { count: 0, budget: 0, probabilitySum: 0 });
                }
                const stats = stageMap.get(stageLabel);
                stats.count += 1;
                stats.budget += Number(project.budget) || 0;
                stats.probabilitySum += Number(project.probability) || 0;
            });

            const total = projects.length;
            const stageEntries = Array.from(stageMap.entries()).sort((a, b) => b[1].count - a[1].count);

            container.innerHTML = stageEntries.map(([stageLabel, stats]) => {
                const share = Math.round((stats.count / total) * 100);
                const avgProbability = stats.count ? Math.round(stats.probabilitySum / stats.count) : 0;
                const progressWidth = share <= 0 ? 0 : Math.max(8, Math.min(share, 100));
                return `
                    <div class="project-stage-row">
                        <div class="project-stage-info">
                            <strong>${escapeHtml(stageLabel)}</strong>
                            <span class="metric-sub">${formatIntegerDisplay(stats.count)} проєктів • ${formatCurrency(stats.budget, true)}</span>
                        </div>
                        <div class="project-stage-progress">
                            <div class="project-stage-track"><span class="project-stage-fill" style="width:${progressWidth}%"></span></div>
                            <span class="metric-sub">${share}%</span>
                        </div>
                        <span class="project-stage-chip">Сер. ймовірність ${avgProbability}%</span>
                    </div>
                `;
            }).join('');
        }

        function renderProjectRiskList(projects) {
            const container = document.getElementById('projectRiskList');
            if (!container) {
                return;
            }

            if (!projects.length) {
                container.innerHTML = '<div class="empty-state">Немає ризикових проектів за поточними фільтрами.</div>';
                return;
            }

            const risks = projects.map(project => {
                const probability = Math.max(0, Math.min(100, Number(project.probability) || 0));
                const updatedAt = project.updatedAt ? new Date(project.updatedAt) : null;
                const daysWithoutUpdate = updatedAt && !Number.isNaN(updatedAt.getTime())
                    ? Math.max(0, Math.round((Date.now() - updatedAt.getTime()) / (1000 * 60 * 60 * 24)))
                    : null;

                const memberSet = new Set();
                const owner = typeof project.owner === 'string' ? project.owner.trim() : '';
                if (owner) {
                    memberSet.add(owner);
                }
                if (Array.isArray(project.team)) {
                    project.team.forEach(member => {
                        const normalized = typeof member === 'string' ? member.trim() : String(member || '').trim();
                        if (normalized) {
                            memberSet.add(normalized);
                        }
                    });
                }

                const flags = [];
                if (probability < 40) {
                    flags.push({ label: 'Низька ймовірність', level: 'critical' });
                }
                if (daysWithoutUpdate !== null && daysWithoutUpdate > 10) {
                    flags.push({
                        label: `Без оновлень ${daysWithoutUpdate} дн.`,
                        level: daysWithoutUpdate > 20 ? 'critical' : 'warning'
                    });
                }
                if (memberSet.size <= 1) {
                    flags.push({ label: 'Немає команди', level: 'warning' });
                }

                const severity = flags.reduce((score, flag) => score + (flag.level === 'critical' ? 2 : 1), 0);

                return {
                    project,
                    probability,
                    flags,
                    severity,
                    updatedAt
                };
            }).filter(item => item.flags.length > 0);

            if (!risks.length) {
                container.innerHTML = '<div class="empty-state">Активні проекти виглядають стабільно.</div>';
                return;
            }

            risks.sort((a, b) => {
                if (b.severity !== a.severity) {
                    return b.severity - a.severity;
                }
                if (a.probability !== b.probability) {
                    return a.probability - b.probability;
                }
                const timeA = a.updatedAt ? a.updatedAt.getTime() : 0;
                const timeB = b.updatedAt ? b.updatedAt.getTime() : 0;
                return timeA - timeB;
            });

            const topRisks = risks.slice(0, 4);

            container.innerHTML = topRisks.map(item => {
                const { project, probability, flags, severity } = item;
                const ownerName = project.owner && project.owner.trim().length ? project.owner.trim() : 'Без менеджера';
                const company = project.company && project.company.trim().length ? project.company.trim() : 'Без компанії';
                const updateLabel = project.updatedAt
                    ? (formatRelativeTime(project.updatedAt) || formatDate(project.updatedAt))
                    : 'Немає даних';
                const itemClass = severity >= 4 ? 'critical' : 'warning';

                const flagsMarkup = flags.map(flag => {
                    const classes = ['project-risk-flag'];
                    if (flag.level === 'critical') {
                        classes.push('is-critical');
                    }
                    if (flag.level === 'warning') {
                        classes.push('is-warning');
                    }
                    return `<span class="${classes.join(' ')}">${escapeHtml(flag.label)}</span>`;
                }).join('');

                return `
                    <div class="project-risk-item ${itemClass}">
                        <div class="project-risk-head">
                            <div>
                                <strong>${escapeHtml(project.name)}</strong>
                                <div class="metric-sub">${escapeHtml(company)}</div>
                            </div>
                            <span class="project-risk-score">${probability}%</span>
                        </div>
                        <div class="project-risk-flags">${flagsMarkup}</div>
                        <div class="project-risk-meta">
                            <span><i class="fa-regular fa-user"></i>${escapeHtml(ownerName)}</span>
                            <span><i class="fa-regular fa-clock"></i>${escapeHtml(updateLabel)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderProjectTeamLoad(projects) {
            const container = document.getElementById('projectTeamLoad');
            if (!container) {
                return;
            }

            if (!projects.length) {
                container.innerHTML = '<div class="empty-state">Немає призначень за поточними умовами.</div>';
                return;
            }

            const memberMap = new Map();

            projects.forEach(project => {
                const members = new Set();
                const owner = typeof project.owner === 'string' ? project.owner.trim() : '';
                if (owner) {
                    members.add(owner);
                }
                if (Array.isArray(project.team)) {
                    project.team.forEach(member => {
                        const normalized = typeof member === 'string' ? member.trim() : String(member || '').trim();
                        if (normalized) {
                            members.add(normalized);
                        }
                    });
                }

                members.forEach(member => {
                    if (!memberMap.has(member)) {
                        memberMap.set(member, {
                            name: member,
                            projects: 0,
                            budget: 0,
                            probabilitySum: 0
                        });
                    }
                    const entry = memberMap.get(member);
                    entry.projects += 1;
                    entry.budget += Number(project.budget) || 0;
                    entry.probabilitySum += Number(project.probability) || 0;
                });
            });

            const entries = Array.from(memberMap.values());
            if (!entries.length) {
                container.innerHTML = '<div class="empty-state">Немає учасників для відображення.</div>';
                return;
            }

            const maxProjects = entries.reduce((max, entry) => Math.max(max, entry.projects), 0) || 1;

            entries.forEach(entry => {
                entry.avgProbability = entry.projects ? Math.round(entry.probabilitySum / entry.projects) : 0;
            });

            entries.sort((a, b) => {
                if (b.projects !== a.projects) {
                    return b.projects - a.projects;
                }
                return b.budget - a.budget;
            });

            const rows = entries.slice(0, 5).map(entry => {
                const workloadPercent = Math.round((entry.projects / maxProjects) * 100);
                const fillWidth = entry.projects ? Math.max(12, Math.min(100, workloadPercent)) : 0;
                const initials = entry.name ? entry.name.charAt(0).toUpperCase() : '?';
                return `
                    <div class="project-team-row">
                        <div class="avatar avatar-sm">${escapeHtml(initials)}</div>
                        <div class="project-team-info">
                            <strong>${escapeHtml(entry.name)}</strong>
                            <span class="metric-sub">${formatIntegerDisplay(entry.projects)} проєктів • ${formatCurrency(entry.budget, true)}</span>
                        </div>
                        <div class="project-team-progress">
                            <div class="project-team-progress-track"><span class="project-team-progress-fill" style="width:${fillWidth}%"></span></div>
                            <span class="metric-sub">Сер. ймовірність ${entry.avgProbability}%</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = rows;
        }

        function renderProjectUpdates(projects) {
            const container = document.getElementById('projectUpdates');
            const counter = document.getElementById('projectUpdatesCount');
            if (!container) {
                if (counter) {
                    counter.textContent = '0 записів';
                }
                return;
            }

            if (!projects.length) {
                container.innerHTML = '<div class="empty-state">Додайте проект або зніміть фільтри, щоб бачити оновлення.</div>';
                if (counter) {
                    counter.textContent = '0 записів';
                }
                return;
            }

            const updates = [];

            projects.forEach(project => {
                const notes = Array.isArray(project.notes) ? project.notes : [];
                if (notes.length) {
                    notes.forEach(note => {
                        const author = typeof note.author === 'string' && note.author.trim().length
                            ? note.author.trim()
                            : (project.owner || 'CRM');
                        updates.push({
                            projectName: project.name,
                            company: project.company,
                            text: note.text,
                            author,
                            date: note.date || project.updatedAt || project.createdAt
                        });
                    });
                } else if (project.updatedAt) {
                    updates.push({
                        projectName: project.name,
                        company: project.company,
                        text: 'Статус проекту оновлено.',
                        author: project.owner || 'CRM',
                        date: project.updatedAt
                    });
                }
            });

            updates.sort((a, b) => {
                const timeA = new Date(a.date || 0).getTime();
                const timeB = new Date(b.date || 0).getTime();
                return timeB - timeA;
            });

            const topUpdates = updates.slice(0, 6);

            if (!topUpdates.length) {
                container.innerHTML = '<div class="empty-state">Немає активності по проектах.</div>';
                if (counter) {
                    counter.textContent = '0 записів';
                }
                return;
            }

            container.innerHTML = topUpdates.map(update => {
                const projectName = typeof update.projectName === 'string' ? update.projectName : 'Проект';
                const company = typeof update.company === 'string' && update.company.trim().length ? update.company.trim() : '';
                const companyMarkup = company ? `<div class="metric-sub">${escapeHtml(company)}</div>` : '';
                const description = typeof update.text === 'string' && update.text.trim().length
                    ? escapeHtml(update.text.trim())
                    : 'Без опису';
                const author = typeof update.author === 'string' && update.author.trim().length ? update.author.trim() : 'CRM';
                const relative = update.date ? formatRelativeTime(update.date) : '';
                const absolute = update.date ? formatDate(update.date) : '';
                const timeLabel = relative || absolute || '—';

                return `
                    <div class="project-update-item">
                        <div class="project-update-bullet" aria-hidden="true"></div>
                        <div class="project-update-body">
                            <div>
                                <strong>${escapeHtml(projectName)}</strong>
                                ${companyMarkup}
                            </div>
                            <p>${description}</p>
                            <div class="project-update-footer">
                                <span><i class="fa-regular fa-user"></i>${escapeHtml(author)}</span>
                                <span><i class="fa-regular fa-clock"></i>${escapeHtml(timeLabel)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (counter) {
                counter.textContent = `${formatIntegerDisplay(updates.length)} записів`;
            }
        }

        function getProjectStageBadgeClass(stage) {
            const normalized = (stage || '').toLowerCase();
            if (normalized.includes('запуск') || normalized.includes('підтрим')) {
                return 'badge-success';
            }
            if (normalized.includes('тест')) {
                return 'badge-info';
            }
            if (normalized.includes('розроб') || normalized.includes('в роботі')) {
                return 'badge-primary';
            }
            if (normalized.includes('план')) {
                return 'badge-neutral';
            }
            if (normalized.includes('discovery') || normalized.includes('ініціа')) {
                return 'badge-warning';
            }
            return 'badge-neutral';
        }

        function getProbabilityClass(probability) {
            if (probability >= 70) {
                return 'is-high';
            }
            if (probability < 40) {
                return 'is-low';
            }
            return '';
        }

        function focusProject(projectId) {
            if (!projectId) {
                return;
            }

            const navButton = document.querySelector(`.nav-item[data-section-target="projectsSection"]`);
            if (navButton) {
                navButton.click();
            } else {
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                const targetSection = document.getElementById('projectsSection');
                if (targetSection) {
                    targetSection.classList.add('active');
                }
            }

            requestAnimationFrame(() => {
                const row = document.querySelector(`[data-project-id="${projectId}"]`);
                if (!row) {
                    return;
                }
                document.querySelectorAll('[data-project-id]').forEach(item => item.classList.remove('row-highlight'));
                row.classList.add('row-highlight');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
        }

        function createDealCard(lead) {
            const tags = lead.tags && lead.tags.length ? lead.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : '';
            const contact = lead.contact?.person ? `<div class="metric-sub"><i class="fa-regular fa-user"></i> ${lead.contact.person}</div>` : '';
            const stageClass = lead.stage === 'Угода' ? 'badge-success' : lead.stage === 'Втрачено' ? 'badge-danger' : 'badge-warning';
            return `
                <div class="deal-card" draggable="true" data-lead-id="${lead.id}">
                    <div class="deal-card-top">
                        <span class="deal-stage ${stageClass}">${lead.stage}</span>
                        <span class="metric-sub">${formatRelativeTime(lead.updatedAt)}</span>
                    </div>
                    <div class="deal-title">${lead.name}</div>
                    <div class="metric-sub"><i class="fa-regular fa-building"></i> ${lead.company}</div>
                    ${contact}
                    <div class="deal-meta">
                        <span><i class="fa-solid fa-coins"></i> ${formatCurrency(lead.value)}</span>
                        <span><i class="fa-solid fa-bullseye"></i> ${lead.probability}%</span>
                    </div>
                    <div class="deal-footer">
                        <div class="avatar">${lead.owner.charAt(0)}</div>
                        <div class="deal-tags">${tags}</div>
                    </div>
                </div>
            `;
        }

        let draggedLeadId = null;

        function setupPipelineInteractions() {
            document.querySelectorAll('.deal-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('click', () => openLeadDetails(card.dataset.leadId));
            });

            document.querySelectorAll('[data-drop-zone]').forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(event) {
            draggedLeadId = event.currentTarget.dataset.leadId;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', draggedLeadId);
        }

        function handleDragEnd() {
            draggedLeadId = null;
            document.querySelectorAll('[data-drop-zone]').forEach(zone => zone.classList.remove('drop-active'));
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drop-active');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drop-active');
        }

        function handleDrop(event) {
            event.preventDefault();
            const stage = event.currentTarget.closest('.pipeline-column').dataset.stage;
            event.currentTarget.classList.remove('drop-active');
            const leadId = draggedLeadId || event.dataTransfer.getData('text/plain');
            if (leadId) {
                moveLeadToStage(leadId, stage);
            }
            draggedLeadId = null;
        }
        function renderContacts(searchTerm = '') {
            const container = document.getElementById('contactsTable');
            const query = searchTerm.trim().toLowerCase();
            let contacts = crmData.contacts;

            if (contactStatusFilter !== 'all') {
                contacts = contacts.filter(contact => contact.status === contactStatusFilter);
            }

            if (query) {
                contacts = contacts.filter(contact => {
                    return [contact.name, contact.company, contact.email, contact.phone, contact.role]
                        .filter(Boolean)
                        .some(value => value.toLowerCase().includes(query));
                });
            }

            if (contacts.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 32px;">Немає контактів за обраними фільтрами.</div>';
                return;
            }

            container.innerHTML = contacts.map(contact => {
                const statusClass = `status-${contact.status}`;
                const tags = contact.tags && contact.tags.length ? contact.tags.map(tag => `<span class="chip">${tag}</span>`).join('') : '';
                const attachmentsCount = Array.isArray(contact.attachments) ? contact.attachments.length : 0;
                const notesCount = Array.isArray(contact.notes) ? contact.notes.length : 0;
                const extras = [];
                if (attachmentsCount) {
                    extras.push(`<span class="chip"><i class="fa-solid fa-paperclip"></i> ${attachmentsCount}</span>`);
                }
                if (notesCount) {
                    extras.push(`<span class="chip"><i class="fa-solid fa-note-sticky"></i> ${notesCount}</span>`);
                }
                const extrasMarkup = extras.length ? `<div class="chips" style="margin-top:6px;">${extras.join('')}</div>` : '';
                return `
                    <div class="table-row" data-contact-id="${contact.id}">
                        <div class="contact-main">
                            <div class="avatar">${contact.name.charAt(0)}</div>
                            <div class="contact-info">
                                <strong>${contact.name}</strong>
                                <span class="contact-sub">${contact.role || ''}</span>
                            </div>
                        </div>
                        <div>${contact.company || ''}</div>
                        <div>${contact.email || ''}</div>
                        <div>${contact.phone || ''}</div>
                        <div>
                            <span class="status-badge ${statusClass}">${STATUS_LABELS[contact.status] || contact.status}</span>
                            ${tags ? `<div class="chips" style="margin-top:6px;">${tags}</div>` : ''}
                            ${extrasMarkup}
                        </div>
                        <div>${contact.owner || ''}</div>
                    </div>
                `;
            }).join('');

            container.querySelectorAll('.table-row').forEach(row => {
                row.addEventListener('click', () => {
                    const contactId = row.dataset.contactId;
                    const contact = crmData.contacts.find(item => item.id === contactId);
                    if (contact && contact.company) {
                        const lead = crmData.leads.find(l => l.company === contact.company);
                        if (lead) {
                            openLeadDetails(lead.id);
                        }
                    }
                });
            });
        }

        function renderTasks() {
            const board = document.getElementById('taskBoard');
            board.innerHTML = TASK_COLUMNS.map(column => {
                const tasks = crmData.tasks.filter(task => task.status === column.id);
                return `
                    <div class="task-column" data-status="${column.id}">
                        <div class="task-column-header">
                            <h4>${column.title}</h4>
                            <span>${tasks.length}</span>
                        </div>
                        <div class="task-items">
                            ${tasks.length ? tasks.map(createTaskCard).join('') : '<div class="empty-state">Немає завдань</div>'}
                        </div>
                    </div>
                `;
            }).join('');

            setupTaskBoardInteractions();
        }

        function createTaskCard(task) {
            const lead = task.relatedLeadId ? crmData.leads.find(lead => lead.id === task.relatedLeadId) : null;
            const overdue = task.status !== 'done' && task.dueDate && new Date(task.dueDate) < new Date() && !isSameDay(new Date(task.dueDate), new Date());
            const priorityLabel = task.priority === 'high' ? 'Високий' : task.priority === 'medium' ? 'Середній' : 'Низький';
            const tags = Array.isArray(task.tags) ? task.tags.filter(Boolean) : [];
            const attachmentsCount = Array.isArray(task.attachments) ? task.attachments.length : 0;
            const extras = [];
            if (tags.length) {
                extras.push(`<div class="chips">${tags.map(tag => `<span class="chip">${escapeHtml(tag)}</span>`).join('')}</div>`);
            }
            if (attachmentsCount) {
                extras.push(`<div class="metric-sub"><i class="fa-solid fa-paperclip"></i> ${attachmentsCount}</div>`);
            }
            const extrasMarkup = extras.join('');
            return `
                <div class="task-card" data-task-id="${task.id}">
                    <div class="task-header">
                        <span class="priority priority-${task.priority}">${priorityLabel}</span>
                        <span class="metric-sub">${task.status === 'done' ? 'завершено ' + formatDate(task.completedAt || task.dueDate) : formatRelativeTime(task.dueDate)}</span>
                    </div>
                    <div class="task-title">${task.title}</div>
                    <div class="task-meta">
                        <span><i class="fa-regular fa-calendar"></i> ${formatDate(task.dueDate)}${overdue ? ' • прострочено' : ''}</span>
                        <span><i class="fa-regular fa-user"></i> ${task.owner}</span>
                    </div>
                    ${lead ? `<div class="metric-sub" data-open-lead="${lead.id}"><i class="fa-solid fa-link"></i> ${lead.name}</div>` : ''}
                    ${task.description ? `<div class="metric-sub">${task.description}</div>` : ''}
                    ${extrasMarkup}
                    <div class="task-actions">
                        ${task.status === 'inProgress' ? `<button class="btn-small-muted" data-task-action="back">Повернути</button>` : ''}
                        ${task.status === 'done' ? `<span class="badge badge-success">Виконано</span>` : `<button class="btn-small-primary" data-task-action="${task.status === 'todo' ? 'start' : 'done'}">${task.status === 'todo' ? 'Розпочати' : 'Завершити'}</button>`}
                    </div>
                </div>
            `;
        }

        function setupTaskBoardInteractions() {
            document.querySelectorAll('#taskBoard [data-task-action]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const taskId = btn.closest('.task-card').dataset.taskId;
                    const action = btn.dataset.taskAction;
                    if (action === 'start') {
                        updateTaskStatus(taskId, 'inProgress');
                    } else if (action === 'done') {
                        updateTaskStatus(taskId, 'done');
                    } else if (action === 'back') {
                        updateTaskStatus(taskId, 'todo');
                    }
                });
            });

            document.querySelectorAll('#taskBoard [data-open-lead]').forEach(link => {
                link.addEventListener('click', () => openLeadDetails(link.dataset.openLead));
            });
        }

        function renderAnalytics() {
            document.getElementById('insightUpdated').textContent = `Оновлено ${formatTime(new Date())}`;
            renderConversionInsights();
            renderTeamPerformance();
            renderLeadFocus();
            renderVelocityInsights();
        }

        function renderConversionInsights() {
            const container = document.getElementById('conversionInsights');
            const total = crmData.leads.length || 1;
            container.innerHTML = STAGES.map(stage => {
                const count = crmData.leads.filter(lead => lead.stage === stage).length;
                const percent = Math.round((count / total) * 100);
                return `
                    <div class="progress-item">
                        <div><strong>${stage}</strong><div class="metric-sub">${percent}% угод</div></div>
                        <div class="progress-track"><div class="progress-value" style="width:${percent || count ? Math.max(percent, 6) : 4}%"></div></div>
                    </div>
                `;
            }).join('');
        }

        function renderTeamPerformance() {
            const container = document.getElementById('teamPerformance');
            container.innerHTML = TEAM_MEMBERS.map(member => {
                const leads = crmData.leads.filter(lead => lead.owner === member && lead.stage !== 'Втрачено');
                const value = leads.reduce((sum, lead) => sum + lead.value, 0);
                const tasksTotal = crmData.tasks.filter(task => task.owner === member).length;
                const tasksDone = crmData.tasks.filter(task => task.owner === member && task.status === 'done').length;
                const completion = tasksTotal ? Math.round((tasksDone / tasksTotal) * 100) : 0;
                return `
                    <div class="progress-item">
                        <div>
                            <strong>${member}</strong>
                            <div class="metric-sub">${formatCurrency(value)} у воронці</div>
                        </div>
                        <div class="progress-track"><div class="progress-value" style="width:${completion || leads.length ? Math.max(completion, 6) : 4}%"></div></div>
                        <div class="metric-sub">${completion}% виконання задач</div>
                    </div>
                `;
            }).join('');
        }

        function renderLeadFocus() {
            const container = document.getElementById('leadFocus');
            const now = new Date();
            const focus = crmData.leads
                .filter(lead => !['Угода', 'Втрачено'].includes(lead.stage))
                .map(lead => {
                    const daysIdle = daysBetween(new Date(lead.updatedAt), now);
                    const tasks = crmData.tasks.filter(task => task.relatedLeadId === lead.id && task.status !== 'done');
                    const overdue = tasks.filter(task => task.dueDate && new Date(task.dueDate) < now && !isSameDay(new Date(task.dueDate), now)).length;
                    return { lead, daysIdle, overdue, tasks: tasks.length };
                })
                .filter(item => item.daysIdle > 7 || item.overdue > 0)
                .sort((a, b) => b.overdue - a.overdue || b.daysIdle - a.daysIdle)
                .slice(0, 4);

            if (focus.length === 0) {
                container.innerHTML = '<div class="empty-state">Немає угод, що потребують негайної уваги.</div>';
                return;
            }

            container.innerHTML = focus.map(item => `
                <div class="lead-focus-item">
                    <strong>${item.lead.name}</strong>
                    <div class="focus-meta">${item.lead.company} • не оновлювалась ${item.daysIdle} дн.</div>
                    <div class="focus-meta">Відкритих задач: ${item.tasks}${item.overdue ? ` • <span style="color:#b91c1c;">прострочено ${item.overdue}</span>` : ''}</div>
                    <button class="btn btn-small-primary" data-open-lead="${item.lead.id}">Перейти до угоди</button>
                </div>
            `).join('');

            container.querySelectorAll('[data-open-lead]').forEach(btn => {
                btn.addEventListener('click', () => openLeadDetails(btn.dataset.openLead));
            });
        }

        function renderVelocityInsights() {
            const container = document.getElementById('velocityInsights');
            const now = new Date();
            const won = crmData.leads.filter(lead => lead.status === 'won' && lead.closedAt);
            const avgWin = won.length ? Math.round(won.reduce((sum, lead) => sum + daysBetween(new Date(lead.createdAt), new Date(lead.closedAt)), 0) / won.length) : 0;
            const active = crmData.leads.filter(lead => !['Угода', 'Втрачено'].includes(lead.stage));
            const avgAge = active.length ? Math.round(active.reduce((sum, lead) => sum + daysBetween(new Date(lead.createdAt), now), 0) / active.length) : 0;
            const stale = active.filter(lead => daysBetween(new Date(lead.updatedAt), now) > 14);

            container.innerHTML = `
                <div class="highlight-card">
                    <div class="highlight-label">Середній час до перемоги</div>
                    <div class="highlight-value">${avgWin || '-'} дн.</div>
                </div>
                <div class="highlight-card">
                    <div class="highlight-label">Середній вік активних угод</div>
                    <div class="highlight-value">${avgAge || '-'} дн.</div>
                </div>
                <div class="metric-sub" style="margin-top:12px;">Без активності > 14 днів: ${stale.length}</div>
                ${stale.slice(0, 3).map(lead => `<div class="timeline-entry"><strong>${lead.name}</strong><span>${lead.company} • оновлено ${formatRelativeTime(lead.updatedAt)}</span></div>`).join('')}
            `;
        }
        function handleGlobalSearch(value) {
            const results = document.getElementById('searchResults');
            const query = value.trim().toLowerCase();
            if (!query) {
                hideSearchResults();
                return;
            }

            const projectMatches = crmData.projects.filter(project => {
                return [
                    project.name,
                    project.company,
                    project.owner,
                    project.contact,
                    ...(Array.isArray(project.tags) ? project.tags : [])
                ]
                    .filter(Boolean)
                    .some(field => field.toLowerCase().includes(query));
            }).slice(0, 4);

            const leadMatches = crmData.leads.filter(lead => {
                return [lead.name, lead.company, lead.contact?.person]
                    .filter(Boolean)
                    .some(field => field.toLowerCase().includes(query));
            }).slice(0, 4);

            const contactMatches = crmData.contacts.filter(contact => {
                return [contact.name, contact.company, contact.email]
                    .filter(Boolean)
                    .some(field => field.toLowerCase().includes(query));
            }).slice(0, 4);

            const taskMatches = crmData.tasks.filter(task => task.title.toLowerCase().includes(query)).slice(0, 3);

            if (!projectMatches.length && !leadMatches.length && !contactMatches.length && !taskMatches.length) {
                results.innerHTML = '<div class="search-empty">Нічого не знайдено</div>';
                results.classList.add('active');
                return;
            }

            results.innerHTML = `
                ${projectMatches.length ? `
                    <div class="search-group">
                        <div class="search-group-title">Проекти</div>
                        ${projectMatches.map(project => `<div class="search-result" data-result-project="${project.id}"><span>${project.name}</span><span class="metric-sub">${project.company || ''}</span></div>`).join('')}
                    </div>` : ''}
                ${leadMatches.length ? `
                    <div class="search-group">
                        <div class="search-group-title">Угоди</div>
                        ${leadMatches.map(lead => `<div class="search-result" data-result-lead="${lead.id}"><span>${lead.name}</span><span class="metric-sub">${lead.company}</span></div>`).join('')}
                    </div>` : ''}
                ${contactMatches.length ? `
                    <div class="search-group">
                        <div class="search-group-title">Контакти</div>
                        ${contactMatches.map(contact => `<div class="search-result" data-result-contact="${contact.id}"><span>${contact.name}</span><span class="metric-sub">${contact.company || ''}</span></div>`).join('')}
                    </div>` : ''}
                ${taskMatches.length ? `
                    <div class="search-group">
                        <div class="search-group-title">Завдання</div>
                        ${taskMatches.map(task => `<div class="search-result" data-result-task="${task.id}"><span>${task.title}</span><span class="metric-sub">${formatDate(task.dueDate)}</span></div>`).join('')}
                    </div>` : ''}
            `;

            results.classList.add('active');

            results.querySelectorAll('[data-result-project]').forEach(item => {
                item.addEventListener('click', () => {
                    focusProject(item.dataset.resultProject);
                    hideSearchResults();
                });
            });

            results.querySelectorAll('[data-result-lead]').forEach(item => {
                item.addEventListener('click', () => {
                    openLeadDetails(item.dataset.resultLead);
                    hideSearchResults();
                });
            });

            results.querySelectorAll('[data-result-contact]').forEach(item => {
                item.addEventListener('click', () => {
                    const contact = crmData.contacts.find(c => c.id === item.dataset.resultContact);
                    if (contact) {
                        const relatedLead = crmData.leads.find(lead => lead.company === contact.company);
                        if (relatedLead) {
                            openLeadDetails(relatedLead.id);
                        }
                    }
                    hideSearchResults();
                });
            });

            results.querySelectorAll('[data-result-task]').forEach(item => {
                item.addEventListener('click', () => {
                    const task = crmData.tasks.find(t => t.id === item.dataset.resultTask);
                    if (task?.relatedLeadId) {
                        openLeadDetails(task.relatedLeadId);
                    }
                    hideSearchResults();
                });
            });
        }

        function hideSearchResults() {
            const results = document.getElementById('searchResults');
            results.classList.remove('active');
            results.innerHTML = '';
        }

        function getAttachmentIcon(type = '') {
            if (!type) return 'fa-file-lines';
            const normalized = type.toLowerCase();
            if (normalized.includes('pdf')) return 'fa-file-pdf';
            if (normalized.startsWith('image/')) return 'fa-image';
            if (normalized.startsWith('video/')) return 'fa-file-video';
            if (normalized.startsWith('audio/')) return 'fa-file-audio';
            if (normalized.includes('zip') || normalized.includes('compressed')) return 'fa-file-zipper';
            if (normalized.includes('sheet') || normalized.includes('excel')) return 'fa-file-excel';
            if (normalized.includes('presentation') || normalized.includes('powerpoint') || normalized.includes('ppt')) return 'fa-file-powerpoint';
            if (normalized.includes('word') || normalized.includes('document')) return 'fa-file-word';
            if (normalized.includes('text')) return 'fa-file-lines';
            return 'fa-file';
        }

        function getActivityIcon(type) {
            switch (type) {
                case 'stage':
                    return 'fa-solid fa-diagram-project';
                case 'note':
                    return 'fa-solid fa-pen-to-square';
                case 'task':
                    return 'fa-solid fa-square-check';
                case 'role':
                    return 'fa-solid fa-user-shield';
                case 'won':
                    return 'fa-solid fa-trophy';
                case 'lost':
                    return 'fa-solid fa-face-frown';
                default:
                    return 'fa-solid fa-circle-info';
            }
        }
        function openModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (!modal) {
                return;
            }

            modal.classList.remove('active');
            if (id === 'leadDetailsModal') {
                activeLeadId = null;
            }

            const areaKeys = MODAL_ATTACHMENT_AREAS[id];
            if (Array.isArray(areaKeys)) {
                areaKeys.forEach(resetAttachmentArea);
            }
        }

        function resetDemoData() {
            if (confirm('Скинути дані та повернути демо-набір?')) {
                crmData = upgradeDataStructure(deepClone(defaultData));
                activeLeadId = null;
                Object.values(MODAL_ATTACHMENT_AREAS).forEach(areaList => {
                    areaList.forEach(areaKey => resetAttachmentArea(areaKey));
                });
                activeFileSnapshotId = Array.isArray(crmData.fileLibrary) && crmData.fileLibrary.length
                    ? crmData.fileLibrary[0].id
                    : null;
                const snapshotSources = Array.isArray(crmData.fileSources) ? crmData.fileSources : [];
                const linkedSource = snapshotSources.find(source => source.snapshotId === activeFileSnapshotId) || null;
                activeFileSourceId = linkedSource ? linkedSource.id : null;
                pendingFileSourceId = null;
                fileSearchTerm = '';
                pipelineFilterOwner = 'all';
                contactStatusFilter = 'all';
                projectStageFilter = 'all';
                projectMinProbability = 0;
                projectSearchTerm = '';
                saveData();
                populateDropdowns();

                const pipelineFilter = document.getElementById('pipelineOwnerFilter');
                if (pipelineFilter) {
                    pipelineFilter.value = pipelineFilterOwner;
                }

                const contactSearchInput = document.getElementById('contactSearch');
                if (contactSearchInput) {
                    contactSearchInput.value = '';
                }

                const contactStatusSelect = document.getElementById('contactStatusFilter');
                if (contactStatusSelect) {
                    contactStatusSelect.value = contactStatusFilter;
                }

                const globalSearchInput = document.getElementById('globalSearch');
                if (globalSearchInput) {
                    globalSearchInput.value = '';
                }
                hideSearchResults();

                const navSearchInput = document.getElementById('navSearch');
                if (navSearchInput) {
                    navSearchInput.value = '';
                }

                const navFilterSelect = document.getElementById('navFilter');
                if (navFilterSelect) {
                    navFilterSelect.value = 'all';
                }

                navigationState.search = '';
                navigationState.filter = 'all';
                applyNavigationFilters();

                const projectSearchInput = document.getElementById('projectSearch');
                if (projectSearchInput) {
                    projectSearchInput.value = '';
                }

                const projectStageSelect = document.getElementById('projectStageFilter');
                if (projectStageSelect) {
                    projectStageSelect.value = 'all';
                }

                const projectProbabilityRange = document.getElementById('projectProbabilityRange');
                if (projectProbabilityRange) {
                    projectProbabilityRange.value = 0;
                }

                const projectProbabilityValue = document.getElementById('projectProbabilityValue');
                if (projectProbabilityValue) {
                    projectProbabilityValue.textContent = '0%+';
                }

                renderAll();
                updateFileSnapshotsSelect();
                renderFileSources();
            }
        }

        async function handleLeadSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton ? submitButton.textContent : '';

            try {
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Збереження...';
                }

                const attachments = await prepareAttachmentsForArea('lead');
                const now = new Date().toISOString();
                const lead = {
                    id: generateId('lead'),
                    name: document.getElementById('leadTitle').value.trim(),
                    company: document.getElementById('leadCompany').value.trim(),
                    stage: document.getElementById('leadStage').value,
                    value: Number(document.getElementById('leadValue').value) || 0,
                    probability: Number(document.getElementById('leadProbability').value) || 0,
                    owner: document.getElementById('leadOwner').value,
                    status: 'active',
                    expectedClose: document.getElementById('leadStage').value === 'Угода' ? now.split('T')[0] : '',
                    contact: {
                        id: generateId('contact'),
                        person: document.getElementById('leadContactName').value.trim(),
                        email: document.getElementById('leadContactEmail').value.trim(),
                        phone: document.getElementById('leadContactPhone').value.trim()
                    },
                    tags: document.getElementById('leadTags').value.split(',').map(tag => tag.trim()).filter(Boolean),
                    createdAt: now,
                    updatedAt: now,
                    notes: [],
                    timeline: [],
                    attachments
                };

                if (lead.stage === 'Угода') {
                    lead.status = 'won';
                    lead.closedAt = now;
                    lead.probability = 100;
                }

                const initialNote = document.getElementById('leadNotes').value.trim();
                if (initialNote) {
                    lead.notes.push({ id: generateId('note'), text: initialNote, author: 'Ви', date: now });
                }

                addTimelineEntry(lead, `Створено лід ${lead.name}`);
                addTimelineEntry(lead, `Стадія встановлена: ${lead.stage}`);

                if (attachments.length) {
                    const preview = attachments.slice(0, 3).map(file => (file.name || '').replace(/[<>]/g, '')).join(', ');
                    addTimelineEntry(lead, `Додано файли: ${preview}${attachments.length > 3 ? '…' : ''}`);
                }

                crmData.leads.unshift(lead);

                if (lead.contact.person || lead.contact.email) {
                    const existingContact = crmData.contacts.find(contact => contact.email && contact.email === lead.contact.email);
                    if (!existingContact) {
                        crmData.contacts.unshift({
                            id: lead.contact.id,
                            name: lead.contact.person || lead.name,
                            company: lead.company,
                            role: '',
                            email: lead.contact.email,
                            phone: lead.contact.phone,
                            status: 'potential',
                            owner: lead.owner,
                            tags: lead.tags,
                            lastActivity: now
                        });
                    }
                }

                logActivity(`Додано нову угоду ${lead.name} для ${lead.company}.`, 'stage', lead.id);
                if (attachments.length) {
                    logActivity(`Додано ${attachments.length} файл(и) до ${lead.name}.`, 'note', lead.id);
                }

                saveData();
                updateTaskLeadOptions();
                renderAll();
                form.reset();
                resetAttachmentArea('lead');
                closeModal('addLeadModal');
            } catch (error) {
                console.error('Не вдалося створити лід', error);
                alert('Не вдалося зберегти лід. Будь ласка, спробуйте ще раз.');
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            }
        }

        async function handleProjectSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton ? submitButton.textContent : '';

            try {
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Збереження...';
                }

                const now = new Date().toISOString();
                const attachments = await prepareAttachmentsForArea('project');
                const teamSelect = document.getElementById('projectTeam');
                const selectedTeam = teamSelect
                    ? Array.from(teamSelect.selectedOptions).map(option => option.value).filter(Boolean)
                    : [];
                const tags = document.getElementById('projectTags').value
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(Boolean);
                const notes = document.getElementById('projectNotes').value
                    .split('\n')
                    .map(note => note.trim())
                    .filter(Boolean)
                    .map(text => ({ id: generateId('pnote'), text, author: CURRENT_USER.name, date: now }));

                const project = {
                    id: generateId('project'),
                    name: document.getElementById('projectName').value.trim(),
                    company: document.getElementById('projectCompany').value.trim(),
                    stage: document.getElementById('projectStage').value,
                    budget: Number(document.getElementById('projectBudget').value) || 0,
                    probability: Math.max(0, Math.min(100, Number(document.getElementById('projectProbability').value) || 0)),
                    owner: document.getElementById('projectOwner').value,
                    contact: document.getElementById('projectContact').value.trim(),
                    team: selectedTeam,
                    tags,
                    description: document.getElementById('projectSummary').value.trim(),
                    notes,
                    attachments,
                    createdAt: now,
                    updatedAt: now
                };

                crmData.projects.unshift(project);
                saveData();

                if (projectStageFilter !== 'all' && project.stage !== projectStageFilter) {
                    projectStageFilter = 'all';
                }

                if (projectMinProbability > project.probability) {
                    projectMinProbability = 0;
                }

                if (projectSearchTerm) {
                    projectSearchTerm = '';
                }

                renderProjects(projectSearchTerm);
                closeModal('addProjectModal');
                form.reset();
                resetAttachmentArea('project');
                if (teamSelect) {
                    Array.from(teamSelect.options).forEach(option => {
                        option.selected = false;
                    });
                }

                focusProject(project.id);
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            }
        }

        async function handleContactSubmit(event) {
            event.preventDefault();
            const now = new Date().toISOString();
            const attachments = await prepareAttachmentsForArea('contact');
            const noteText = document.getElementById('contactNotes').value.trim();
            const contact = {
                id: generateId('contact'),
                name: document.getElementById('contactName').value.trim(),
                company: document.getElementById('contactCompany').value.trim(),
                role: document.getElementById('contactRole').value.trim(),
                email: document.getElementById('contactEmail').value.trim(),
                phone: document.getElementById('contactPhone').value.trim(),
                status: document.getElementById('contactStatus').value,
                owner: document.getElementById('contactOwner').value,
                tags: document.getElementById('contactTags').value.split(',').map(tag => tag.trim()).filter(Boolean),
                attachments,
                notes: noteText ? [{ id: generateId('cnote'), text: noteText, author: CURRENT_USER.name, date: now }] : [],
                lastActivity: now
            };

            crmData.contacts.unshift(contact);
            logActivity(`Додано новий контакт ${contact.name}.`, 'note', contact.id);
            saveData();
            renderContacts(document.getElementById('contactSearch').value || '');
            closeModal('addContactModal');
            event.target.reset();
            resetAttachmentArea('contact');
        }

        function openTaskModal(leadId = '') {
            updateTaskLeadOptions();
            const select = document.getElementById('taskLead');
            select.value = leadId || '';
            document.getElementById('taskStatus').value = 'todo';
            document.getElementById('taskPriority').value = 'medium';
            const dateInput = document.getElementById('taskDueDate');
            if (!dateInput.value) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                dateInput.valueAsDate = tomorrow;
            }
            openModal('addTaskModal');
        }

        async function handleTaskSubmit(event) {
            event.preventDefault();
            const attachments = await prepareAttachmentsForArea('task');
            const task = {
                id: generateId('task'),
                title: document.getElementById('taskTitle').value.trim(),
                owner: document.getElementById('taskOwner').value,
                dueDate: document.getElementById('taskDueDate').value,
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                relatedLeadId: document.getElementById('taskLead').value,
                description: document.getElementById('taskDescription').value.trim(),
                tags: document.getElementById('taskTags').value.split(',').map(tag => tag.trim()).filter(Boolean),
                attachments
            };

            if (task.status === 'done') {
                task.completedAt = new Date().toISOString();
            }

            crmData.tasks.unshift(task);
            if (task.relatedLeadId) {
                const lead = crmData.leads.find(item => item.id === task.relatedLeadId);
                if (lead) {
                    addTimelineEntry(lead, `Додано завдання: ${task.title}`);
                }
            }
            logActivity(`Нове завдання: ${task.title}.`, 'task', task.id);
            saveData();
            renderTasks();
            renderUpcomingActivities();
            renderPipeline();
            renderLeadFocus();
            closeModal('addTaskModal');
            event.target.reset();
            resetAttachmentArea('task');
        }

        function updateTaskStatus(taskId, status) {
            const task = crmData.tasks.find(item => item.id === taskId);
            if (!task) return;
            task.status = status;
            if (status === 'done') {
                task.completedAt = new Date().toISOString();
            }
            saveData();
            renderTasks();
            renderDashboard();
            renderPipeline();
            renderLeadFocus();
        }

        function logActivity(message, type = 'note', entityId = null) {
            crmData.activities.unshift({
                id: generateId('act'),
                type,
                entityId,
                message,
                timestamp: new Date().toISOString()
            });
            crmData.activities = crmData.activities.slice(0, 40);

            const currentLeads = pipelineFilterOwner === 'all'
                ? crmData.leads
                : crmData.leads.filter(lead => lead.owner === pipelineFilterOwner);
            renderPipelineActivity(currentLeads);
        }

        function addTimelineEntry(lead, text) {
            lead.timeline.unshift({ id: generateId('tl'), text, date: new Date().toISOString() });
        }

        function moveLeadToStage(leadId, stage) {
            const lead = crmData.leads.find(item => item.id === leadId);
            if (!lead || lead.stage === stage) return;
            const previousStage = lead.stage;
            lead.stage = stage;
            lead.updatedAt = new Date().toISOString();
            if (stage === 'Угода') {
                lead.status = 'won';
                lead.closedAt = new Date().toISOString();
                lead.probability = 100;
            } else if (stage === 'Втрачено') {
                lead.status = 'lost';
                lead.probability = 0;
            } else {
                lead.status = 'active';
            }
            addTimelineEntry(lead, `Стадія змінена з ${previousStage} на ${stage}`);
            logActivity(`Лід ${lead.name} переміщено на етап ${stage}.`, 'stage', lead.id);
            saveData();
            renderPipeline();
            renderDashboard();
            renderAnalytics();
            if (activeLeadId === lead.id) {
                renderLeadDetails(lead.id);
            }
        }
        function openLeadDetails(leadId) {
            activeLeadId = leadId;
            renderLeadDetails(leadId);
            openModal('leadDetailsModal');
        }

        function renderLeadDetails(leadId) {
            const lead = crmData.leads.find(item => item.id === leadId);
            if (!lead) return;
            document.getElementById('leadDetailsTitle').textContent = lead.name;
            const content = document.getElementById('leadDetailsContent');
            const contact = lead.contact || {};
            const relatedTasks = crmData.tasks.filter(task => task.relatedLeadId === lead.id);
            const attachments = Array.isArray(lead.attachments) ? lead.attachments : [];
            const attachmentsMarkup = attachments.length ? `
                <div class="attachment-list">
                    ${attachments.map(file => {
                        const safeName = escapeHtml(file.name || 'Файл');
                        const downloadName = (file.name || 'file').replace(/["<>]/g, '');
                        const safeRelativePath = file.path && file.path !== file.name ? escapeHtml(file.path) : '';
                        const metaParts = [];
                        if (safeRelativePath) {
                            metaParts.push(safeRelativePath);
                        }
                        metaParts.push(formatBytes(Number(file.size) || 0));
                        const metaText = metaParts.filter(Boolean).join(' • ');
                        const hasData = typeof file.dataUrl === 'string' && file.dataUrl.startsWith('data:');
                        const icon = getAttachmentIcon(file.type);
                        const linkAttributes = hasData
                            ? `href="${file.dataUrl}" download="${downloadName}" target="_blank" rel="noopener"`
                            : 'href="#" onclick="return false;"';
                        return `
                            <a class="attachment-item" ${linkAttributes}>
                                <div class="attachment-icon"><i class="fa-solid ${icon}"></i></div>
                                <div class="attachment-details">
                                    <strong>${safeName}</strong>
                                    <div class="attachment-meta">${metaText}</div>
                                </div>
                                <i class="fa-solid fa-download"></i>
                            </a>
                        `;
                    }).join('')}
                </div>
            ` : '<span class="metric-sub">Файли ще не додані</span>';

            content.innerHTML = `
                <div class="lead-highlights">
                    <div class="highlight-card">
                        <div class="highlight-label">Вартість</div>
                        <div class="highlight-value">${formatCurrency(lead.value)}</div>
                        <div class="metric-sub">Ймовірність ${lead.probability}%</div>
                    </div>
                    <div class="highlight-card">
                        <div class="highlight-label">Стадія</div>
                        <div class="highlight-value">${lead.stage}</div>
                        <div class="metric-sub">Оновлено ${formatRelativeTime(lead.updatedAt)}</div>
                    </div>
                    <div class="highlight-card">
                        <div class="highlight-label">Менеджер</div>
                        <div class="highlight-value">${lead.owner}</div>
                        <div class="metric-sub">Створено ${formatDate(lead.createdAt)}</div>
                    </div>
                </div>

                <div class="lead-columns">
                    <div class="card">
                        <h3>Інформація про угоду</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Компанія</div>
                                <div class="info-value">${lead.company}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Контакт</div>
                                <div class="info-value">${contact.person || '—'}${contact.email ? `<br><span class="metric-sub">${contact.email}</span>` : ''}${contact.phone ? `<br><span class="metric-sub">${contact.phone}</span>` : ''}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Етап</div>
                                <select id="leadStageSelect" style="margin-top:6px;">
                                    ${STAGES.map(stage => `<option value="${stage}" ${stage === lead.stage ? 'selected' : ''}>${stage}</option>`).join('')}
                                </select>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Ймовірність</div>
                                <div class="probability-control">
                                    <input type="range" id="leadProbabilityRange" min="0" max="100" step="5" value="${lead.probability}">
                                    <span class="probability-value" id="leadProbabilityValue">${lead.probability}%</span>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Мітки</div>
                                <div class="chips">${lead.tags && lead.tags.length ? lead.tags.map(tag => `<span class="chip">${tag}</span>`).join('') : '—'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Вкладення</div>
                                <div class="info-value">${attachmentsMarkup}</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Примітки</h3>
                        <div class="notes-list" id="leadNotesList">
                            ${lead.notes && lead.notes.length ? lead.notes.map(note => `
                                <div class="note-item">
                                    <div>${note.text}</div>
                                    <div class="note-meta">${note.author || 'CRM'} • ${formatDate(note.date)}</div>
                                </div>
                            `).join('') : '<div class="empty-state">Ще немає приміток</div>'}
                        </div>
                        <form id="leadNoteForm" class="form-group full" style="margin-top:16px;">
                            <label for="leadNoteText">Додати примітку</label>
                            <textarea id="leadNoteText" required placeholder="Що зроблено? Які наступні кроки?"></textarea>
                            <div class="modal-actions" style="justify-content:flex-start;">
                                <button type="submit" class="btn btn-small-primary">Зберегти примітку</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="lead-columns">
                    <div class="card">
                        <div class="section-header" style="margin-bottom:12px;">
                            <div>
                                <h3>Завдання по угоді</h3>
                                <p>${relatedTasks.length} завдань</p>
                            </div>
                            <button class="btn btn-small-primary" id="addLeadTaskBtn"><i class="fa-solid fa-circle-plus"></i> Нове завдання</button>
                        </div>
                        <div class="task-items">
                            ${relatedTasks.length ? relatedTasks.map(task => `
                                <div class="task-card" data-task-id="${task.id}">
                                    <div class="task-header">
                                        <span class="priority priority-${task.priority}">${task.priority === 'high' ? 'Високий' : task.priority === 'medium' ? 'Середній' : 'Низький'}</span>
                                        <span class="metric-sub">${task.status === 'done' ? 'виконано' : task.status === 'inProgress' ? 'в роботі' : 'до виконання'}</span>
                                    </div>
                                    <div class="task-title">${task.title}</div>
                                    <div class="task-meta">
                                        <span><i class="fa-regular fa-calendar"></i> ${formatDate(task.dueDate)}</span>
                                        <span><i class="fa-regular fa-user"></i> ${task.owner}</span>
                                    </div>
                                </div>
                            `).join('') : '<div class="empty-state">Завдання ще не додані</div>'}
                        </div>
                    </div>
                    <div class="card">
                        <h3>Хронологія</h3>
                        <div class="timeline-list">
                            ${lead.timeline && lead.timeline.length ? lead.timeline.slice(0, 8).map(item => `
                                <div class="timeline-entry">
                                    <strong>${escapeHtml(item.text)}</strong>
                                    <span>${formatRelativeTime(item.date)}</span>
                                </div>
                            `).join('') : '<div class="empty-state">Історія поки порожня</div>'}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('leadStageSelect').addEventListener('change', event => {
                moveLeadToStage(lead.id, event.target.value);
            });

            const probabilityRange = document.getElementById('leadProbabilityRange');
            const probabilityValue = document.getElementById('leadProbabilityValue');
            probabilityRange.addEventListener('input', event => {
                probabilityValue.textContent = `${event.target.value}%`;
            });
            probabilityRange.addEventListener('change', event => {
                updateLeadProbability(lead.id, Number(event.target.value));
            });

            document.getElementById('leadNoteForm').addEventListener('submit', event => {
                event.preventDefault();
                const text = document.getElementById('leadNoteText').value.trim();
                if (!text) return;
                lead.notes.unshift({ id: generateId('note'), text, author: 'Ви', date: new Date().toISOString() });
                addTimelineEntry(lead, `Нова примітка: ${text.slice(0, 80)}`);
                logActivity(`Додано примітку до ${lead.name}.`, 'note', lead.id);
                saveData();
                renderLeadDetails(lead.id);
                renderActivityTimeline();
            });

            document.getElementById('addLeadTaskBtn').addEventListener('click', () => openTaskModal(lead.id));
        }

        function updateLeadProbability(leadId, probability) {
            const lead = crmData.leads.find(item => item.id === leadId);
            if (!lead) return;
            lead.probability = probability;
            lead.updatedAt = new Date().toISOString();
            addTimelineEntry(lead, `Ймовірність змінена на ${probability}%`);
            logActivity(`Оновлено прогноз для ${lead.name} (${probability}%).`, 'note', lead.id);
            saveData();
            renderPipeline();
            renderDashboard();
            renderForecastCard(
                crmData.leads.filter(l => l.stage !== 'Втрачено').reduce((sum, l) => sum + l.value, 0),
                crmData.leads.filter(l => l.stage !== 'Втрачено').reduce((sum, l) => sum + l.value * (l.probability / 100), 0)
            );
            renderAnalytics();
        }

        function escapeHtml(value) {
            if (typeof value !== 'string') {
                return '';
            }
            return value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatCurrency(value, compact = false) {
            if (!Number.isFinite(value)) return '0 ₴';
            return new Intl.NumberFormat('uk-UA', {
                style: 'currency',
                currency: 'UAH',
                maximumFractionDigits: 0,
                notation: compact ? 'compact' : 'standard'
            }).format(value);
        }

        function formatDate(dateInput, options = { day: '2-digit', month: 'short' }) {
            if (!dateInput) return '—';
            const date = new Date(dateInput);
            if (Number.isNaN(date.getTime())) return '—';
            return new Intl.DateTimeFormat('uk-UA', options).format(date);
        }

        function formatTime(dateInput) {
            const date = dateInput instanceof Date ? dateInput : new Date(dateInput);
            if (Number.isNaN(date.getTime())) return '';
            return new Intl.DateTimeFormat('uk-UA', { hour: '2-digit', minute: '2-digit' }).format(date);
        }

        function formatBytes(bytes) {
            const value = Number(bytes);
            if (!Number.isFinite(value) || value <= 0) {
                return '0 Б';
            }

            const units = ['Б', 'КБ', 'МБ', 'ГБ', 'ТБ'];
            let size = value;
            let index = 0;

            while (size >= 1024 && index < units.length - 1) {
                size /= 1024;
                index += 1;
            }

            const formatted = size >= 10 || index === 0 ? size.toFixed(0) : size.toFixed(1);
            return `${formatted} ${units[index]}`;
        }

        function formatIntegerDisplay(value) {
            const number = Number(value);
            if (!Number.isFinite(number) || number <= 0) {
                return '0';
            }
            return Math.round(number).toLocaleString('uk-UA');
        }

        function formatRelativeTime(dateInput) {
            if (!dateInput) return '';
            const date = new Date(dateInput);
            if (Number.isNaN(date.getTime())) return '';
            const now = new Date();
            const diffSeconds = Math.round((date.getTime() - now.getTime()) / 1000);
            const rtf = new Intl.RelativeTimeFormat('uk-UA', { numeric: 'auto' });
            const divisions = [
                { amount: 60, unit: 'second' },
                { amount: 60, unit: 'minute' },
                { amount: 24, unit: 'hour' },
                { amount: 7, unit: 'day' },
                { amount: 4.34524, unit: 'week' },
                { amount: 12, unit: 'month' },
                { amount: Number.POSITIVE_INFINITY, unit: 'year' }
            ];
            let duration = diffSeconds;
            for (const division of divisions) {
                if (Math.abs(duration) < division.amount) {
                    return rtf.format(Math.round(duration), division.unit);
                }
                duration /= division.amount;
            }
            return '';
        }

        function daysBetween(startDate, endDate = new Date()) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diff = end.getTime() - start.getTime();
            return Math.max(0, Math.round(diff / (1000 * 60 * 60 * 24)));
        }

        function isSameDay(dateA, dateB) {
            return dateA.getFullYear() === dateB.getFullYear() && dateA.getMonth() === dateB.getMonth() && dateA.getDate() === dateB.getDate();
        }

        function isDueToday(dateInput) {
            if (!dateInput) return false;
            const due = new Date(dateInput);
            const today = new Date();
            return isSameDay(due, today);
        }
    </script>
</body>
</html>
